<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fixed Deposit Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
  <div class="w-full h-full px-0 py-0">
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-full h-full border border-gray-200">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-blue-700">üîç Fixed Deposit Search</h1>
        <p class="text-gray-500 mt-2 text-sm">Search for customer details and create Fixed Deposit easily</p>
      </div>
      <!-- Search Section -->
      <div class="mb-8">
        <label for="accountNumber" class="block text-gray-700 font-semibold mb-2">Enter Customer ID:</label>
        <div class="flex shadow rounded-lg overflow-hidden">
          <input type="text" id="accountNumber" placeholder="e.g. KSTHST7705" 
                 class="flex-1 border border-gray-300 px-4 py-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
          <button onclick="searchCustomer()" 
                  class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 transition">
            Search
          </button>
        </div>
      </div>
      <!-- Tabs -->
      <div id="tabsContainer" class="hidden">
        <div class="flex border-b mb-4">
          <button id="tabDetailsBtn" class="tab-btn px-4 py-2 font-semibold text-blue-700 border-b-2 border-blue-600 bg-white focus:outline-none">FD Details</button>
          <button id="tabCreateBtn" class="tab-btn px-4 py-2 font-semibold text-gray-600 border-b-2 border-transparent bg-white focus:outline-none">Create FD</button>
        </div>
        <!-- FD Details Tab -->
        <div id="tabDetails" class="tab-content">
          <!-- Customer Details -->
          <div id="customerDetails" class="border-t pt-4 bg-blue-50 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-bold text-blue-700 mb-2">üë§ Customer Details</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-gray-700">
              <p><strong>Name:</strong> <span id="custName"></span></p>
              <p><strong>KGID:</strong> <span id="custKgid"></span></p>
              <p><strong>Aadhaar:</strong> <span id="custAadhaar"></span></p>
              <p><strong>PAN:</strong> <span id="custPan"></span></p>
              <p><strong>Customer ID:</strong> <span id="custAccount"></span></p>
            </div>
          </div>
          <!-- FD List Section -->
          <div id="fdListSection" class="bg-gray-50 rounded-lg p-4">
            <h2 class="text-lg font-bold text-blue-700 mb-2">üìã Fixed Deposits</h2>
            <div id="fdListContainer">
              <div class="text-gray-500 text-center">Loading...</div>
            </div>
          </div>
        </div>
        <!-- Create FD Tab -->
        <div id="tabCreate" class="tab-content hidden">
          <!-- FD Form (Create FD Tab) -->
          <div id="fdForm" class="bg-green-50 rounded-lg p-4">
            <h2 class="text-lg font-bold text-green-700 mb-4">üí∞ Fixed Deposit Details</h2>
            <!-- Deposit Amount -->
            <div class="mb-4">
              <label for="depositAmount" class="block text-gray-700 font-semibold mb-2">Deposit Amount:</label>
              <input type="number" id="depositAmount" placeholder="Enter amount" 
                     class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <!-- Deposit Date -->
            <div class="mb-4">
              <label for="depositDate" class="block text-gray-700 font-semibold mb-2">Deposit Date:</label>
    <input type="date" id="depositDate" 
      class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            <!-- Tenure -->
            <div class="mb-4">
              <label for="tenure" class="block text-gray-700 font-semibold mb-2">Tenure (in months):</label>
              <input type="number" id="tenure" placeholder="Enter tenure" 
                     class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <!-- Interest Rate (editable) -->
            <div class="mb-4">
              <label for="interestRate" class="block text-gray-700 font-semibold mb-2">Interest Rate (%):</label>
              <input type="number" id="interestRate" step="0.01"
                     class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter interest rate">
            </div>
            <!-- Customer ID -->
            <div class="mb-4">
              <label for="fdAccountNumber" class="block text-gray-700 font-semibold mb-2">Customer ID:</label>
              <input type="text" id="fdAccountNumber" readonly
                     class="w-full border border-gray-300 rounded px-4 py-3 bg-gray-100 text-gray-700">
            </div>
            <!-- Declaration -->
            <div class="mb-4 flex items-start bg-yellow-50 p-3 rounded-lg">
              <input type="checkbox" id="declaration" class="mt-1 accent-green-600">
              <label for="declaration" class="ml-2 text-gray-700 text-sm">
                I have read and understood the <strong>Terms & Conditions</strong> of the Fixed Deposit with 
                <strong>KSTHST Co-Operative Society (R), Kushtagi</strong>, and I agree to abide by them.
              </label>
            </div>
            <!-- Submit Button -->
            <button onclick="submitFD()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-3 rounded-lg transition shadow-md hover:shadow-lg">
              ‚úÖ Submit
            </button>
            <div id="submitMessage" class="hidden text-green-700 font-bold mt-4 text-center"></div>
          </div>
        </div>
      </div>
      <!-- Error Message -->
      <div id="errorMessage" class="hidden text-red-600 font-semibold mt-4 text-center"></div>
    </div>
  </div>
  <script>
    // Tab switching logic
    function showTab(tab) {
      // Hide both tab contents
      document.getElementById("tabDetails").classList.add("hidden");
      document.getElementById("tabCreate").classList.add("hidden");
      
      // Reset both tab buttons
      document.getElementById("tabDetailsBtn").classList.remove("border-blue-600", "text-blue-700");
      document.getElementById("tabDetailsBtn").classList.add("text-gray-600", "border-transparent");
      document.getElementById("tabCreateBtn").classList.remove("border-blue-600", "text-blue-700");
      document.getElementById("tabCreateBtn").classList.add("text-gray-600", "border-transparent");
      
      // Show selected tab and activate button
      if (tab === "details") {
        document.getElementById("tabDetails").classList.remove("hidden");
        document.getElementById("tabDetailsBtn").classList.remove("text-gray-600", "border-transparent");
        document.getElementById("tabDetailsBtn").classList.add("border-blue-600", "text-blue-700");
      } else {
        document.getElementById("tabCreate").classList.remove("hidden");
        document.getElementById("tabCreateBtn").classList.remove("text-gray-600", "border-transparent");
        document.getElementById("tabCreateBtn").classList.add("border-blue-600", "text-blue-700");
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("tabDetailsBtn").onclick = function() { showTab("details"); };
      document.getElementById("tabCreateBtn").onclick = function() { showTab("create"); };
    });

    function searchCustomer() {
      const inputAcc = document.getElementById("accountNumber").value.trim();
      const errorDiv = document.getElementById("errorMessage");
      const tabsContainer = document.getElementById("tabsContainer");
      
      // Hide all sections before search
      tabsContainer.classList.add("hidden");
      errorDiv.classList.add("hidden");
      
      if (inputAcc === "") {
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ö† Please enter an account number!</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }
      
      // Call API to fetch customer info
      fetch(`/staff/api/fd-customer-info?customer_id=${encodeURIComponent(inputAcc)}`)
        .then(resp => resp.json())
        .then(data => {
          if (data.status === "success" && data.customer) {
            document.getElementById("custName").textContent = data.customer.name || "-";
            document.getElementById("custKgid").textContent = data.customer.kgid || "-";
            document.getElementById("custAadhaar").textContent = data.customer.aadhar_no || "-";
            document.getElementById("custPan").textContent = data.customer.pan_no || "-";
            document.getElementById("custAccount").textContent = data.customer.customer_id || "-";
            document.getElementById("fdAccountNumber").value = data.customer.customer_id || "";
            
            tabsContainer.classList.remove("hidden");
            showTab("details");
            
            // Load FD list
            loadFDList(inputAcc);
          } else {
            errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
              <strong>‚ùå Account not found!</strong>
            </div>`;
            errorDiv.classList.remove("hidden");
          }
        })
        .catch((error) => {
          console.error('Search error:', error);
          errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            <strong>‚ùå Error fetching customer info!</strong>
          </div>`;
          errorDiv.classList.remove("hidden");
        });
    }

    function loadFDList(customerId) {
      const fdListContainer = document.getElementById("fdListContainer");
      fdListContainer.innerHTML = '<div class="text-gray-500 text-center">Loading...</div>';
      
      fetch(`/staff/api/fd-list?customer_id=${encodeURIComponent(customerId)}`)
        .then(resp => resp.json())
        .then(fdData => {
          if (fdData.status === "success" && Array.isArray(fdData.fds) && fdData.fds.length > 0) {
            let html = `<div class="overflow-x-auto">
              <table class="min-w-full text-sm border rounded">
                <thead>
                  <tr class="bg-blue-100">
                    <th class="px-3 py-2 text-left">FDID</th>
                    <th class="px-3 py-2 text-left">Amount</th>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Tenure</th>
                    <th class="px-3 py-2 text-left">Rate</th>
                    <th class="px-3 py-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>`;
            fdData.fds.forEach(fd => {
              html += `<tr class="border-t">
                <td class="px-3 py-2">${fd.fdid || fd.id}</td>
                <td class="px-3 py-2">‚Çπ${fd.amount}</td>
                <td class="px-3 py-2">${fd.deposit_date}</td>
                <td class="px-3 py-2">${fd.tenure} mo</td>
                <td class="px-3 py-2">${fd.interest_rate}%</td>
                <td class="px-3 py-2">${fd.status}</td>
              </tr>`;
            });
            html += "</tbody></table></div>";
            fdListContainer.innerHTML = html;
          } else {
            fdListContainer.innerHTML = `<div class="text-gray-500 text-center">No fixed deposits found for this member.</div>`;
          }
        })
        .catch((error) => {
          console.error('FD list error:', error);
          fdListContainer.innerHTML = `<div class="text-red-500 text-center">Error loading fixed deposits.</div>`;
        });
    }

    function submitFD() {
      // Clear previous messages
      const messageDiv = document.getElementById("submitMessage");
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.classList.add("hidden");
      messageDiv.classList.add("hidden");

      // Get form values with more robust element selection
      let amountEl, dateEl, tenureEl, interestRateEl, declarationEl, fdAccountNumberEl;
      
      try {
        amountEl = document.getElementById("depositAmount");
        dateEl = document.getElementById("depositDate"); 
        tenureEl = document.getElementById("tenure");
        interestRateEl = document.getElementById("interestRate");
        declarationEl = document.getElementById("declaration");
        fdAccountNumberEl = document.getElementById("fdAccountNumber");
      } catch (e) {
        console.error('Error getting form elements:', e);
      }

      // Debug: Log elements found
      console.log('Elements found:', {
        amountEl: !!amountEl,
        dateEl: !!dateEl,
        tenureEl: !!tenureEl,
        interestRateEl: !!interestRateEl,
        declarationEl: !!declarationEl,
        fdAccountNumberEl: !!fdAccountNumberEl
      });

      // Check if elements exist
      if (!amountEl || !dateEl || !tenureEl || !interestRateEl || !declarationEl || !fdAccountNumberEl) {
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Form elements not found!</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }

      // Get values directly without conditional checking
      const amount = (amountEl.value || "").trim();
      const date = (dateEl.value || "").trim();
      const tenure = (tenureEl.value || "").trim();
      const interestRate = (interestRateEl.value || "").trim();
      const declaration = declarationEl.checked || false;
      const fdAccountNumber = (fdAccountNumberEl.value || "").trim();

      // Debug: Log raw values
      console.log('Raw form values:', { 
        amount: `"${amount}"`, 
        date: `"${date}"`, 
        tenure: `"${tenure}"`, 
        interestRate: `"${interestRate}"`, 
        declaration, 
        fdAccountNumber: `"${fdAccountNumber}"` 
      });

      // Additional debug - log actual element values
      console.log('Direct element values:', {
        amountValue: amountEl.value,
        dateValue: dateEl.value,
        tenureValue: tenureEl.value,
        interestRateValue: interestRateEl.value
      });

      // Validate required fields with detailed checking
      const missing = [];
      
      if (!amount || amount.length === 0) {
        missing.push("Deposit Amount");
      } else if (isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
        missing.push("Valid Deposit Amount");
      }
      
      // Date validation: must not be empty and must not be in the future
      if (!date || date.length === 0) {
        console.log('Date validation failed:', date);
        missing.push("Deposit Date");
      } else {
        const selectedDate = new Date(date);
        const todayDate = new Date();
        todayDate.setHours(0,0,0,0);
        selectedDate.setHours(0,0,0,0);
        if (selectedDate > todayDate) {
          console.log('Date is in the future:', date);
          missing.push("Valid Deposit Date (not in future)");
        }
      }
      
      if (!tenure || tenure.length === 0) {
        missing.push("Tenure");
      } else if (isNaN(parseInt(tenure)) || parseInt(tenure) <= 0) {
        missing.push("Valid Tenure");
      }
      
      if (!interestRate || interestRate.length === 0) {
        missing.push("Interest Rate");
      } else if (isNaN(parseFloat(interestRate)) || parseFloat(interestRate) <= 0) {
        missing.push("Valid Interest Rate");
      }

      if (!fdAccountNumber || fdAccountNumber.length === 0) {
        missing.push("Customer ID");
      }

      if (missing.length > 0) {
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative flex items-center gap-2">
          <svg class="h-5 w-5 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          <span><strong>Please fill: ${missing.join(", ")}</strong></span>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }

      if (!declaration) {
        errorDiv.innerHTML = `<div class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded relative flex items-center gap-2">
          <svg class="h-5 w-5 text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01"/>
          </svg>
          <span><strong>You must agree to the Terms & Conditions.</strong></span>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }

      // Get submit button
      const submitBtn = document.querySelector("#fdForm button[onclick='submitFD()']");
      if (!submitBtn) {
        console.error('Submit button not found');
        return;
      }

      // Disable submit button to prevent multiple clicks
      submitBtn.disabled = true;
      const origBtnHTML = submitBtn.innerHTML;;
      submitBtn.innerHTML = `<span class="flex items-center justify-center gap-2">
        <svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        Submitting...
      </span>`; // Show loading spinner
      fetch("/staff/api/create-fd", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          customer_id: fdAccountNumber,
          amount: parseFloat(amount),
          deposit_date: date,
          tenure: parseInt(tenure),
          interest_rate: parseFloat(interestRate)
        })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.status === "success") {
          messageDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
            <strong>‚úÖ Fixed Deposit created! FDID: ${data.fdid}. Awaiting admin approval.</strong>
          </div>`;
          messageDiv.classList.remove("hidden");
          // Clear form
          amountEl.value = "";
          dateEl.value = "";
          tenureEl.value = "";
          interestRateEl.value = "";
          declarationEl.checked = false;
          fdAccountNumberEl.value = "";
          // Refresh customer data and switch to details tab
          setTimeout(() => {
            searchCustomer();
            showTab("details");
          }, 2000);
        } else {
          errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            <strong>‚ùå ${data.message || 'Failed to create Fixed Deposit'}</strong>
          </div>`;
          errorDiv.classList.remove("hidden");
        }
      })
      .catch(err => {
        console.error('Submit error:', err);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Network Error: Unable to submit FD</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = origBtnHTML;
      });
    }

    // Allow Enter key to trigger search
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("accountNumber").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          searchCustomer();
        }
      });
    });
  </script>
</body>
</html>
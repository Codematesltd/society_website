<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fixed Deposit Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
  <div class="w-full h-full px-0 py-0">
    <div class="bg-white shadow-2xl rounded-2xl p-8 w-full h-full border border-gray-200">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-blue-700">üîç Fixed Deposit Search</h1>
        <p class="text-gray-500 mt-2 text-sm">Search for customer details and create Fixed Deposit easily</p>
      </div>
      <!-- Search Section -->
      <div class="mb-8">
        <label for="accountNumber" class="block text-gray-700 font-semibold mb-2">Enter Customer ID:</label>
        <div class="flex shadow rounded-lg overflow-hidden">
          <input type="text" id="accountNumber" placeholder="e.g. KSTHST7934" 
                 class="flex-1 border border-gray-300 px-4 py-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
          <button onclick="searchCustomer()" 
                  class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 transition">
            Search
          </button>
        </div>
      </div>
      <!-- Tabs -->
      <div id="tabsContainer" class="hidden">
        <div class="flex border-b mb-4">
          <button id="tabDetailsBtn" class="tab-btn px-4 py-2 font-semibold text-blue-700 border-b-2 border-blue-600 bg-white focus:outline-none">FD Details</button>
          <button id="tabCreateBtn" class="tab-btn px-4 py-2 font-semibold text-gray-600 border-b-2 border-transparent bg-white focus:outline-none">Create FD</button>
        </div>
        <!-- FD Details Tab -->
        <div id="tabDetails" class="tab-content">
          <!-- Customer Details -->
          <div id="customerDetails" class="border-t pt-4 bg-blue-50 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-bold text-blue-700 mb-2">üë§ Customer Details</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-gray-700">
              <p><strong>Name:</strong> <span id="custName"></span></p>
              <p><strong>KGID:</strong> <span id="custKgid"></span></p>
              <p><strong>Aadhaar:</strong> <span id="custAadhaar"></span></p>
              <p><strong>PAN:</strong> <span id="custPan"></span></p>
              <p><strong>Customer ID:</strong> <span id="custAccount"></span></p>
            </div>
          </div>
          <!-- FD List Section -->
          <div id="fdListSection" class="bg-gray-50 rounded-lg p-4">
            <h2 class="text-lg font-bold text-blue-700 mb-2">üìã Fixed Deposits</h2>
            <div id="fdListContainer">
              <div class="text-gray-500 text-center">Loading...</div>
            </div>
          </div>
        </div>
        <!-- Create FD Tab -->
        <div id="tabCreate" class="tab-content hidden">
          <!-- FD Form (Create FD Tab) -->
          <div id="fdForm" class="bg-green-50 rounded-lg p-4">
            <h2 class="text-lg font-bold text-green-700 mb-4">üí∞ Fixed Deposit Details</h2>
            <!-- Deposit Amount -->
            <div class="mb-4">
              <label for="fdAmount" class="block text-gray-700 font-semibold mb-2">Deposit Amount:</label>
              <input type="number" id="fdAmount" placeholder="Enter amount" required
                     class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <!-- Deposit Date -->
            <div class="mb-4">
              <label for="fdDate" class="block text-gray-700 font-semibold mb-2">Deposit Date:</label>
              <input type="date" id="fdDate" required
                class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <!-- Tenure -->
            <div class="mb-4">
              <label for="fdTenure" class="block text-gray-700 font-semibold mb-2">Tenure (in months):</label>
              <input type="number" id="fdTenure" placeholder="Enter tenure" required
                     class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <!-- Interest Rate (editable) -->
            <div class="mb-4">
              <label for="fdInterestRate" class="block text-gray-700 font-semibold mb-2">Interest Rate (%):</label>
              <input type="number" id="fdInterestRate" step="0.01" required
                     class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter interest rate">
            </div>
            <!-- Customer ID -->
            <div class="mb-4">
              <label for="fdCustomerId" class="block text-gray-700 font-semibold mb-2">Customer ID:</label>
              <input type="text" id="fdCustomerId" readonly
                     class="w-full border border-gray-300 rounded px-4 py-3 bg-gray-100 text-gray-700">
            </div>
            <!-- Submit Button -->
            <button onclick="submitFD()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-3 rounded-lg transition shadow-md hover:shadow-lg">
              ‚úÖ Submit
            </button>
            <div id="submitMessage" class="hidden text-green-700 font-bold mt-4 text-center"></div>
          </div>
        </div>
      </div>
      <!-- Error Message -->
      <div id="errorMessage" class="hidden text-red-600 font-semibold mt-4 text-center"></div>
    </div>
  </div>
  <script>
    // Tab switching logic
    function showTab(tab) {
      // Hide both tab contents
      document.getElementById("tabDetails").classList.add("hidden");
      document.getElementById("tabCreate").classList.add("hidden");
      
      // Reset both tab buttons
      document.getElementById("tabDetailsBtn").classList.remove("border-blue-600", "text-blue-700");
      document.getElementById("tabDetailsBtn").classList.add("text-gray-600", "border-transparent");
      document.getElementById("tabCreateBtn").classList.remove("border-blue-600", "text-blue-700");
      document.getElementById("tabCreateBtn").classList.add("text-gray-600", "border-transparent");
      
      // Show selected tab and activate button
      if (tab === "details") {
        document.getElementById("tabDetails").classList.remove("hidden");
        document.getElementById("tabDetailsBtn").classList.remove("text-gray-600", "border-transparent");
        document.getElementById("tabDetailsBtn").classList.add("border-blue-600", "text-blue-700");
      } else {
        document.getElementById("tabCreate").classList.remove("hidden");
        document.getElementById("tabCreateBtn").classList.remove("text-gray-600", "border-transparent");
        document.getElementById("tabCreateBtn").classList.add("border-blue-600", "text-blue-700");
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("tabDetailsBtn").onclick = function() { showTab("details"); };
      document.getElementById("tabCreateBtn").onclick = function() { showTab("create"); };
    });

    function searchCustomer() {
      const inputAcc = document.getElementById("accountNumber").value.trim();
      const errorDiv = document.getElementById("errorMessage");
      const tabsContainer = document.getElementById("tabsContainer");
      
      // Hide all sections before search
      tabsContainer.classList.add("hidden");
      errorDiv.classList.add("hidden");
      
      if (inputAcc === "") {
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ö† Please enter an account number!</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }
      
      // Call API to fetch customer info
      fetch(`/staff/api/fd-customer-info?customer_id=${encodeURIComponent(inputAcc)}`)
        .then(resp => resp.json())
        .then(data => {
          if (data.status === "success" && data.customer) {
            document.getElementById("custName").textContent = data.customer.name || "-";
            document.getElementById("custKgid").textContent = data.customer.kgid || "-";
            document.getElementById("custAadhaar").textContent = data.customer.aadhar_no || "-";
            document.getElementById("custPan").textContent = data.customer.pan_no || "-";
            document.getElementById("custAccount").textContent = data.customer.customer_id || "-";
            document.getElementById("fdCustomerId").value = data.customer.customer_id || "";
            
            tabsContainer.classList.remove("hidden");
            showTab("details");
            
            // Load FD list
            loadFDList(inputAcc);
          } else {
            errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
              <strong>‚ùå Account not found!</strong>
            </div>`;
            errorDiv.classList.remove("hidden");
          }
        })
        .catch((error) => {
          console.error('Search error:', error);
          errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            <strong>‚ùå Error fetching customer info!</strong>
          </div>`;
          errorDiv.classList.remove("hidden");
        });
    }

    function loadFDList(customerId) {
      const fdListContainer = document.getElementById("fdListContainer");
      fdListContainer.innerHTML = '<div class="text-gray-500 text-center">Loading...</div>';
      
      fetch(`/staff/api/fd-list?customer_id=${encodeURIComponent(customerId)}`)
        .then(resp => resp.json())
        .then(fdData => {
          if (fdData.status === "success" && Array.isArray(fdData.fds) && fdData.fds.length > 0) {
            let html = `<div class="overflow-x-auto">
              <table class="min-w-full text-sm border rounded">
                <thead>
                  <tr class="bg-blue-100">
                    <th class="px-3 py-2 text-left">FDID</th>
                    <th class="px-3 py-2 text-left">Amount</th>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Tenure</th>
                    <th class="px-3 py-2 text-left">Rate</th>
                    <th class="px-3 py-2 text-left">Status</th>
                    <th class="px-3 py-2 text-left">Certificate</th> <!-- NEW -->
                  </tr>
                </thead>
                <tbody>`;
            fdData.fds.forEach(fd => {
              html += `<tr class="border-t">
                <td class="px-3 py-2">${fd.fdid || fd.id}</td>
                <td class="px-3 py-2">‚Çπ${fd.amount}</td>
                <td class="px-3 py-2">${fd.deposit_date}</td>
                <td class="px-3 py-2">${fd.tenure} mo</td>
                <td class="px-3 py-2">${fd.interest_rate}%</td>
                <td class="px-3 py-2">${fd.status}</td>
                <td class="px-3 py-2">
                  ${
                    fd.status === 'approved'
                      ? `<a href="/fd/certificate/${fd.fdid}?action=view" target="_blank" class="text-blue-600 underline mr-2">View</a>
                         <a href="/fd/certificate/${fd.fdid}?action=download" class="text-green-600 underline">Download</a>`
                      : `<span class="text-gray-400 text-sm">Pending</span>`
                  }
                </td>
              </tr>`;
            });
            html += "</tbody></table></div>";
            fdListContainer.innerHTML = html;
          } else {
            fdListContainer.innerHTML = `<div class="text-gray-500 text-center">No fixed deposits found for this member.</div>`;
          }
        })
        .catch((error) => {
          console.error('FD list error:', error);
          fdListContainer.innerHTML = `<div class="text-red-500 text-center">Error loading fixed deposits.</div>`;
        });
    }

    function submitFD() {
      // Clear previous messages
      const messageDiv = document.getElementById("submitMessage");
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.classList.add("hidden");
      messageDiv.classList.add("hidden");

      // Get form values directly
      const amountEl = document.getElementById("fdAmount");
      const dateEl = document.getElementById("fdDate");
      const tenureEl = document.getElementById("fdTenure");
      const interestRateEl = document.getElementById("fdInterestRate");
      const fdAccountNumberEl = document.getElementById("fdCustomerId");

      // Basic validation - Fix: check if elements exist first
      if (!amountEl || !dateEl || !tenureEl || !interestRateEl || !fdAccountNumberEl) {
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Form elements not found</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }

      // Get values - Handle date input properly
      const amount = amountEl.value?.trim();
      let date = dateEl.value?.trim();
      const tenure = tenureEl.value?.trim();
      const interestRate = interestRateEl.value?.trim();
      const customerId = fdAccountNumberEl.value?.trim();

      // If date is empty but the input shows a visual date, try to get it differently
      if (!date || date === '') {
        // Check if there's a visual value in the input (some browsers show formatted date)
        const dateInputValue = dateEl.getAttribute('value') || dateEl.defaultValue;
        if (dateInputValue) {
          date = dateInputValue;
        } else {
          // Try to get current date as fallback and format it properly
          const today = new Date();
          date = today.toISOString().split('T')[0]; // YYYY-MM-DD format
          dateEl.value = date; // Set it back to the input
        }
      }

      // Convert date from DD-MM-YYYY to YYYY-MM-DD if needed
      if (date && date.includes('-') && date.length === 10) {
        const dateParts = date.split('-');
        if (dateParts.length === 3 && dateParts[0].length === 2) {
          // Convert from DD-MM-YYYY to YYYY-MM-DD
          date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
        }
      }

      console.log('Form values after processing:', { amount, date, tenure, interestRate, customerId });
      console.log('Raw element values:', {
        amount: amountEl.value,
        date: dateEl.value,
        dateAttribute: dateEl.getAttribute('value'),
        tenure: tenureEl.value,
        interestRate: interestRateEl.value,
        customerId: fdAccountNumberEl.value
      });

      // Enhanced validation with better error messages
      if (!customerId) {
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Customer ID is required. Please search for a customer first.</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        return;
      }

      // Fix: Check for actual empty/null values, not just falsy
      if (!amount || amount === '' || amount === null || amount === undefined) {
        console.log('Amount validation failed:', amount, typeof amount);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Deposit Amount is required</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        amountEl.focus();
        return;
      }

      if (!date || date === '' || date === null || date === undefined) {
        console.log('Date validation failed:', date, typeof date);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Deposit Date is required. Please select a valid date.</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        dateEl.focus();
        return;
      }

      if (!tenure || tenure === '' || tenure === null || tenure === undefined) {
        console.log('Tenure validation failed:', tenure, typeof tenure);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Tenure is required</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        tenureEl.focus();
        return;
      }

      if (!interestRate || interestRate === '' || interestRate === null || interestRate === undefined) {
        console.log('Interest rate validation failed:', interestRate, typeof interestRate);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Interest Rate is required</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        interestRateEl.focus();
        return;
      }

      // Validate numeric values
      const numAmount = parseFloat(amount);
      const numTenure = parseInt(tenure);
      const numInterestRate = parseFloat(interestRate);

      console.log('Parsed numeric values:', { numAmount, numTenure, numInterestRate });

      if (isNaN(numAmount) || numAmount <= 0) {
        console.log('Numeric amount validation failed:', numAmount, isNaN(numAmount), numAmount <= 0);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Please enter a valid amount greater than 0</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        amountEl.focus();
        return;
      }

      if (isNaN(numTenure) || numTenure <= 0) {
        console.log('Numeric tenure validation failed:', numTenure, isNaN(numTenure), numTenure <= 0);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Please enter a valid tenure greater than 0</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        tenureEl.focus();
        return;
      }

      if (isNaN(numInterestRate) || numInterestRate < 0) {
        console.log('Numeric interest rate validation failed:', numInterestRate, isNaN(numInterestRate), numInterestRate < 0);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Please enter a valid interest rate</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
        interestRateEl.focus();
        return;
      }

      console.log('All validation passed, proceeding with submission...');

      // Get submit button and show loading
      const submitBtn = document.querySelector("button[onclick='submitFD()']");
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = "üîÑ Submitting...";
      
      // Submit to API
      fetch("/staff/api/create-fd", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({
          customer_id: customerId,
          amount: numAmount,
          deposit_date: date,
          tenure: numTenure,
          interest_rate: numInterestRate
        })
      })
      .then(resp => {
        console.log('Response status:', resp.status);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        return resp.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.status === "success") {
          messageDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
            <strong>‚úÖ Fixed Deposit created successfully! FDID: ${data.fdid}</strong>
          </div>`;
          messageDiv.classList.remove("hidden");
          
          // Clear form
          amountEl.value = "";
          dateEl.value = "";
          tenureEl.value = "";
          interestRateEl.value = "";
          
          // Switch to details tab after 2 seconds and refresh the list
          setTimeout(() => {
            showTab("details");
            loadFDList(customerId);
          }, 2000);
        } else {
          errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            <strong>‚ùå ${data.message || 'Failed to create Fixed Deposit'}</strong>
          </div>`;
          errorDiv.classList.remove("hidden");
        }
      })
      .catch(err => {
        console.error('Submit error:', err);
        errorDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
          <strong>‚ùå Network Error: ${err.message}</strong>
        </div>`;
        errorDiv.classList.remove("hidden");
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
    }

    // Allow Enter key to trigger search
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("accountNumber").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          searchCustomer();
        }
      });
    });
  </script>
</body>
</html>
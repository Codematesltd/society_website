<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Set Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-200 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 relative">
        <img src="https://geqletipzwxokceydhmi.supabase.co/storage/v1/object/public/staff-add/society_logo.png" alt="Society Logo" class="w-16 h-16 mx-auto mb-4 rounded-full shadow border-2 border-blue-200 bg-white">
        <h2 class="text-3xl font-extrabold mb-6 text-center text-blue-800 tracking-wide">Set Your Password</h2>
        <form id="setPasswordForm" class="space-y-6">
            <input type="hidden" name="token" id="token" value="{{ token }}">
            <div>
                <label for="password" class="block text-gray-700 font-semibold">New Password</label>
                <input id="password" name="password" type="password"
                  class="mt-1 block w-full rounded-lg border border-gray-300 bg-gray-50 shadow focus:ring-blue-500 focus:border-blue-500 px-4 py-2 transition"
                  required>
                <div id="pwRules" class="mt-2 text-xs space-y-1">
                    <div id="pwRuleLen" class="flex items-center text-gray-500"><span class="mr-1">✗</span>8 characters or more</div>
                    <div id="pwRuleUpper" class="flex items-center text-gray-500"><span class="mr-1">✗</span>Uppercase letter</div>
                    <div id="pwRuleLower" class="flex items-center text-gray-500"><span class="mr-1">✗</span>Lowercase letter</div>
                    <div id="pwRuleNum" class="flex items-center text-gray-500"><span class="mr-1">✗</span>Number</div>
                    <div id="pwRuleSpecial" class="flex items-center text-gray-500"><span class="mr-1">✗</span>Special character (e.g. !?@#$%)</div>
                </div>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-blue-600 shadow transition">Set Password</button>
        </form>
        <div id="setPasswordMsg" class="mt-4 text-center text-red-600"></div>
    </div>
    <script>
function updatePwRules(pw) {
    const len = pw.length >= 8;
    const upper = /[A-Z]/.test(pw);
    const lower = /[a-z]/.test(pw);
    const num = /\d/.test(pw);
    const special = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw);

    function setRule(id, ok) {
        const el = document.getElementById(id);
        el.className = "flex items-center " + (ok ? "text-green-600" : "text-gray-500");
        el.children[0].textContent = ok ? "✓" : "✗";
    }
    setRule("pwRuleLen", len);
    setRule("pwRuleUpper", upper);
    setRule("pwRuleLower", lower);
    setRule("pwRuleNum", num);
    setRule("pwRuleSpecial", special);
    return len && upper && lower && num && special;
}

document.getElementById('password').addEventListener('input', function() {
    updatePwRules(this.value);
    if (this.value.length === 0) {
        this.classList.remove('border-red-500');
    }
});

document.getElementById('setPasswordForm').onsubmit = async function(e) {
    e.preventDefault();
    const token = document.getElementById('token').value;
    const password = document.getElementById('password').value;
    const msg = document.getElementById('setPasswordMsg');
    msg.textContent = "";

    // Strict password validation: min 8 chars, 1 cap, 1 small, 1 number, 1 special
    if (!updatePwRules(password)) {
        msg.textContent = "Password must be at least 8 characters, include 1 uppercase, 1 lowercase, 1 number, and 1 special character.";
        msg.className = "mt-4 text-center text-red-600";
        document.getElementById('password').classList.add('border-red-500');
        return;
    } else {
        document.getElementById('password').classList.remove('border-red-500');
    }

    const res = await fetch('/auth/set_password?token=' + encodeURIComponent(token), {
        method: 'POST',
        body: new URLSearchParams({password}),
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
    });
    const data = await res.json();
    if (data.status === 'success') {
        msg.textContent = "Password set successfully. You can now login.";
        msg.className = "mt-4 text-center text-green-600";
    } else {
        msg.textContent = data.message;
        msg.className = "mt-4 text-center text-red-600";
    }
};
    </script>
</body>
</html>

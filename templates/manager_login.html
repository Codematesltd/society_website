<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manager Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-200 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 relative">
        <img src="https://geqletipzwxokceydhmi.supabase.co/storage/v1/object/public/staff-add/society_logo.png" alt="Society Logo" class="w-16 h-16 mx-auto mb-4 rounded-full shadow border-2 border-blue-200 bg-white">
        <h2 class="text-3xl font-extrabold mb-6 text-center text-blue-800 tracking-wide">Manager Login</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div>
              {% for category, message in messages %}
                <div class="mb-4 px-4 py-2 rounded text-white {% if category == 'success' %}bg-green-500{% else %}bg-red-500{% endif %}">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

  <form id="loginForm" method="POST" action="{{ url_for('manager.manager_login') }}" class="space-y-6" autocomplete="off" novalidate>
            {# Only include this if using Flask-WTF. Otherwise, remove or comment out the next line. #}
            {# {{ form.hidden_tag() }} #}
            <div>
                <label for="email" class="block text-gray-700">Email</label>
                <input id="email" name="email" type="email"
                  class="mt-1 block w-full rounded-lg border border-gray-300 bg-gray-50 shadow focus:ring-blue-500 focus:border-blue-500 px-4 py-2 transition"
                  required autocomplete="off">
                <p id="emailError" class="text-red-500 text-sm mt-1 hidden"></p>
            </div>
            <div>
                <label for="password" class="block text-gray-700">Password</label>
                <div class="relative">
                    <input id="password" name="password" type="password"
                      class="mt-1 block w-full rounded-lg border border-gray-300 bg-gray-50 shadow focus:ring-blue-500 focus:border-blue-500 pr-10 px-4 py-2 transition"
                      required autocomplete="off">
                    <button type="button" id="togglePassword" tabindex="-1" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 focus:outline-none">
                        <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                </div>
                <p id="passwordError" class="text-red-500 text-sm mt-1 hidden"></p>
            </div>
            <div>
                <button id="submitBtn" type="submit" class="w-full flex justify-center items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 focus:outline-none disabled:opacity-50">
                    <span id="btnText">Login</span>
                    <svg id="spinner" class="animate-spin h-5 w-5 ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                    </svg>
                </button>
            </div>
        </form>
    </div>
    <script>
      // Show/Hide Password Toggle
      document.getElementById('togglePassword').addEventListener('click', function () {
        const passwordInput = document.getElementById('password');
        const eyeIcon = document.getElementById('eyeIcon');
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95m1.414-1.414A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.956 9.956 0 01-4.043 5.197M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" />`;
        } else {
          passwordInput.type = 'password';
          eyeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
        }
      });

      // SQL injection check function
      function hasSQLi(str) {
        if (!str) return false;
        const s = String(str);
        const patterns = [
            /(\%27)|(\')|(\-\-)|(\%23)|(#)/i,
            /(\%22)|(\")/i,
            /(\%3D)|(=)/i,
            /\b(OR|AND)\b\s+\d+=\d+/i,
            /\b(UNION|SELECT|INSERT|UPDATE|DELETE|DROP|ALTER|CREATE)\b/i,
            /\b(WHERE|FROM|TABLE|DATABASE)\b/i,
            /\b(EXEC|EXECUTE|CAST|CONVERT)\b/i,
            /\b(SLEEP|BENCHMARK|WAITFOR)\b/i,
        ];
        return patterns.some(pat => pat.test(s));
      }

      // Front-end Validation & Submission Handling
  document.getElementById('loginForm').addEventListener('submit', async function (e) {
        let valid = true;
        const email = document.getElementById('email');
        const password = document.getElementById('password');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        emailError.classList.add('hidden');
        passwordError.classList.add('hidden');

        // Email validation
        if (!email.value) {
          emailError.textContent = "Email is required.";
          emailError.classList.remove('hidden');
          valid = false;
        } else if (!/^\S+@\S+\.\S+$/.test(email.value)) {
          emailError.textContent = "Enter a valid email address.";
          emailError.classList.remove('hidden');
          valid = false;
        }

        // Password validation
        if (!password.value) {
          passwordError.textContent = "Password is required.";
          passwordError.classList.remove('hidden');
          valid = false;
        }

        // Add SQLi check
        if (hasSQLi(email.value) || hasSQLi(password.value)) {
          emailError.textContent = "Invalid input detected.";
          emailError.classList.remove('hidden');
          e.preventDefault();
          return;
        }

        if (!valid) {
          e.preventDefault();
          return;
        }

        // Strict password validation: min 8 chars, 1 cap, 1 small, 1 number, 1 special
        const pwPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
        if (!password.value || !pwPattern.test(password.value)) {
          passwordError.textContent = "Password must be at least 8 characters, include 1 uppercase, 1 lowercase, 1 number, and 1 special character.";
          passwordError.classList.remove('hidden');
          password.classList.add('border-red-500');
          e.preventDefault();
          return;
        } else {
          passwordError.classList.add('hidden');
          password.classList.remove('border-red-500');
        }

        // Prevent multiple submissions
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('btnText').textContent = "Logging in...";
        document.getElementById('spinner').classList.remove('hidden');

        // Progressive enhancement: try AJAX to capture token; fallback to normal POST
        try {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          const res = await fetch(form.action, { method:'POST', headers:{'Accept':'application/json'}, body: formData });
          if (res.headers.get('content-type') && res.headers.get('content-type').includes('application/json')) {
            const data = await res.json();
            if (data && data.status === 'success') {
              try { if (data.token) sessionStorage.setItem('authToken', data.token); } catch(e) {}
              window.location.replace(data.redirect || "{{ url_for('admin.dashboard') }}");
              return;
            }
          }
        } catch (err) {
          // ignore and let default submit proceed
        }
      });
    </script>
</body>
</html>

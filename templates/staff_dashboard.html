<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="{{ url_for('static', filename='society_logo.png') }}" type="image/png">
  <title>Staff Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .floating-box {
      transform: translateY(100%);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }
    .floating-box.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
  // ...existing code...
    
      const sections = document.querySelectorAll('.dynamic-section');
      const buttons = document.querySelectorAll('.nav-button');
      const homeBtn = document.getElementById('homeBtn');

      // Show section helper
      function showSection(sectionId) {
        sections.forEach(sec => sec.classList.add('hidden'));
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.remove('hidden');
          const content = section.querySelector('.content');
          const loader = section.querySelector('.loader');
          if (content && loader) {
            content.classList.add('hidden');
            loader.classList.remove('hidden');
            setTimeout(() => {
              loader.classList.add('hidden');
              content.classList.remove('hidden');
            }, 400);
          } else if (content) {
            content.classList.remove('hidden');
          }
        }
      }

      // Sidebar nav buttons
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          showSection(btn.dataset.target);
        });
      });

      // Home button always shows dashboard summary
      if (homeBtn) {
        homeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          showSection('dashboardSummary');
        });
      }

      // Show dashboard summary by default on page load
      showSection('dashboardSummary');

      // Fetch dashboard stats from backend
      async function fetchDashboardStats() {
        try {
          const res = await fetch('/staff/api/dashboard-stats');
          const data = await res.json();
          if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed');
          const totalCustomersEl = document.getElementById('totalCustomers');
          const activeLoansEl = document.getElementById('activeLoans');
          const totalAmountEl = document.getElementById('totalAmount');
          if (totalCustomersEl) totalCustomersEl.textContent = data.total_customers ?? 0;
          if (activeLoansEl) activeLoansEl.textContent = data.active_loans ?? 0;
          if (totalAmountEl) totalAmountEl.textContent = '‚Çπ' + Number(data.total_balance || 0).toLocaleString();
        } catch (e) {
          // leave defaults on failure
          console.warn('Dashboard stats load failed', e);
        }
      }
      fetchDashboardStats();

      // Customer Account Info search logic
      const form = document.getElementById('customerSearchForm');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const customerId = document.getElementById('kgidInput').value.trim();
          const resultDiv = document.getElementById('customerInfoResult');
          resultDiv.innerHTML = '<div class="text-blue-600">Loading...</div>';
          try {
            // fetch by customer_id via staff API (members table)
            const res = await fetch(`/staff/api/fetch-account?customer_id=${encodeURIComponent(customerId)}`);
            const data = await res.json().catch(()=>null);
            if (!res.ok || !data || data.status !== 'success') {
              const msg = (data && data.message) || 'Error fetching data.';
              resultDiv.innerHTML = `<div class="text-red-600">${msg}</div>`;
              return;
            }
            const m = data;
            // Render all requested fields including photo/signature
            const salaryText = (m.salary !== null && m.salary !== undefined && m.salary !== '') ? '‚Çπ' + Number(m.salary).toLocaleString() : '-';
            const balanceText = (m.balance !== null && m.balance !== undefined && m.balance !== '') ? '‚Çπ' + Number(m.balance).toLocaleString() : '-';
            resultDiv.innerHTML = `
              <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow border">
                <div class="flex flex-col md:flex-row gap-6 items-start">
                  <div class="flex-1 space-y-2 text-sm">
                    <div><strong>Name:</strong> ${m.name ?? '-'}</div>
                    <div><strong>KGID:</strong> ${m.kgid ?? '-'}</div>
                    <div><strong>Phone:</strong> ${m.phone ?? '-'}</div>
                    <div><strong>Email:</strong> ${m.email ?? '-'}</div>
                    <div><strong>Salary:</strong> ${salaryText}</div>
                    <div><strong>Organization:</strong> ${m.organization_name ?? '-'}</div>
                    <div><strong>Address:</strong> ${m.address ?? '-'}</div>
                    <div><strong>Balance:</strong> ${balanceText}</div>
                    <div><strong>Customer ID:</strong> ${m.customer_id ?? '-'}</div>
                    <div><strong>Status:</strong> ${m.status ?? '-'}</div>
                  </div>
                  <div class="w-full md:w-64 flex flex-col items-center gap-4">
                    <div class="w-28 h-28 rounded-full overflow-hidden ring-2 ring-blue-200 bg-gray-50 flex items-center justify-center">
                      ${m.photo_url ? `<img src="${m.photo_url}" alt="Photo" class="w-full h-full object-cover"/>` : '<span class="text-gray-400 text-xs">No Photo</span>'}
                    </div>
                    <div class="w-full">
                      <div class="text-xs text-gray-500 mb-1">Signature</div>
                      <div class="border rounded p-2 bg-gray-50 flex items-center justify-center min-h-[80px]">
                        ${m.signature_url ? `<img src="${m.signature_url}" alt="Signature" class="max-h-24 object-contain"/>` : '<span class="text-gray-400 text-xs">No Signature</span>'}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          } catch {
            resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
          }
        });
      }

      let editing = false;
      let currentData = null;

      function renderCustomerInfo(data, editable) {
        if (!editable) {
          return `
            <div class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
              <div class="mb-4">
                <p><strong>Name:</strong> ${data.name}</p>
                <p><strong>KGID:</strong> ${data.kgid}</p>
                <p><strong>Phone:</strong> ${data.phone}</p>
                <p><strong>Email:</strong> ${data.email}</p>
                <p><strong>Address:</strong> ${data.address}</p>
              </div>
              <button id="editProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Edit Profile</button>
            </div>
          `;
        } else {
          return `
            <form id="editProfileForm" class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
              <div class="mb-4">
                <label class="block mb-1 font-medium">Name</label>
                <input type="text" name="name" value="${data.name}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">KGID</label>
                <input type="text" name="kgid" value="${data.kgid}" class="w-full px-4 py-2 border rounded mb-2" disabled />
                <label class="block mb-1 font-medium">Phone</label>
                <input type="text" name="phone" value="${data.phone}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">Email</label>
                <input type="email" name="email" value="${data.email}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">Address</label>
                <input type="text" name="address" value="${data.address}" class="w-full px-4 py-2 border rounded mb-2" />
              </div>
              <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded shadow">Update</button>
            </form>
          `;
        }
      }

      function attachEditHandler(data) {
        const editBtn = document.getElementById('editProfileBtn');
        if (editBtn) {
          editBtn.onclick = function() {
            editing = true;
            const resultDiv = document.getElementById('customerInfoResult');
            resultDiv.innerHTML = renderCustomerInfo(data, true);
            attachUpdateHandler();
          };
        }
      }

      function attachUpdateHandler() {
        const editForm = document.getElementById('editProfileForm');
        if (editForm) {
          editForm.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(editForm);
            const updatedData = {
              name: formData.get('name'),
              kgid: formData.get('kgid'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address')
            };
            const resultDiv = document.getElementById('customerInfoResult');
            resultDiv.innerHTML = '<div class="text-blue-600">Updating...</div>';
            try {
              const res = await fetch(`/api/customer/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
              });
              if (res.ok) {
                resultDiv.innerHTML = renderCustomerInfo(updatedData, false);
                attachEditHandler(updatedData);
              } else {
                resultDiv.innerHTML = `<div class="text-red-600">Update failed.</div>`;
              }
            } catch {
              resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
            }
          };
        }
      }

      // --- Fix for Apply Loan step navigation ---
      // Move step2 to visible when clicking Next in step1
      const toStep2Btn = document.getElementById('toStep2Btn');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const loanFormError = document.getElementById('loanFormError');

      if (toStep2Btn && step1 && step2) {
        toStep2Btn.addEventListener('click', function () {
          const selectedLoanType = document.querySelector('input[name="loanType"]:checked');
          if (!selectedLoanType) {
            if (loanFormError) loanFormError.textContent = "Please select a loan type.";
            return;
          }
          if (loanFormError) loanFormError.textContent = "";
          step1.classList.add('hidden');
          step2.classList.remove('hidden');
          // Hide step3 in case user is retrying
          if (step3) step3.classList.add('hidden');
        });
      }

      // Fetch customer data for loan application (dummy implementation)
      const loanAccountNumberInput = document.getElementById('loanAccountNumber');
      const fetchAccountBtn = document.getElementById('fetchAccountBtn');
      const accountFetchMsg = document.getElementById('accountFetchMsg');

      if (fetchAccountBtn) {
        fetchAccountBtn.addEventListener('click', async () => {
          const customerId = loanAccountNumberInput.value.trim();
          if (!customerId) {
            accountFetchMsg.textContent = "Please enter a customer ID.";
            return;
          }
          accountFetchMsg.textContent = "Fetching details...";
          try {
            // changed to staff API
            const res = await fetch(`/staff/api/fetch-account?customer_id=${encodeURIComponent(customerId)}`);
            if (res.ok) {
              const data = await res.json();
              if (data && data.status === "success" && data.name) {
                document.getElementById('loanName').value = data.name;
                document.getElementById('loanKGID').value = data.kgid || '';
                document.getElementById('loanAccount').value = data.customer_id || customerId;
                loanAccountNumberInput.value = data.customer_id || customerId;
                accountFetchMsg.textContent = "";
                // Hide Next button after fetching account details
                const nextBtn = document.getElementById('toStep2Btn');
                if (nextBtn) nextBtn.classList.add('hidden');
                // Show step 3 and loan type if not already visible
                if (step3.classList.contains('hidden')) {
                  step3.classList.remove('hidden');
                  step2.classList.add('hidden');
                  document.getElementById('step1').classList.remove('hidden');
                }
              } else {
                accountFetchMsg.textContent = "Account not found.";
              }
            } else {
              accountFetchMsg.textContent = "Error fetching account details.";
            }
          } catch {
            accountFetchMsg.textContent = "Network error.";
          }
        });
      }

      // Surety check logic (dummy implementation)
      function setupSuretyCheck(suretyBtnId, suretyKGIDInputId, suretyMsgId) {
        const checkBtn = document.getElementById(suretyBtnId);
        const kgidInput = document.getElementById(suretyKGIDInputId);
        const msgDiv = document.getElementById(suretyMsgId);
        const removeBtn = document.getElementById(suretyBtnId.replace('check', 'remove'));

        function preloadSurety(data) {
          const fieldsDiv = document.getElementById(
            suretyBtnId === 'checkSurety1Btn' ? 'surety1Fields' : 'surety2Fields'
          );
          fieldsDiv.innerHTML = '';
          if (data.available) {
            msgDiv.textContent = '';
            fieldsDiv.innerHTML = `
              <div><label class="block font-medium mb-1">KGID</label>
                   <input type="text" value="${kgidInput.value}" readonly class="w-full px-4 py-2 border rounded bg-gray-100"/>
              </div>
              <div><label class="block font-medium mb-1">Name</label>
                   <input type="text" value="${data.member.name}" readonly class="w-full px-4 py-2 border rounded bg-gray-100"/>
              </div>
              <div><label class="block font-medium mb-1">Phone</label>
                   <input type="text" value="${data.member.phone}" readonly class="w-full px-4 py-2 border rounded bg-gray-100"/>
              </div>`;
          } else if (data.active_loan_count >= 2) {
            msgDiv.textContent = "This surety is already backing 2 active loans.";
          } else {
            msgDiv.textContent = data.reason || "Surety not found.";
          }
        }

        if (checkBtn) {
          checkBtn.addEventListener('click', async () => {
            const kgid = kgidInput.value.trim();
            msgDiv.textContent = "Checking surety...";
            try {
              // UPDATED: use customer_id query param and return object that matches preloadSurety
              const res = await fetch(`/finance/api/check-surety?customer_id=${encodeURIComponent(kgid)}`);
              if (res.ok) {
                const data = await res.json();
                // Build object with properties preloadSurety expects
                const suretyObj = {
                  available: !!data.available,
                  member: data.member || {},
                  active_loan_count: data.active_loan_count || 0
                };
                preloadSurety(suretyObj);
                // Enable UI only when available and active_loan_count < 2
                if (suretyObj.available && suretyObj.active_loan_count < 2) {
                  checkBtn.disabled = true;
                  kgidInput.disabled = true;
                  if (removeBtn) removeBtn.classList.remove('hidden');
                }
              } else {
                msgDiv.textContent = "Error checking surety.";
              }
            } catch {
              msgDiv.textContent = "Network error.";
            }
          });
        }
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            msgDiv.textContent = "";
            kgidInput.value = "";
            kgidInput.disabled = false;
            checkBtn.disabled = false;
            removeBtn.classList.add('hidden');
          });
        }
      }

      setupSuretyCheck('checkSurety1Btn', 'surety1KGID', 'surety1Msg');
      setupSuretyCheck('checkSurety2Btn', 'surety2KGID', 'surety2Msg');

      // Terms and conditions toggle (for demo, auto-checking)
      // Terms and conditions: keep enabled and required, do not auto-check
      const termsCheckbox = document.getElementById('termsCheckbox');
      const applyLoanBtn = document.getElementById('applyLoanBtn');
      if (termsCheckbox && applyLoanBtn) {
        termsCheckbox.checked = false;
        termsCheckbox.disabled = false;
        termsCheckbox.required = true;
        // Helper to check if all required fields are filled
        function checkFormReady() {
          const requiredIds = [
            'loanName', 'loanAccount', 'loanKGID', 'loanAmount', 'loanInterest', 'loanTenure', 'loanPurpose',
            'surety1KGID', 'surety2KGID'
          ];
          let allFilled = requiredIds.every(id => {
            const el = document.getElementById(id);
            return el && el.value.trim() !== '';
          });
          applyLoanBtn.disabled = !(allFilled && termsCheckbox.checked);
        }
        // Listen to changes on all required fields and checkbox
        const requiredIds = [
          'loanName', 'loanAccount', 'loanKGID', 'loanAmount', 'loanInterest', 'loanTenure', 'loanPurpose',
          'surety1KGID', 'surety2KGID'
        ];
        requiredIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', checkFormReady);
          }
        });
        termsCheckbox.addEventListener('change', checkFormReady);
        // Initial state
        checkFormReady();
      }

      // Loan application form submission (step 3)
      const loanStepForm = document.getElementById('loanStepForm');
      if (loanStepForm) {
        loanStepForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(loanStepForm);
          const errorDiv = document.getElementById('loanFormError');
          errorDiv.textContent = '';

          // loan type
          const loanTypeEl = document.querySelector('input[name="loanType"]:checked');
          const loan_type = loanTypeEl ? loanTypeEl.value : null;
          // customer id (prefer preloaded read-only loanAccount)
          const customerId = (document.getElementById('loanAccount') && document.getElementById('loanAccount').value.trim())
            || (document.getElementById('loanAccountNumber') && document.getElementById('loanAccountNumber').value.trim());
          const loan_amount = formData.get('loanAmount');
          const interest_rate = formData.get('loanInterest') || formData.get('interestRate');
          const loan_term_months = formData.get('loanTenure');
          const purpose_input = formData.get('loanPurpose') || '';

          // sureties collection
          const sureties = [];
          const s1 = (document.getElementById('surety1KGID') || {}).value;
          const s2 = (document.getElementById('surety2KGID') || {}).value;
          if (s1 && s1.trim()) sureties.push(s1.trim());
          if (s2 && s2.trim()) sureties.push(s2.trim());

          // basic validation
          if (!loan_type || !customerId || !loan_amount || !interest_rate || !loan_term_months || sureties.length === 0) {
            errorDiv.textContent = "Please fill all required fields and add at least one surety.";
            return;
          }

          // build payload matching backend
          const payload = {
            loan_type,
            customer_id: customerId,
            loan_amount: Number(loan_amount),
            interest_rate: Number(interest_rate),
            loan_term_months: Number(loan_term_months),
            sureties
          };
          if (loan_type === 'normal') payload.purpose_of_loan = purpose_input;
          if (loan_type === 'emergency') payload.purpose_of_emergency_loan = purpose_input;

          try {
            const headers = { 'Content-Type': 'application/json' };
            if (window.STAFF_EMAIL) headers['X-Staff-Email'] = window.STAFF_EMAIL;
            const res = await fetch('/finance/api/apply', {
              method: 'POST',
              headers,
              credentials: 'include', // send session cookie so backend can read session['staff_email']
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=>null);
            if (res.ok && data && data.status === 'success') {
              const loanId = data.loan_id;
              // Try to fetch loan details to display staff info
              let loanDetails = null;
              try {
                const loanRes = await fetch(`/finance/api/${encodeURIComponent(loanId)}`, { credentials: 'include' });
                if (loanRes.ok) loanDetails = await loanRes.json().catch(()=>null);
              } catch {}

              const successPopup = document.getElementById('loanSuccessPopup');
              if (successPopup) {
                const popupContent = successPopup.querySelector('div.text-lg.font-bold.mb-2');
                const certLink = (data.certificate_url) ? `<a href="${data.certificate_url}" target="_blank" class="text-blue-600 underline">View Certificate</a>` : '';
                const staffInfo = loanDetails && loanDetails.staff ? `${loanDetails.staff.name || ''} ${loanDetails.staff.phone ? '('+loanDetails.staff.phone+')' : ''}` : '';
                if (popupContent) {
                  popupContent.innerHTML = `
                    Loan Application Submitted Successfully!<br>
                    <span class='text-blue-600'>Loan ID: ${loanId || 'N/A'}</span><br>
                    ${certLink ? certLink + '<br>' : ''}
                    ${staffInfo ? `<span class="text-sm text-gray-700">Processed by: ${staffInfo}</span>` : ''}
                  `;
                }
                successPopup.classList.remove('hidden');
                // Auto-close + reset
                setTimeout(() => {
                  successPopup.classList.add('hidden');
                  loanStepForm.reset();
                  step1.classList.remove('hidden');
                  step2.classList.add('hidden');
                  step3.classList.add('hidden');
                }, 3500);
              }
            } else {
              errorDiv.textContent = (data && (data.message || data.error)) || 'Loan application failed.';
            }
           } catch {
             errorDiv.textContent = 'Network error.';
           }
         });
       }
      // Fix for Get Transaction modal
      // Add event listener for Fetch button in Get Transaction modal
      const fetchTransBtn = document.getElementById('fetchTransBtn');
      const transSTIDInput = document.getElementById('transSTID');
      const transResultDiv = document.getElementById('transResult');
      const transInputPanel = document.getElementById('transInputPanel');
      const transactionModal = document.getElementById('transactionModal');
      const getTransactionBtn = document.getElementById('getTransactionBtn');

      if (fetchTransBtn) {
        fetchTransBtn.addEventListener('click', () => {
          const stid = transSTIDInput.value.trim();
          if (!stid) {
            transResultDiv.innerHTML = '<div class="text-red-600">Enter a valid STID</div>';
            return;
          }
          // Open the transaction certificate in a new tab/window
          window.open(`/staff/transaction/certificate/${encodeURIComponent(stid)}`, '_blank');
          // Optionally close the modal
          transactionModal.classList.add('hidden');
        });
        if (getTransactionBtn) {
          getTransactionBtn.addEventListener('click', () => {
            transactionModal.classList.remove('hidden');
            transInputPanel.style.display = 'block';
            transResultDiv.innerHTML = '';
            transSTIDInput.value = '';
          });
        }
      }
      const closeTransModal = document.getElementById('closeTransModal');
      if (closeTransModal && transactionModal) {
        closeTransModal.addEventListener('click', () => {
          transactionModal.classList.add('hidden');
        });
      }

      // Fix for Mail Notification modal
      const mailNotificationBtn = document.getElementById('mailNotificationBtn');
      const mailModal = document.getElementById('mailModal');
      if (mailNotificationBtn && mailModal) {
        mailNotificationBtn.addEventListener('click', () => {
          mailModal.classList.remove('hidden');
        });
      }
      // Add close button logic for mail modal
      const closeMailModal = document.getElementById('closeMailModal');
      if (closeMailModal && mailModal) {
        closeMailModal.addEventListener('click', () => {
          mailModal.classList.add('hidden');
        });
      }
    });
    // ‚úÖ Dummy Data for Apply Loan Testing
// Dummy data and fetch overrides removed. Ready for backend integration.

  </script>
</head>
  <script>
      // --- JWT heartbeat: validate every 10s and refresh token periodically ---
      const LOGIN_URL = "{{ url_for('auth.login') }}";
      function redirectToLogin() {
        try { sessionStorage.removeItem('authToken'); } catch(e) {}
        window.location.replace(LOGIN_URL);
      }
      async function validateToken() {
        let token = null;
        try { token = sessionStorage.getItem('authToken'); } catch(e) { token = null; }
        if (!token) { redirectToLogin(); return; }
        try {
          const res = await fetch('/auth/validate-token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            credentials: 'include',
            body: JSON.stringify({ token })
          });
          if (res.status === 401) { redirectToLogin(); return; }
        } catch (e) { /* network blip: let next tick retry */ }
      }
      async function refreshToken() {
        try {
          const res = await fetch('/auth/refresh-token', { method: 'POST', credentials: 'include' });
          if (res.status === 401) { redirectToLogin(); return; }
          const data = await res.json().catch(()=>null);
          if (data && data.status === 'success' && data.token) {
            try { sessionStorage.setItem('authToken', data.token); } catch(e) {}
          }
        } catch (e) {}
      }
      // Validate every 10 seconds
      validateToken();
      const vInt = setInterval(validateToken, 10000);
      // Refresh the token every 4 minutes to stay ahead of 5-min expiry
      const rInt = setInterval(refreshToken, 4 * 60 * 1000);
      // Clear token on logout click
      document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', () => { try { sessionStorage.removeItem('authToken'); } catch(e) {} });
      });
  </script>
<body class="bg-gray-50">
  <!-- Header - Updated to match landing page style -->
  <header class="w-full bg-white shadow-lg">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
  <!-- Logo -->
  <img src="{{ url_for('static', filename='society_logo.png') }}" alt="Logo" class="w-12 h-12 rounded-full border border-blue-200" />
        <span class="text-2xl font-bold text-blue-700">KSTHST coof society </span>
      </div>
      <div class="flex items-center space-x-4">
        {%- set staff_display = session.get('staff_name') or session.get('name') or session.get('email') -%}
        <span class="text-gray-700">Welcome, {{ staff_display or 'Staff' }}</span>
  <a href="{{ url_for('auth.logout') }}" id="logoutBtn" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition">Logout</a>
      </div>
    </div>
  </header>

  <div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar - Updated style -->
    <aside class="w-64 bg-white shadow-lg p-6 space-y-4">
      <h2 class="font-bold text-xl text-blue-700 mb-6">Staff Dashboard</h2>
      <nav class="space-y-3">
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200 transition-all" data-target="loanInfoSearch">üîç Loan Info Search</button>
        <button type="button" id="homeBtn" class="w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition">üè† Home</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="applyLoan">üìù Apply Loan</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="accountInfo">üë§ Customer Info</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="addUser">‚ûï Add User</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="checkExpense">üí∏ Check Expense</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="depositWithdraw">üè¶ Deposit/Withdraw</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="loanRepayment">üí∞ Loan Repayment</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="nextInstallment">üìÜ Next Installment</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="queriesSection">üì¨ Queries</button>
  <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="recentTransactionsStaff">üïí Recent Transactions</button>
        <button id="getTransactionBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition">üîé Get Transaction</button>
        <button id="mailNotificationBtn" class="w-full text-left px-4 py-2 rounded-lg bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition">üìß Mail Notification</button>
      </nav>
      <!-- Transaction Modal -->
      <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
          <h3 class="text-lg font-bold mb-4 text-blue-700">Get Transactions</h3>
          <div id="transInputPanel">
            <label class="block mb-2">STID</label>
            <input type="text" id="transSTID" class="w-full px-4 py-2 border rounded mb-3" placeholder="Enter STID" />
            <button id="fetchTransBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Fetch</button>
            <button id="closeTransModal" class="bg-gray-300 text-gray-700 px-4 py-2 rounded shadow ml-2">Close</button>
          </div>
          <div id="transResult" class="mt-4"></div>
        </div>
      </div>
      <!-- Mail Notification Modal -->
      <div id="mailModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-lg">
          <h3 class="text-lg font-bold mb-4 text-yellow-700">Mail Notifications</h3>
          <div id="mailList" class="space-y-4">
            <!-- Dummy mail notifications for testing -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
              <p class="font-semibold">Subject: Loan Application Approved</p>
              <p>To: user1@domain.com</p>
              <p>Date: 2025-08-19</p>
              <p>Message: Your loan application (ID: 123456) has been approved.</p>
            </div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-2">
              <p class="font-semibold">Subject: Payment Reminder</p>
              <p>To: user2@domain.com</p>
              <p>Date: 2025-08-18</p>
              <p>Message: Your next loan installment is due on 2025-08-25.</p>
            </div>
          </div>
          <button id="closeMailModal" class="mt-4 px-6 py-2 bg-gray-300 text-gray-700 rounded shadow">Close</button>
        </div>
      </div>
    </aside>

    <!-- Main content area - Updated style -->
    <main class="flex-1 p-8 space-y-6">
      <!-- NEW: Loan Info Search Section -->
      <section id="loanInfoSearch" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold text-purple-700 mb-4">Loan Info Search</h2>
        <form id="loanInfoSearchForm" class="flex flex-col gap-4 mb-4">
          <input type="text" id="loanInfoSearchInput" class="border px-4 py-2 rounded" placeholder="Enter Loan ID" />
          <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">Search</button>
        </form>
        <div id="loanInfoSearchResult" class="mt-4"></div>
      </section>
      <script>
      // Loan Info Search wiring for Staff Dashboard
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('loanInfoSearchForm');
        const input = document.getElementById('loanInfoSearchInput');
        const result = document.getElementById('loanInfoSearchResult');
        if (!form || !input || !result) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const val = (input.value || '').trim();
          result.innerHTML = '';
          if (!val) {
            result.innerHTML = '<div class="text-red-600">Please enter a Loan ID.</div>';
            return;
          }
          result.innerHTML = '<div class="text-blue-600">Searching...</div>';
          const url = '/admin/api/loan-info?loan_id=' + encodeURIComponent(val);
          try {
            const res = await fetch(url);
            let data = null;
            try { data = await res.json(); } catch {}
            if (res.ok && data && data.status === 'success' && data.loan_info) {
              const info = data.loan_info;
              result.innerHTML = `
                <div class="bg-gray-50 p-4 rounded shadow">
                  <div><strong>Name:</strong> ${info.name ?? '-'} </div>
                  <div><strong>Loan Amount:</strong> ‚Çπ${info.loan_amount ?? '-'} </div>
                  <div><strong>Loan Term (months):</strong> ${info.loan_term_months ?? '-'} </div>
                  <div><strong>Interest Rate:</strong> ${info.interest_rate ?? '-'}% </div>
                  <div><strong>Next Installment Amount:</strong> ‚Çπ${info.next_installment_amount ?? '-'} </div>
                  <div><strong>Outstanding Amount:</strong> ‚Çπ${info.outstanding_amount ?? '-'} </div>
                </div>
              `;
            } else {
              const msg = (data && data.message) ? data.message : 'No loan found.';
              result.innerHTML = `<div class="text-red-600">${msg}</div>`;
            }
          } catch (err) {
            result.innerHTML = '<div class="text-red-600">Network error.</div>';
          }
        });
      });
      </script>
      
      <!-- DASHBOARD SUMMARY SECTION -->
      <section id="dashboardSummary" class="dynamic-section bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold text-blue-700 mb-6">Dashboard Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="flex items-center bg-blue-100 rounded-lg p-6 shadow">
            <div class="bg-blue-500 text-white rounded-full p-4 mr-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87M12 12a4 4 0 100-8 4 4 0 000 8zm0 0v4m0 0v4m0-4h4m-4 0H8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold" id="totalCustomers">0</div>
              <div class="text-gray-700">Total Customers</div>
            </div>
          </div>
          <div class="flex items-center bg-green-100 rounded-lg p-6 shadow">
            <div class="bg-green-500 text-white rounded-full p-4 mr-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 17v-6a2 2 0 012-2h2a2 2 0 012 2v6m-6 0h6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold" id="activeLoans">0</div>
              <div class="text-gray-700">Active Loans</div>
            </div>
          </div>
          <div class="flex items-center bg-yellow-100 rounded-lg p-6 shadow">
            <div class="bg-yellow-500 text-white rounded-full p-4 mr-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 0V4m0 16v-4" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold" id="totalAmount">‚Çπ0</div>
              <div class="text-gray-700">Total Balance</div>
            </div>
          </div>
        </div>
      </section>
      <section id="applyLoan" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content space-y-8" id="applyLoanContent">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Apply for Loan</h2>
          <form id="loanStepForm" class="w-full space-y-6 bg-white p-6 rounded-xl shadow">
            <!-- Step 1: Select Loan Type -->
            <div id="step1" class="space-y-4">
              <label class="block font-semibold mb-2">Select Loan Type:</label>
              <div class="flex gap-6">
                <label class="flex items-center gap-2">
                  <input type="radio" name="loanType" value="normal" class="form-radio" required>
                  Normal Loan
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="loanType" value="emergency" class="form-radio" required>
                  Emergency Loan
                </label>
              </div>
              <button type="button" id="toStep2Btn" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded shadow">Next</button>
            </div>
            <!-- Step 2: Enter Account Number -->
            <div id="step2" class="space-y-4 hidden">
              <label class="block font-semibold mb-2">Enter Account Number:</label>
              <input type="text" id="loanAccountNumber" name="accountNumber" class="w-full px-4 py-2 border rounded" required>
              <button type="button" id="fetchAccountBtn" class="px-4 py-2 bg-blue-500 text-white rounded shadow">Fetch Details</button>
              <div id="accountFetchMsg" class="text-sm mt-2"></div>
            </div>
            <!-- Step 3: Preloaded and Manual Fields -->
            <div id="step3" class="space-y-4 hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block font-medium">Name</label>
                  <input type="text" id="loanName" name="name" class="w-full px-4 py-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                  <label class="block font-medium">Account Number</label>
                  <input type="text" id="loanAccount" name="account" class="w-full px-4 py-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                  <label class="block font-medium">KGID</label>
                  <input type="text" id="loanKGID" name="kgid" class="w-full px-4 py-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                  <label class="block font-medium">Loan Amount</label>
                  <input type="number" id="loanAmount" name="loanAmount" class="w-full px-4 py-2 border rounded" required>
                </div>
                <div>
                  <label class="block font-medium">Rate of Interest (%)</label>
                  <input type="number" id="loanInterest" name="interestRate" class="w-full px-4 py-2 border rounded" required>
                </div>
                <div>
                  <label class="block font-medium">Loan Tenure (months)</label>
                  <input type="number" id="loanTenure" name="loanTenure" class="w-full px-4 py-2 border rounded" required>
                </div>
                <div class="md:col-span-2">
                  <label class="block font-medium">Purpose of Loan</label>
                  <input type="text" id="loanPurpose" name="loanPurpose" class="w-full px-4 py-2 border rounded" required>
                </div>
              </div>
              <!-- Sureties Section -->
              <div class="mt-6">
                <label class="block font-semibold mb-2">Add Sureties (Max 2):</label>
                <div id="suretiesContainer" class="space-y-4">
                  <!-- Surety 1 -->
                  <div class="bg-gray-50 p-4 rounded-xl shadow mb-2" id="surety1Box">
                    <div class="flex gap-2 mb-2">
                      <input type="text" id="surety1KGID" placeholder="Enter Surety 1 KGID" class="px-4 py-2 border rounded flex-1" required>
                      <button type="button" id="checkSurety1Btn" class="bg-blue-500 text-white px-3 py-1 rounded">Check</button>
                      <button type="button" id="removeSurety1Btn" class="bg-red-500 text-white px-3 py-1 rounded hidden">Remove</button>
                    </div>
                    <span id="surety1Msg" class="text-sm mb-2 block"></span>
                    <div id="surety1Fields" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                  </div>
                  <!-- Surety 2 -->
                  <div class="bg-gray-50 p-4 rounded-xl shadow" id="surety2Box">
                    <div class="flex gap-2 mb-2">
                      <input type="text" id="surety2KGID" placeholder="Enter Surety 2 KGID (optional)" class="px-4 py-2 border rounded flex-1">
                      <button type="button" id="checkSurety2Btn" class="bg-blue-500 text-white px-3 py-1 rounded">Check</button>
                      <button type="button" id="removeSurety2Btn" class="bg-red-500 text-white px-3 py-1 rounded hidden">Remove</button>
                    </div>
                    <span id="surety2Msg" class="text-sm mb-2 block"></span>
                    <div id="surety2Fields" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                  </div>
                </div>
              </div>
              <!-- Terms and Conditions -->
              <div class="mt-6">
                <label class="flex items-start gap-2">
                  <input type="checkbox" id="termsCheckbox" class="mt-1" required>
                  <span>
                    We have agreed to be surety for the loan taken by the said person. We are members of the association, and if he defaults, we have given our consent to the wage payment officers to deduct 50% of our salary or share money to repay the loan.
                  </span>
                </label>
              </div>
              <!-- Error Message -->
              <div id="loanFormError" class="text-red-600 font-semibold mb-2"></div>
              <!-- Apply Button -->
              <button type="submit" id="applyLoanBtn" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded shadow w-full" disabled>Apply</button>
            </div>
          </form>
          <!-- Success Popup -->
          <div id="loanSuccessPopup" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center">
              <div class="text-green-600 text-3xl mb-4">‚úî</div>
              <div class="text-lg font-bold mb-2">Loan Application Submitted Successfully!</div>
              <button id="closeLoanSuccess" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded shadow">Close</button>
            </div>
          </div>
        </div>
      </section>
      <section id="accountInfo" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Customer Account Info</h2>
          <form id="customerSearchForm" class="mb-4 flex gap-2">
            <input type="text" id="kgidInput" placeholder="Enter Customer ID" class="border p-2 w-full rounded" />
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Search</button>
          </form>
          <div id="customerInfoResult"></div>
        </div>
      </section>

<section id="addUser" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  <div class="content">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Add New User</h2>
    <div id="addUserMsg" class="mb-4 text-center hidden"></div>
    <form id="addUserForm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Full Name -->
        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input type="text" name="name" placeholder="Full Name" class="border p-2 rounded w-full" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">KGID <span class="text-xs text-gray-500">(Optional)</span></label>
          <input type="text" name="kgid" placeholder="KGID" class="border p-2 rounded w-full" />
        </div>
        <!-- Phone & Email Row -->
        <div>
          <label class="block text-sm font-medium mb-1">Phone Number</label>
          <input type="text" name="phone" placeholder="Phone Number" class="border p-2 rounded w-full" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <div class="flex gap-2">
            <input type="email" name="email" id="emailInput" placeholder="Email" class="border p-2 rounded w-full" required />
            <button type="button" id="verifyEmailBtn" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600">
              Verify
            </button>
          </div>
        </div>
        <!-- OTP Input -->
        <div id="otpContainer" class="col-span-1 md:col-span-2 hidden">
          <label class="block text-sm font-medium mb-1">Enter OTP</label>
          <input type="text" id="otpInput" name="otp" placeholder="Enter OTP" class="border p-2 rounded w-full" />
        </div>
        <!-- More User Details -->
        <div>
          <label class="block text-sm font-medium mb-1">Father's Name</label>
          <input type="text" name="father_name" placeholder="Father's Name" class="border p-2 rounded w-full" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Salary</label>
          <input type="text" name="salary" placeholder="Salary" class="border p-2 rounded w-full" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Organization Name</label>
          <input type="text" name="organization_name" placeholder="Organization Name" class="border p-2 rounded w-full" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Aadhar Number</label>
          <input type="text" name="aadhar_no" placeholder="Aadhar Number" class="border p-2 rounded w-full" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">PAN Number</label>
          <input type="text" name="pan_no" placeholder="PAN Number" class="border p-2 rounded w-full" required />
        </div>
        <!-- Address -->
        <div class="col-span-1 md:col-span-2">
          <label class="block text-sm font-medium mb-1">Address</label>
          <textarea name="address" placeholder="Address" class="border p-2 rounded w-full" required></textarea>
        </div>
        <!-- Photo Upload -->
        <div>
          <label class="block text-sm font-medium mb-1">Upload Photo <span class="text-xs text-gray-500">(Image must be below 50KB)</span></label>
          <input type="file" name="photo" class="border p-2 rounded w-full" accept="image/*" required />
        </div>
        <!-- Signature Upload -->
        <div>
          <label class="block text-sm font-medium mb-1">Upload Signature <span class="text-xs text-gray-500">(Image must be below 50KB)</span></label>
          <input type="file" name="signature" class="border p-2 rounded w-full" accept="image/*" required />
        </div>
      </div>
      <!-- Warning Message -->
      <p id="verifyWarning" class="text-red-500 mt-2 hidden col-span-1 md:col-span-2">‚ö† Please verify your email before proceeding.</p>
      <button id="addUserBtn" type="submit" class="mt-4 px-4 py-2 bg-green-500 text-white rounded">Add User</button>
    </form>
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let emailVerified = false;
  let otpSent = false;
  let otpVerified = false;

  const verifyBtn = document.getElementById('verifyEmailBtn');
  const otpContainer = document.getElementById('otpContainer');
  const otpInput = document.getElementById('otpInput');
  const warning = document.getElementById('verifyWarning');
  const addUserBtn = document.getElementById('addUserBtn');
  const addUserForm = document.getElementById('addUserForm');
  const addUserMsg = document.getElementById('addUserMsg');
  const emailInput = document.getElementById('emailInput');

  // Send OTP to email
  verifyBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    if (!email) {
      addUserMsg.textContent = "Please enter an email.";
      return;
    }
    verifyBtn.disabled = true;
    addUserMsg.textContent = "Sending OTP...";
    try {
      const formData = new FormData();
      formData.append('email', email);
      const res = await fetch('/staff/api/add-member/send-otp', {
        method: 'POST',
        body: formData
      });
      let data;
      try {
        data = await res.json();
      } catch {
        addUserMsg.textContent = "Server error. Please check backend logs.";
        verifyBtn.disabled = false;
        return;
      }
      if (data.status === 'success') {
        otpContainer.classList.remove('hidden');
        otpInput.focus();
        addUserMsg.textContent = "OTP sent to email. Enter OTP to continue.";
        otpSent = true;
      } else {
        addUserMsg.textContent = data.message || "Failed to send OTP.";
        verifyBtn.disabled = false;
      }
    } catch (err) {
      addUserMsg.textContent = "Network error.";
      verifyBtn.disabled = false;
    }
  });

  // OTP input handler
  otpInput.addEventListener('input', () => {
    if (otpInput.value.length === 6) {
      otpVerified = true;
      otpInput.classList.add('border-green-500');
      addUserMsg.textContent = "";
    } else {
      otpVerified = false;
      otpInput.classList.remove('border-green-500');
    }
  });

  // Form submit handler
  addUserForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!otpSent || !otpVerified) {
      warning.classList.remove('hidden');
      addUserMsg.textContent = "Please verify your email and enter OTP.";
      addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
      addUserMsg.classList.remove('hidden');
      return;
    }
    warning.classList.add('hidden');
    addUserMsg.textContent = "Submitting user...";
    addUserMsg.className = "mb-4 text-center bg-blue-100 text-blue-700 px-4 py-2 rounded shadow";
    addUserMsg.classList.remove('hidden');
    const formData = new FormData(addUserForm);

    // No name combining needed, just submit as is

    try {
      const res = await fetch('/staff/api/add-member', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (data.status === 'success') {
        addUserMsg.textContent = "User added successfully!";
        addUserMsg.className = "mb-4 text-center bg-green-100 text-green-700 px-4 py-2 rounded shadow";
        addUserMsg.classList.remove('hidden');
        addUserForm.reset();
        otpContainer.classList.add('hidden');
        verifyBtn.disabled = false;
        otpSent = false;
        otpVerified = false;
      } else {
        addUserMsg.textContent = data.message || "Failed to add user.";
        addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
        addUserMsg.classList.remove('hidden');
      }
    } catch (err) {
      addUserMsg.textContent = "Network error.";
      addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
      addUserMsg.classList.remove('hidden');
    }
  });
});
</script>

      <section id="checkExpense" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  
  <!-- Header with Download Button -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-blue-700">Check Expense</h2>
    <button id="downloadReportBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
      Download Report
    </button>
  </div>

  <div class="content space-y-4">
    <!-- Transaction ID -->
    <input type="text" placeholder="Transaction ID" class="w-full border p-2 rounded" />

    <!-- Expense Fields -->
    <input type="text" placeholder="Expense Name" class="w-full border p-2 rounded" />
    <input type="number" placeholder="Amount" class="w-full border p-2 rounded" />

    <!-- From & To Date -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="date" placeholder="From Date" class="w-full border p-2 rounded" />
      <input type="date" placeholder="End Date" class="w-full border p-2 rounded" />
    </div>

    <textarea placeholder="Description" class="w-full border p-2 rounded"></textarea>

    <button class="px-4 py-2 bg-blue-500 text-white rounded">Add Expense</button>
  </div>
</section>

<script>
// Download Report Logic Placeholder
document.getElementById('downloadReportBtn').addEventListener('click', () => {
  alert("Report download functionality will be implemented here.");
});
</script>

      <section id="depositWithdraw" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  <div class="content space-y-6">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Deposit / Withdraw</h2>

    <!-- Customer Info -->
    <div id="customerInfo" class="hidden p-3 bg-gray-100 rounded border">
      <p><strong>Name:</strong> <span id="customerName">-</span></p>
      <p><strong>Current Balance:</strong> ‚Çπ<span id="customerBalance">0</span></p>
    </div>

    <!-- Toggle Buttons -->
    <div class="flex gap-2 mb-4">
      <button id="showDepositBtn" class="toggle-btn px-4 py-2 rounded shadow bg-green-500 text-white">Deposit</button>
      <button id="showWithdrawBtn" class="toggle-btn px-4 py-2 rounded shadow bg-gray-300">Withdraw</button>
    </div>

    <!-- Deposit Form -->
    <div id="depositForm" class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-lg font-semibold mb-4 text-green-700 text-center">Deposit</h3>
      <input type="text" placeholder="Customer ID" class="w-full px-4 py-2 border rounded mb-3" id="depositCustomerId" />
      <input type="number" placeholder="Amount" class="w-full px-4 py-2 border rounded mb-3" id="depositAmount" />
      <input type="date" class="w-full px-4 py-2 border rounded mb-3" id="depositDate" />
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="from Account Number" class="w-1/2 px-4 py-2 border rounded" id="depositFromAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="depositFromBank" />
      </div>
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="To Account Number" class="w-1/2 px-4 py-2 border rounded" id="depositToAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="depositToBank" />
      </div>
      <input type="text" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded mb-3" id="depositTxnId" />
      <input type="text" placeholder="Remarks" class="w-full px-4 py-2 border rounded mb-3" id="depositRemarks" />
      <button id="depositBtn" class="bg-green-500 text-white px-6 py-2 rounded w-full shadow hover:bg-green-600 transition">Deposit</button>
    </div>

    <!-- Withdraw Form -->
    <div id="withdrawForm" class="bg-white p-6 rounded-xl shadow hidden">
      <h3 class="text-lg font-semibold mb-4 text-red-700 text-center">Withdraw</h3>
      <input type="text" placeholder="Customer ID" class="w-full px-4 py-2 border rounded mb-3" id="withdrawCustomerId" />
      <input type="number" placeholder="Amount" class="w-full px-4 py-2 border rounded mb-3" id="withdrawAmount" />
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="from Account Number" class="w-1/2 px-4 py-2 border rounded" id="withdrawFromAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="withdrawFromBank" />
      </div>
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="To Account Number" class="w-1/2 px-4 py-2 border rounded" id="withdrawToAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="withdrawToBank" />
      </div>
      <input type="date" class="w-full px-4 py-2 border rounded mb-3" id="withdrawDate" />
      <input type="text" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded mb-3" id="withdrawTxnId" />
      <input type="text" placeholder="Remarks" class="w-full px-4 py-2 border rounded mb-3" id="withdrawRemarks" />
      <button id="withdrawBtn" class="bg-red-500 text-white px-6 py-2 rounded w-full shadow hover:bg-red-600 transition">Withdraw</button>
    </div>

  </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", function () {

  const depositForm = document.getElementById("depositForm");
  const withdrawForm = document.getElementById("withdrawForm");
  const depositBtnToggle = document.getElementById("showDepositBtn");
  const withdrawBtnToggle = document.getElementById("showWithdrawBtn");

  // Toggle Deposit/Withdraw
  function toggleForms(showDeposit) {
    if (showDeposit) {
      depositForm.classList.remove("hidden");
      withdrawForm.classList.add("hidden");
      depositBtnToggle.classList.add("bg-green-500", "text-white");
      depositBtnToggle.classList.remove("bg-gray-300");
      withdrawBtnToggle.classList.add("bg-gray-300");
      withdrawBtnToggle.classList.remove("bg-red-500", "text-white");
    } else {
      withdrawForm.classList.remove("hidden");
      depositForm.classList.add("hidden");
      withdrawBtnToggle.classList.add("bg-red-500", "text-white");
      withdrawBtnToggle.classList.remove("bg-gray-300");
      depositBtnToggle.classList.add("bg-gray-300");
      depositBtnToggle.classList.remove("bg-green-500", "text-white");
    }
  }

  depositBtnToggle.addEventListener("click", () => toggleForms(true));
  withdrawBtnToggle.addEventListener("click", () => toggleForms(false));

  // Deposit
  document.getElementById("depositBtn").addEventListener("click", async () => {
    const depositCustomerId = document.getElementById("depositCustomerId");
    const depositAmount = document.getElementById("depositAmount");
    const depositDate = document.getElementById("depositDate");
    const depositFromAccount = document.getElementById("depositFromAccount");
    const depositFromBank = document.getElementById("depositFromBank");
    const depositToAccount = document.getElementById("depositToAccount");
    const depositToBank = document.getElementById("depositToBank");
    const depositTxnId = document.getElementById("depositTxnId");
    const depositRemarks = document.getElementById("depositRemarks");

    if (
      !depositCustomerId || !depositAmount || !depositDate ||
      !depositFromAccount || !depositFromBank ||
      !depositToAccount || !depositToBank || !depositTxnId
    ) {
      alert("Form error: Some fields are missing in the DOM.");
      return;
    }

    const depositData = {
      customer_id: depositCustomerId.value.trim(),
      amount: depositAmount.value.trim(),
      date: depositDate.value.trim(),
      from_account: depositFromAccount.value.trim(),
      from_bank_name: depositFromBank.value.trim(),
      to_account: depositToAccount.value.trim(),
      to_bank_name: depositToBank.value.trim(),
      transaction_id: depositTxnId.value.trim(),
      remarks: depositRemarks ? depositRemarks.value.trim() : "",
      type: "deposit"
    };

    if (Object.values(depositData).some(v => v === "")) {
      alert("Please fill all Deposit fields.");
      return;
    }

    try {
      const formData = new FormData();
      for (const key in depositData) {
        formData.append(key, depositData[key]);
      }
      const res = await fetch('/staff/api/add-transaction', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (res.ok && data.status === "success" && data.transaction && data.transaction.stid) {
        // Open the receipt in the required format
        const stid = data.transaction.stid;
        const receiptUrl = `/staff/transaction/certificate/${encodeURIComponent(stid)}?action=view`;
        window.open(receiptUrl, '_blank');
        alert("Deposit successful!");
      } else {
        alert(data.message || "Deposit failed.");
      }
    } catch (err) {
      alert("Network error.");
    }
  });

  // Withdraw
  document.getElementById("withdrawBtn").addEventListener("click", async () => {
    const withdrawCustomerId = document.getElementById("withdrawCustomerId");
    const withdrawAmount = document.getElementById("withdrawAmount");
    const withdrawDate = document.getElementById("withdrawDate");
    const withdrawFromAccount = document.getElementById("withdrawFromAccount");
    const withdrawFromBank = document.getElementById("withdrawFromBank");
    const withdrawToAccount = document.getElementById("withdrawToAccount");
    const withdrawToBank = document.getElementById("withdrawToBank");
    const withdrawTxnId = document.getElementById("withdrawTxnId");
    const withdrawRemarks = document.getElementById("withdrawRemarks");

    if (
      !withdrawCustomerId || !withdrawAmount || !withdrawDate ||
      !withdrawFromAccount || !withdrawFromBank ||
      !withdrawToAccount || !withdrawToBank || !withdrawTxnId
    ) {
      alert("Form error: Some fields are missing in the DOM.");
      return;
    }

    const withdrawData = {
      customer_id: withdrawCustomerId.value.trim(),
      amount: withdrawAmount.value.trim(),
      date: withdrawDate.value.trim(),
      from_account: withdrawFromAccount.value.trim(),
      from_bank_name: withdrawFromBank.value.trim(),
      to_account: withdrawToAccount.value.trim(),
      to_bank_name: withdrawToBank.value.trim(),
      transaction_id: withdrawTxnId.value.trim(),
      remarks: withdrawRemarks ? withdrawRemarks.value.trim() : "",
      type: "withdraw"
    };

    if (Object.values(withdrawData).some(v => v === "")) {
      alert("Please fill all Withdraw fields.");
      return;
    }

    try {
      const formData = new FormData();
      for (const key in withdrawData) {
        formData.append(key, withdrawData[key]);
      }
      const res = await fetch('/staff/api/add-transaction', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (res.ok && data.status === "success" && data.transaction && data.transaction.stid) {
        const stid = data.transaction.stid;
        const receiptUrl = `/staff/transaction/certificate/${encodeURIComponent(stid)}?action=view`;
        window.open(receiptUrl, '_blank');
        alert("Withdrawal successful!");
      } else {
        alert(data.message || "Withdrawal failed.");
      }
    } catch (err) {
      alert("Network error.");
    }
  });

  // Civil Score logic
  const checkCivilBtn = document.getElementById('checkCivil');
  const civilInput = document.getElementById('civilInput');
  const civilResult = document.getElementById('civilResult');
  if (checkCivilBtn && civilInput && civilResult) {
    // mark this binding so other scripts don't attach a duplicate listener
    if (!checkCivilBtn.dataset.wired) {
      checkCivilBtn.addEventListener('click', async () => {
      const val = civilInput.value.trim();
      civilResult.textContent = '';
      if (!val) {
        civilResult.textContent = "Please enter Customer ID or KGID.";
        civilResult.className = "mt-3 text-center text-red-600";
        return;
      }
      civilResult.textContent = "Checking...";
      civilResult.className = "mt-3 text-center text-blue-700";
      try {
          const res = await fetch(`/api/check-civil-score?customer_id=${encodeURIComponent(val)}`);
        const data = await res.json();
        if (res.ok && data.status === "success") {
          // API returns { status, score, message, details }
          const overall = data.score || data.score === 0 ? data.score : 'Unknown';
          civilResult.textContent = `Civil Score for ${val}: ${overall}`;
          civilResult.className = "mt-3 text-center text-green-700 font-bold";
          // Optionally show details (first item) below
          if (Array.isArray(data.details) && data.details.length > 0) {
            const first = data.details[0];
            const detailsText = `\n${first.loan_id || ''}: ${first.score || first.message || ''}`;
            const detailsNode = document.createElement('div');
            detailsNode.className = 'text-sm mt-2 text-gray-700';
            detailsNode.textContent = detailsText;
            // clear any previous extra node
            const existing = civilResult.nextElementSibling;
            if (existing && existing.classList && existing.classList.contains('civil-details')) existing.remove();
            detailsNode.classList.add('civil-details');
            civilResult.insertAdjacentElement('afterend', detailsNode);
          }
        } else {
          civilResult.textContent = data.message || "Not found.";
          civilResult.className = "mt-3 text-center text-red-600";
        }
      } catch {
        civilResult.textContent = "Network error.";
        civilResult.className = "mt-3 text-center text-red-600";
      }
      });
      checkCivilBtn.dataset.wired = '1';
    }
  }
});
</script>
      <section id="loanRepayment" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Loan Repayment</h2>
          <!-- Search Type Selection -->
          <div class="mb-4">
            <label class="font-semibold mr-2">Search By:</label>
            <select id="loanSearchType" class="border p-2 rounded">
              <option value="loanId">Loan ID</option>
              <option value="accountNumber">Account Number</option>
            </select>
          </div>
          <!-- Search Bar -->
          <form id="loanSearchForm" class="mb-4 flex gap-2">
            <input type="text" id="loanSearchInput" placeholder="Enter Loan ID or Account Number" class="border p-2 w-full rounded" />
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Search</button>
          </form>
          <!-- Loan Info Result -->
          <div id="loanInfoResult"></div>
          <!-- Auto Transaction Form -->
          <div id="autoTransactionFormContainer" class="mt-6"></div>
        </div>
      </section>
      <script>
      // Loan Repayment section search logic
      document.addEventListener('DOMContentLoaded', () => {
        const loanSearchForm = document.getElementById('loanSearchForm');
        const loanSearchInput = document.getElementById('loanSearchInput');
        const loanSearchType = document.getElementById('loanSearchType');
        const loanInfoResult = document.getElementById('loanInfoResult');
        const autoTransactionFormContainer = document.getElementById('autoTransactionFormContainer');
        const loanRepaymentSection = document.getElementById('loanRepayment');

        if (loanSearchForm && loanSearchInput && loanSearchType && loanInfoResult) {
          loanSearchForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            // Ensure Loan Repayment section stays visible
            document.querySelectorAll('.dynamic-section').forEach(sec => sec.classList.add('hidden'));
            loanRepaymentSection.classList.remove('hidden');
            // Loader
            loanInfoResult.innerHTML = '<div class="text-blue-600">Loading...</div>';
            autoTransactionFormContainer.innerHTML = '';
            const searchVal = loanSearchInput.value.trim();
            const searchBy = loanSearchType.value;
            if (!searchVal) {
              loanInfoResult.innerHTML = '<div class="text-red-600">Please enter a value.</div>';
              return;
            }
            try {
              let loanData = null;
              if (searchBy === 'loanId') {
                const res = await fetch(`/finance/${encodeURIComponent(searchVal)}`);
                if (!res.ok) throw new Error('Loan not found');
                const data = await res.json();
                if (data && data.status === 'success' && data.loan) {
                  loanData = data.loan;
                } else {
                  throw new Error(data.message || 'Loan not found');
                }
              } else {
                // accountNumber
                const res = await fetch(`/finance/api/fetch_customer_details?customer_id=${encodeURIComponent(searchVal)}`);
                if (!res.ok) throw new Error('Customer not found');
                const data = await res.json();
                if (data && data.status === 'success' && data.loans && data.loans.length > 0) {
                  loanData = data.loans[0];
                } else {
                  throw new Error(data.message || 'No loans found');
                }
              }
              // Render loan info
              loanInfoResult.innerHTML = `
                <div class="bg-gray-50 p-4 rounded shadow mb-4">
                  <div><strong>Loan ID:</strong> ${loanData.loan_id || '-'}</div>
                  <div><strong>Customer ID:</strong> ${loanData.customer_id || '-'}</div>
                  <div><strong>Loan Type:</strong> ${loanData.loan_type || '-'}</div>
                  <div><strong>Amount:</strong> ‚Çπ${Number(loanData.loan_amount || 0).toLocaleString()}</div>
                  <div><strong>Interest Rate:</strong> ${loanData.interest_rate || '-'}%</div>
                  <div><strong>Term:</strong> ${loanData.loan_term_months || '-'} months</div>
                  <div><strong>Status:</strong> ${loanData.status || '-'}</div>
                </div>
              `;
              // Optionally, render auto transaction form here if needed
              autoTransactionFormContainer.innerHTML = '';
            } catch (err) {
              loanInfoResult.innerHTML = `<div class="text-red-600">${err.message}</div>`;
            }
          });
        }
      });
      </script>
      <!-- Recent Transactions (Staff) -->
      <section id="recentTransactionsStaff" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-blue-700">Recent Transactions</h2>
            <div class="flex items-center gap-2">
              <label for="rtYearStaff" class="text-sm text-gray-600">Year</label>
              <select id="rtYearStaff" class="px-3 py-1 border rounded-lg"></select>
              <label for="rtMonthStaff" class="text-sm text-gray-600">Month</label>
              <select id="rtMonthStaff" class="px-3 py-1 border rounded-lg"></select>
              <label for="rtDayStaff" class="text-sm text-gray-600">Day</label>
              <select id="rtDayStaff" class="px-3 py-1 border rounded-lg"></select>
              <button id="rtFilterBtnStaff" class="px-3 py-1 rounded-lg bg-blue-600 text-white">Filter</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ref</th>
                </tr>
              </thead>
              <tbody id="rtTableBodyStaff" class="bg-white divide-y divide-gray-200">
                <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No data</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <script>
      // Staff Recent Transactions wiring
      document.addEventListener('DOMContentLoaded', () => {
        const ySel = document.getElementById('rtYearStaff');
        const mSel = document.getElementById('rtMonthStaff');
        const dSel = document.getElementById('rtDayStaff');
        const btn = document.getElementById('rtFilterBtnStaff');
        const body = document.getElementById('rtTableBodyStaff');

        function populateSelectors() {
          if (!ySel || !mSel || !dSel) return;
          const now = new Date();
          const cy = now.getFullYear();
          const cm = now.getMonth() + 1;
          const cd = now.getDate();
          const years = [];
          for (let y = cy; y >= cy - 5; y--) years.push(y);
          ySel.innerHTML = ['<option value="">All</option>'].concat(years.map(y => `<option value="${y}">${y}</option>`)).join('');
          ySel.value = String(cy);
          const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          mSel.innerHTML = ['<option value="">All</option>'].concat(monthNames.map((n,i) => `<option value="${i+1}">${n}</option>`)).join('');
          mSel.value = String(cm);
          const days = Array.from({length: 31}, (_,i) => i+1);
          dSel.innerHTML = ['<option value="">All</option>'].concat(days.map(d => `<option value="${d}">${d}</option>`)).join('');
          dSel.value = String(cd);
        }

        async function loadRecent() {
          if (!body) return;
          body.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>';
          try {
            const qs = new URLSearchParams();
            if (ySel && ySel.value) qs.set('year', ySel.value);
            if (mSel && mSel.value) qs.set('month', mSel.value);
            if (dSel && dSel.value) qs.set('day', dSel.value);
            const res = await fetch(`/admin/api/recent-transactions${qs.toString() ? ('?' + qs.toString()) : ''}`);
            const data = await res.json();
            if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
            const events = data.events || [];
            if (!events.length) {
              body.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No data</td></tr>';
              return;
            }
            body.innerHTML = events.map(ev => `
              <tr>
                <td class="px-4 py-2">${ev.date ? new Date(ev.date).toLocaleString() : '-'}</td>
                <td class="px-4 py-2">${ev.type || '-'}</td>
                <td class="px-4 py-2">‚Çπ${Number(ev.amount || 0).toLocaleString()}</td>
                <td class="px-4 py-2">${ev.details || '-'}</td>
                <td class="px-4 py-2">${ev.ref_id || '-'}</td>
              </tr>
            `).join('');
          } catch (e) {
            console.error('Recent transactions (staff) load failed:', e);
            body.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-600">Failed to load</td></tr>';
          }
        }

        populateSelectors();
        if (btn) btn.addEventListener('click', loadRecent);
        // Auto-load when navigating to section
        const navBtn = document.querySelector('.nav-button[data-target="recentTransactionsStaff"]');
        if (navBtn) navBtn.addEventListener('click', loadRecent);
      });
      </script>
      <section id="queriesSection" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Queries</h2>
        <div id="queriesMsg" class="mb-4"></div>
        <div class="overflow-x-auto">
          <table id="queriesTable" class="min-w-full table-auto border-collapse">
            <thead>
              <tr class="bg-gray-100 text-left">
                <th class="px-4 py-2">#</th>
                <th class="px-4 py-2">Name</th>
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Phone</th>
                <th class="px-4 py-2">KGID / Customer ID</th>
                <th class="px-4 py-2">Description</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="queriesTbody">
              <!-- Rows populated by JS -->
            </tbody>
          </table>
        </div>
      </section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Next Installment functionality
  const nextInstallmentSection = document.getElementById('nextInstallment');
  if (nextInstallmentSection) {
    const searchBtn = document.getElementById('nextInstallmentSearchBtn');
    const searchInput = document.getElementById('nextInstallmentAccount');
    const loanAmountEl = document.getElementById('loanAmount');
    const paidAmountEl = document.getElementById('paidAmount');
    const remainingAmountEl = document.getElementById('remainingAmount');
    const nextMonthAmountEl = document.getElementById('nextMonthAmount');
    if (searchBtn && searchInput && loanAmountEl && paidAmountEl && remainingAmountEl && nextMonthAmountEl) {
      searchBtn.addEventListener('click', async () => {
        nextInstallmentSection.querySelector('.error-msg')?.remove();
        const account = searchInput.value.trim();
        if (!account) {
          const err = document.createElement('div');
          err.className = 'error-msg text-red-600 mb-2';
          err.textContent = 'Please enter a valid account number.';
          nextInstallmentSection.prepend(err);
          loanAmountEl.textContent = '-';
          paidAmountEl.textContent = '-';
          remainingAmountEl.textContent = '-';
          nextMonthAmountEl.textContent = '-';
          return;
        }
        loanAmountEl.textContent = 'Loading...';
        paidAmountEl.textContent = 'Loading...';
        remainingAmountEl.textContent = 'Loading...';
        nextMonthAmountEl.textContent = 'Loading...';
        try {
          // Try top-level API first, then the blueprint-prefixed path as a fallback.
          const tryUrls = [
            `/api/next-installment?account=${encodeURIComponent(account)}`,
            `/loan/api/next-installment?loan_id=${encodeURIComponent(account)}`
          ];
          let data = null;
          for (const url of tryUrls) {
            try {
              const res = await fetch(url);
              if (!res.ok) continue; // try next
              data = await res.json();
              break;
            } catch (e) {
              // network error - try next URL
              continue;
            }
          }
          if (!data) {
            throw new Error('Failed to fetch from all endpoints');
          }
          const loanIdentifierEl = document.getElementById('loanIdentifier');
          if (loanIdentifierEl) {
            loanIdentifierEl.textContent = data.loan_id || data.customer_id || data.account || '-';
          }
          loanAmountEl.textContent = data.loanAmount ? `‚Çπ${Number(data.loanAmount).toLocaleString()}` : '-';
          paidAmountEl.textContent = data.paidAmount ? `‚Çπ${Number(data.paidAmount).toLocaleString()}` : '-';
          remainingAmountEl.textContent = data.remainingAmount ? `‚Çπ${Number(data.remainingAmount).toLocaleString()}` : '-';
          nextMonthAmountEl.textContent = data.nextMonthAmount ? `‚Çπ${Number(data.nextMonthAmount).toLocaleString()}` : '-';
        } catch (err) {
          const e = document.createElement('div');
          e.className = 'error-msg text-red-600 mb-2';
          e.textContent = 'Error fetching installment details.';
          nextInstallmentSection.prepend(e);
          loanAmountEl.textContent = '-';
          paidAmountEl.textContent = '-';
          remainingAmountEl.textContent = '-';
          nextMonthAmountEl.textContent = '-';
        }
      });
    }
  }
});
</script>
  </div>

  
  <!-- Floating Civil Score Button -->
  <button id="civilBtn" class="fixed bottom-20 right-6 bg-green-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-green-700">
    üìä Civil Score
  </button>

  <!-- Floating Civil Score Box -->
  <div id="civilBox" class="floating-box hidden fixed bottom-36 right-6 w-80 bg-white rounded-xl shadow-2xl p-4 z-50">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-bold">Check Civil Score</h3>
      <button id="closeCivil" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <!-- Add id for input and result display -->
    <input id="civilInput" class="w-full mb-3 px-4 py-2 border rounded" placeholder="Enter Customer ID or KGID Number">
    <button id="checkCivil" class="bg-green-600 text-white px-6 py-2 rounded w-full hover:bg-green-700">Check Now</button>
    <div id="civilResult" class="mt-3 text-center text-blue-700"></div>
  </div>
  
  <script src="{{ url_for('static', filename='shared.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize shared floating boxes if the external script loaded
      if (typeof initializeFloatingBoxes === 'function') {
        initializeFloatingBoxes();
      }
      // Fallback: ensure Civil Score floating button works even if shared.js failed to load
      try {
        const civilBtnEl = document.getElementById('civilBtn');
        const civilBoxEl = document.getElementById('civilBox');
        const closeCivilEl = document.getElementById('closeCivil');
        if (civilBtnEl && civilBoxEl) {
          // avoid duplicate listeners by checking a marker
          if (!civilBtnEl.dataset.wired) {
            civilBtnEl.addEventListener('click', () => {
              civilBoxEl.classList.toggle('hidden');
              civilBoxEl.classList.toggle('show');
            });
            civilBtnEl.dataset.wired = '1';
          }
        }
        if (closeCivilEl && civilBoxEl && !closeCivilEl.dataset.wired) {
          closeCivilEl.addEventListener('click', () => {
            civilBoxEl.classList.add('hidden');
            civilBoxEl.classList.remove('show');
          });
          closeCivilEl.dataset.wired = '1';
        }
      } catch (e) {
        // silently ignore in-browser errors
      }
      // Civil Score logic
      const checkCivilBtn = document.getElementById('checkCivil');
      const civilInput = document.getElementById('civilInput');
      const civilResult = document.getElementById('civilResult');
      if (checkCivilBtn && civilInput && civilResult) {
        // do not add a second listener if the main script already wired it
        if (!checkCivilBtn.dataset.wired) {
          checkCivilBtn.addEventListener('click', async () => {
            const val = civilInput.value.trim();
            civilResult.textContent = '';
            if (!val) {
              civilResult.textContent = "Please enter Customer ID or KGID.";
              civilResult.className = "mt-3 text-center text-red-600";
              return;
            }
            civilResult.textContent = "Checking...";
            civilResult.className = "mt-3 text-center text-blue-700";
            try {
              const res = await fetch(`/api/check-civil-score?customer_id=${encodeURIComponent(val)}`);
              const data = await res.json();
              if (res.ok && data.status === "success") {
                const overall = data.score || data.score === 0 ? data.score : 'Unknown';
                civilResult.textContent = `Civil Score for ${val}: ${overall}`;
                civilResult.className = "mt-3 text-center text-green-700 font-bold";
              } else {
                civilResult.textContent = data.message || "Not found.";
                civilResult.className = "mt-3 text-center text-red-600";
              }
            } catch {
              civilResult.textContent = "Network error.";
              civilResult.className = "mt-3 text-center text-red-600";
            }
          });
          checkCivilBtn.dataset.wired = '1';
        }
      }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const queriesTbody = document.getElementById('queriesTbody');
      const queriesMsg = document.getElementById('queriesMsg');
      const queriesNavBtn = document.querySelector('[data-target="queriesSection"]');

      async function fetchQueries() {
        if (!queriesTbody) return;
        queriesMsg.textContent = '';
        queriesTbody.innerHTML = '<tr><td colspan="8" class="px-4 py-2">Loading...</td></tr>';
        try {
          const res = await fetch('/api/queries');
          if (!res.ok) throw new Error('Network error');
          const payload = await res.json();
          if (payload.status !== 'success') throw new Error(payload.message || 'Failed to load');
          renderQueries(payload.data || []);
        } catch (err) {
          queriesTbody.innerHTML = '<tr><td colspan="8" class="px-4 py-2 text-red-600">Error loading queries.</td></tr>';
          queriesMsg.textContent = err.message || String(err);
          queriesMsg.className = 'text-red-600';
        }
      }

      function renderQueries(list) {
        if (!queriesTbody) return;
        if (!Array.isArray(list) || list.length === 0) {
          queriesTbody.innerHTML = '<tr><td colspan="8" class="px-4 py-2">No queries found.</td></tr>';
          return;
        }
        const rows = list.map((q, idx) => {
          const id = q.id || '';
          const name = q.name || '';
          const email = q.email || '';
          const phone = q.phone || '';
          const ident = q.kgid || q.customer_id || '';
          const desc = (q.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const status = q.status || 'open';
          const created = q.created_at ? new Date(q.created_at).toLocaleString() : '';
          const actionBtn = status === 'solved' ?
            `<button class="px-3 py-1 bg-gray-300 text-gray-700 rounded" disabled>Solved</button>` :
            `<button data-id="${id}" class="markSolvedBtn px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Mark Solved</button>`;
          return `
            <tr class="border-t">
              <td class="px-4 py-2 align-top">${idx + 1}</td>
              <td class="px-4 py-2 align-top">${name}</td>
              <td class="px-4 py-2 align-top">${email}</td>
              <td class="px-4 py-2 align-top">${phone}</td>
              <td class="px-4 py-2 align-top">${ident}</td>
              <td class="px-4 py-2 align-top"><div title="${created}">${desc}</div></td>
              <td class="px-4 py-2 align-top">${status}</td>
              <td class="px-4 py-2 align-top">${actionBtn}</td>
            </tr>`;
        }).join('\n');
        queriesTbody.innerHTML = rows;
        // attach handlers
        document.querySelectorAll('.markSolvedBtn').forEach(btn => {
          if (btn.dataset.wired) return;
          btn.addEventListener('click', async (e) => {
            const qid = btn.getAttribute('data-id');
            if (!qid) return;
            btn.disabled = true;
            btn.textContent = 'Marking...';
            try {
              const res = await fetch(`/api/queries/${qid}/mark-solved`, { method: 'POST' });
              const data = await res.json();
              if (res.ok && data.status === 'success') {
                fetchQueries();
              } else {
                alert(data.message || 'Failed to mark solved');
                btn.disabled = false;
                btn.textContent = 'Mark Solved';
              }
            } catch (err) {
              alert('Network error');
              btn.disabled = false;
              btn.textContent = 'Mark Solved';
            }
          });
          btn.dataset.wired = '1';
        });
      }

      // fetch when Queries nav is clicked
      if (queriesNavBtn) {
        queriesNavBtn.addEventListener('click', () => {
          // small delay to allow section to become visible
          setTimeout(fetchQueries, 150);
        });
      }
      // also fetch on load so numbers are available
      fetchQueries();
    });
  </script>
</body>
</html>
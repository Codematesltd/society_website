<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loan Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .floating-box {
      transform: translateY(100%);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }
    .floating-box.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Fix: Always show the correct section when clicking sidebar nav buttons
      const sections = document.querySelectorAll('.dynamic-section');
      const buttons = document.querySelectorAll('.nav-button');
      const homeBtn = document.getElementById('homeBtn');

      function showSection(sectionId) {
        sections.forEach(sec => sec.classList.add('hidden'));
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.remove('hidden');
          // Always show content for loanRepayment (no loader)
          if (sectionId === 'loanRepayment') {
            const content = section.querySelector('.content');
            if (content) content.classList.remove('hidden');
            const loader = section.querySelector('.loader');
            if (loader) loader.classList.add('hidden');
          } else {
            const content = section.querySelector('.content');
            const loader = section.querySelector('.loader');
            if (content && loader) {
              content.classList.add('hidden');
              loader.classList.remove('hidden');
              setTimeout(() => {
                loader.classList.add('hidden');
                content.classList.remove('hidden');
              }, 400);
            } else if (content) {
              content.classList.remove('hidden');
            }
          }
        }
      }

      // Sidebar nav buttons
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          showSection(btn.dataset.target);
        });
      });

      // Home button always shows dashboard summary
      if (homeBtn) {
        homeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          showSection('dashboardSummary');
        });
      }

      // Show dashboard summary by default on page load
      showSection('dashboardSummary');

      // Fetch dashboard stats (replace with real API call)
      function fetchDashboardStats() {
        // Simulated data; replace with fetch('/api/dashboard-stats')...
        const stats = {
          totalCustomers: 1234,
          activeLoans: 87,
          totalAmount: 12500000
        };
        document.getElementById('totalCustomers').textContent = stats.totalCustomers;
        document.getElementById('activeLoans').textContent = stats.activeLoans;
        document.getElementById('totalAmount').textContent = '‚Çπ' + stats.totalAmount.toLocaleString();
      }
      fetchDashboardStats();

      // Customer Account Info search logic
      const form = document.getElementById('customerSearchForm');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const customerId = document.getElementById('kgidInput').value.trim();
          const resultDiv = document.getElementById('customerInfoResult');
          resultDiv.innerHTML = '<div class="text-blue-600">Loading...</div>';
          try {
            // fetch by customer_id
            const res = await fetch(`/finance/api/fetch-account?customer_id=${encodeURIComponent(customerId)}`);
            if (res.ok) {
              const data = await res.json();
              if (data.status === "success") {
                // map API response into renderCustomerInfo format
                const member = {
                  name: data.name,
                  kgid: data.kgid,
                  phone: data.phone,
                  email: "",     // not returned by this API
                  address: ""    // not returned by this API
                };
                resultDiv.innerHTML = renderCustomerInfo(member, false);
                attachEditHandler(member);
              } else {
                resultDiv.innerHTML = `<div class="text-red-600 font-semibold mb-4">${data.message}</div>`;
              }
            } else {
              resultDiv.innerHTML = `<div class="text-red-600">Error fetching data.</div>`;
            }
          } catch {
            resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
          }
        });
      }

      let editing = false;
      let currentData = null;

      function renderCustomerInfo(data, editable) {
        if (!editable) {
          return `
            <div class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
              <div class="mb-4">
                <p><strong>Name:</strong> ${data.name}</p>
                <p><strong>KGID:</strong> ${data.kgid}</p>
                <p><strong>Phone:</strong> ${data.phone}</p>
                <p><strong>Email:</strong> ${data.email}</p>
                <p><strong>Address:</strong> ${data.address}</p>
              </div>
              <button id="editProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Edit Profile</button>
            </div>
          `;
        } else {
          return `
            <form id="editProfileForm" class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
              <div class="mb-4">
                <label class="block mb-1 font-medium">Name</label>
                <input type="text" name="name" value="${data.name}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">KGID</label>
                <input type="text" name="kgid" value="${data.kgid}" class="w-full px-4 py-2 border rounded mb-2" disabled />
                <label class="block mb-1 font-medium">Phone</label>
                <input type="text" name="phone" value="${data.phone}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">Email</label>
                <input type="email" name="email" value="${data.email}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">Address</label>
                <input type="text" name="address" value="${data.address}" class="w-full px-4 py-2 border rounded mb-2" />
              </div>
              <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded shadow">Update</button>
            </form>
          `;
        }
      }

      function attachEditHandler(data) {
        const editBtn = document.getElementById('editProfileBtn');
        if (editBtn) {
          editBtn.onclick = function() {
            editing = true;
            const resultDiv = document.getElementById('customerInfoResult');
            resultDiv.innerHTML = renderCustomerInfo(data, true);
            attachUpdateHandler();
          };
        }
      }

      function attachUpdateHandler() {
        const editForm = document.getElementById('editProfileForm');
        if (editForm) {
          editForm.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(editForm);
            const updatedData = {
              name: formData.get('name'),
              kgid: formData.get('kgid'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address')
            };
            const resultDiv = document.getElementById('customerInfoResult');
            resultDiv.innerHTML = '<div class="text-blue-600">Updating...</div>';
            try {
              const res = await fetch(`/api/customer/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
              });
              if (res.ok) {
                resultDiv.innerHTML = renderCustomerInfo(updatedData, false);
                attachEditHandler(updatedData);
              } else {
                resultDiv.innerHTML = `<div class="text-red-600">Update failed.</div>`;
              }
            } catch {
              resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
            }
          };
        }
      }

      // --- Fix for Apply Loan step navigation ---
      // Move step2 to visible when clicking Next in step1
      const toStep2Btn = document.getElementById('toStep2Btn');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const loanFormError = document.getElementById('loanFormError');

      if (toStep2Btn && step1 && step2) {
        toStep2Btn.addEventListener('click', function () {
          const selectedLoanType = document.querySelector('input[name="loanType"]:checked');
          if (!selectedLoanType) {
            if (loanFormError) loanFormError.textContent = "Please select a loan type.";
            return;
          }
          if (loanFormError) loanFormError.textContent = "";
          step1.classList.add('hidden');
          step2.classList.remove('hidden');
          // Hide step3 in case user is retrying
          if (step3) step3.classList.add('hidden');
        });
      }

      // Fetch customer data for loan application (dummy implementation)
      const loanAccountNumberInput = document.getElementById('loanAccountNumber');
      const fetchAccountBtn = document.getElementById('fetchAccountBtn');
      const accountFetchMsg = document.getElementById('accountFetchMsg');

      if (fetchAccountBtn) {
        fetchAccountBtn.addEventListener('click', async () => {
          const customerId = loanAccountNumberInput.value.trim();
          if (!customerId) {
            accountFetchMsg.textContent = "Please enter a customer ID.";
            return;
          }
          accountFetchMsg.textContent = "Fetching details...";
          try {
            // changed to staff API
            const res = await fetch(`/staff/api/fetch-account?customer_id=${encodeURIComponent(customerId)}`);
            if (res.ok) {
              const data = await res.json();
              if (data && data.status === "success" && data.name) {
                document.getElementById('loanName').value = data.name;
                document.getElementById('loanKGID').value = data.kgid || '';
                document.getElementById('loanAccount').value = data.customer_id || customerId;
                loanAccountNumberInput.value = data.customer_id || customerId;
                accountFetchMsg.textContent = "";
                // Hide Next button after fetching account details
                const nextBtn = document.getElementById('toStep2Btn');
                if (nextBtn) nextBtn.classList.add('hidden');
                // Show step 3 and loan type if not already visible
                if (step3.classList.contains('hidden')) {
                  step3.classList.remove('hidden');
                  step2.classList.add('hidden');
                  document.getElementById('step1').classList.remove('hidden');
                }
              } else {
                accountFetchMsg.textContent = "Account not found.";
              }
            } else {
              accountFetchMsg.textContent = "Error fetching account details.";
            }
          } catch {
            accountFetchMsg.textContent = "Network error.";
          }
        });
      }

      // Surety check logic (dummy implementation)
      function setupSuretyCheck(suretyBtnId, suretyKGIDInputId, suretyMsgId) {
        const checkBtn = document.getElementById(suretyBtnId);
        const kgidInput = document.getElementById(suretyKGIDInputId);
        const msgDiv = document.getElementById(suretyMsgId);
        const removeBtn = document.getElementById(suretyBtnId.replace('check', 'remove'));

        function preloadSurety(data) {
          const fieldsDiv = document.getElementById(
            suretyBtnId === 'checkSurety1Btn' ? 'surety1Fields' : 'surety2Fields'
          );
          fieldsDiv.innerHTML = '';
          if (data.available) {
            msgDiv.textContent = '';
            fieldsDiv.innerHTML = `
              <div><label class="block font-medium mb-1">KGID</label>
                   <input type="text" value="${kgidInput.value}" readonly class="w-full px-4 py-2 border rounded bg-gray-100"/>
              </div>
              <div><label class="block font-medium mb-1">Name</label>
                   <input type="text" value="${data.member.name}" readonly class="w-full px-4 py-2 border rounded bg-gray-100"/>
              </div>
              <div><label class="block font-medium mb-1">Phone</label>
                   <input type="text" value="${data.member.phone}" readonly class="w-full px-4 py-2 border rounded bg-gray-100"/>
              </div>`;
          } else if (data.active_loan_count >= 2) {
            msgDiv.textContent = "This surety is already backing 2 active loans.";
          } else {
            msgDiv.textContent = data.reason || "Surety not found.";
          }
        }

        if (checkBtn) {
          checkBtn.addEventListener('click', async () => {
            const kgid = kgidInput.value.trim();
            msgDiv.textContent = "Checking surety...";
            try {
              // UPDATED: use customer_id query param and return object that matches preloadSurety
              const res = await fetch(`/finance/api/check-surety?customer_id=${encodeURIComponent(kgid)}`);
              if (res.ok) {
                const data = await res.json();
                // Build object with properties preloadSurety expects
                const suretyObj = {
                  available: !!data.available,
                  member: data.member || {},
                  active_loan_count: data.active_loan_count || 0
                };
                preloadSurety(suretyObj);
                // Enable UI only when available and active_loan_count < 2
                if (suretyObj.available && suretyObj.active_loan_count < 2) {
                  checkBtn.disabled = true;
                  kgidInput.disabled = true;
                  if (removeBtn) removeBtn.classList.remove('hidden');
                }
              } else {
                msgDiv.textContent = "Error checking surety.";
              }
            } catch {
              msgDiv.textContent = "Network error.";
            }
          });
        }
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            msgDiv.textContent = "";
            kgidInput.value = "";
            kgidInput.disabled = false;
            checkBtn.disabled = false;
            removeBtn.classList.add('hidden');
          });
        }
      }

      setupSuretyCheck('checkSurety1Btn', 'surety1KGID', 'surety1Msg');
      setupSuretyCheck('checkSurety2Btn', 'surety2KGID', 'surety2Msg');

      // Terms and conditions toggle (for demo, auto-checking)
      // Terms and conditions: keep enabled and required, do not auto-check
      const termsCheckbox = document.getElementById('termsCheckbox');
      const applyLoanBtn = document.getElementById('applyLoanBtn');
      if (termsCheckbox && applyLoanBtn) {
        termsCheckbox.checked = false;
        termsCheckbox.disabled = false;
        termsCheckbox.required = true;
        // Helper to check if all required fields are filled
        function checkFormReady() {
          const requiredIds = [
            'loanName', 'loanAccount', 'loanKGID', 'loanAmount', 'loanInterest', 'loanTenure', 'loanPurpose',
            'surety1KGID', 'surety2KGID'
          ];
          let allFilled = requiredIds.every(id => {
            const el = document.getElementById(id);
            return el && el.value.trim() !== '';
          });
          applyLoanBtn.disabled = !(allFilled && termsCheckbox.checked);
        }
        // Listen to changes on all required fields and checkbox
        const requiredIds = [
          'loanName', 'loanAccount', 'loanKGID', 'loanAmount', 'loanInterest', 'loanTenure', 'loanPurpose',
          'surety1KGID', 'surety2KGID'
        ];
        requiredIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', checkFormReady);
          }
        });
        termsCheckbox.addEventListener('change', checkFormReady);
        // Initial state
        checkFormReady();
      }

      // Loan application form submission (step 3)
      const loanStepForm = document.getElementById('loanStepForm');
      if (loanStepForm) {
        loanStepForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(loanStepForm);
          const errorDiv = document.getElementById('loanFormError');
          errorDiv.textContent = '';

          // loan type
          const loanTypeEl = document.querySelector('input[name="loanType"]:checked');
          const loan_type = loanTypeEl ? loanTypeEl.value : null;
          // customer id (prefer preloaded read-only loanAccount)
          const customerId = (document.getElementById('loanAccount') && document.getElementById('loanAccount').value.trim())
            || (document.getElementById('loanAccountNumber') && document.getElementById('loanAccountNumber').value.trim());
          const loan_amount = formData.get('loanAmount');
          const interest_rate = formData.get('loanInterest') || formData.get('interestRate');
          const loan_term_months = formData.get('loanTenure');
          const purpose_input = formData.get('loanPurpose') || '';

          // sureties collection
          const sureties = [];
          const s1 = (document.getElementById('surety1KGID') || {}).value;
          const s2 = (document.getElementById('surety2KGID') || {}).value;
          if (s1 && s1.trim()) sureties.push(s1.trim());
          if (s2 && s2.trim()) sureties.push(s2.trim());

          // basic validation
          if (!loan_type || !customerId || !loan_amount || !interest_rate || !loan_term_months || sureties.length === 0) {
            errorDiv.textContent = "Please fill all required fields and add at least one surety.";
            return;
          }

          // build payload matching backend
          const payload = {
            loan_type,
            customer_id: customerId,
            loan_amount: Number(loan_amount),
            interest_rate: Number(interest_rate),
            loan_term_months: Number(loan_term_months),
            sureties
          };
          if (loan_type === 'normal') payload.purpose_of_loan = purpose_input;
          if (loan_type === 'emergency') payload.purpose_of_emergency_loan = purpose_input;

          try {
            const headers = { 'Content-Type': 'application/json' };
            if (window.STAFF_EMAIL) headers['X-Staff-Email'] = window.STAFF_EMAIL;
            const res = await fetch('/finance/api/apply', {
              method: 'POST',
              headers,
              credentials: 'include', // send session cookie so backend can read session['staff_email']
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=>null);
            if (res.ok && data && data.status === 'success') {
              const loanId = data.loan_id;
              // Try to fetch loan details to display staff info
              let loanDetails = null;
              try {
                const loanRes = await fetch(`/finance/api/${encodeURIComponent(loanId)}`, { credentials: 'include' });
                if (loanRes.ok) loanDetails = await loanRes.json().catch(()=>null);
              } catch {}

              const successPopup = document.getElementById('loanSuccessPopup');
              if (successPopup) {
                const popupContent = successPopup.querySelector('div.text-lg.font-bold.mb-2');
                const certLink = (data.certificate_url) ? `<a href="${data.certificate_url}" target="_blank" class="text-blue-600 underline">View Certificate</a>` : '';
                const staffInfo = loanDetails && loanDetails.staff ? `${loanDetails.staff.name || ''} ${loanDetails.staff.phone ? '('+loanDetails.staff.phone+')' : ''}` : '';
                if (popupContent) {
                  popupContent.innerHTML = `
                    Loan Application Submitted Successfully!<br>
                    <span class='text-blue-600'>Loan ID: ${loanId || 'N/A'}</span><br>
                    ${certLink ? certLink + '<br>' : ''}
                    ${staffInfo ? `<span class="text-sm text-gray-700">Processed by: ${staffInfo}</span>` : ''}
                  `;
                }
                successPopup.classList.remove('hidden');
                // Auto-close + reset
                setTimeout(() => {
                  successPopup.classList.add('hidden');
                  loanStepForm.reset();
                  step1.classList.remove('hidden');
                  step2.classList.add('hidden');
                  step3.classList.add('hidden');
                }, 3500);
              }
            } else {
              errorDiv.textContent = (data && (data.message || data.error)) || 'Loan application failed.';
            }
           } catch {
             errorDiv.textContent = 'Network error.';
           }
         });
       }
      // Fix for Get Transaction modal
      // Add event listener for Fetch button in Get Transaction modal
      const fetchTransBtn = document.getElementById('fetchTransBtn');
      const transSTIDInput = document.getElementById('transSTID');
      const transResultDiv = document.getElementById('transResult');
      const transInputPanel = document.getElementById('transInputPanel');
      const transactionModal = document.getElementById('transactionModal');
      const getTransactionBtn = document.getElementById('getTransactionBtn');

      if (fetchTransBtn) {
        fetchTransBtn.addEventListener('click', () => {
          const stid = transSTIDInput.value.trim();
          if (!stid) {
            transResultDiv.innerHTML = '<div class="text-red-600">Enter a valid STID</div>';
            return;
          }
          // Open the transaction certificate in a new tab/window
          window.open(`/staff/transaction/certificate/${encodeURIComponent(stid)}`, '_blank');
          // Optionally close the modal
          transactionModal.classList.add('hidden');
        });
        if (getTransactionBtn) {
          getTransactionBtn.addEventListener('click', () => {
            transactionModal.classList.remove('hidden');
            transInputPanel.style.display = 'block';
            transResultDiv.innerHTML = '';
            transSTIDInput.value = '';
          });
        }
      }
      const closeTransModal = document.getElementById('closeTransModal');
      if (closeTransModal && transactionModal) {
        closeTransModal.addEventListener('click', () => {
          transactionModal.classList.add('hidden');
        });
      }

      // Fix for Mail Notification modal
      const mailNotificationBtn = document.getElementById('mailNotificationBtn');
      const mailModal = document.getElementById('mailModal');
      if (mailNotificationBtn && mailModal) {
        mailNotificationBtn.addEventListener('click', () => {
          mailModal.classList.remove('hidden');
        });
      }
      // Add close button logic for mail modal
      const closeMailModal = document.getElementById('closeMailModal');
      if (closeMailModal && mailModal) {
        closeMailModal.addEventListener('click', () => {
          mailModal.classList.add('hidden');
        });
      }
    });
    // ‚úÖ Dummy Data for Apply Loan Testing
// Dummy data and fetch overrides removed. Ready for backend integration.

  </script>
</head>
<body class="bg-gray-50">
  <!-- Header - Updated to match landing page style -->
  <header class="w-full bg-white shadow-lg">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <!-- Logo -->
        <img src="https://geqletipzwxokceydhmi.supabase.co/storage/v1/object/public/staff-add/society_logo.png" alt="Logo" class="w-12 h-12 rounded-full border border-blue-200" />
        <span class="text-2xl font-bold text-blue-700">KSTHST coof society </span>
      </div>
      <div class="flex items-center space-x-4">
        <!-- Simplified session access -->
        <span class="text-gray-700">Welcome, {{ session.get('staff_name') or session.get('name') or session.get('email') or 'Staff' }}</span>
        <a href="/logout" id="logoutBtn" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition">Logout</a>
      </div>
    </div>
  </header>

  <div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar - Updated style -->
    <aside class="w-64 bg-white shadow-lg p-6 space-y-4">
      <h2 class="font-bold text-xl text-blue-700 mb-6">Staff Dashboard</h2>
      <nav class="space-y-3">
        <button type="button" id="homeBtn" class="w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition">üè† Home</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="applyLoan">üìù Apply Loan</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="customerDetails">üë§ Customer Details</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="addUser">‚ûï Add User</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="checkExpense">üí∏ Add Expense</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="depositWithdraw">üè¶ Deposit/Withdraw</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="loanRepayment">üí∞ Loan Repayment</button>
        <button class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="nextInstallment">üìÜ Next Installment</button>
        <!-- New Buttons -->
        <button id="getTransactionBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition">üîé Get Transaction</button>
        <button id="mailNotificationBtn" class="w-full text-left px-4 py-2 rounded-lg bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition">üìß Mail Notification</button>
      </nav>
      <!-- Transaction Modal -->
      <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
          <h3 class="text-lg font-bold mb-4 text-blue-700">Get Transactions</h3>
          <div id="transInputPanel">
            <label class="block mb-2">STID</label>
            <input type="text" id="transSTID" class="w-full px-4 py-2 border rounded mb-3" placeholder="Enter STID" />
            <button id="fetchTransBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Fetch</button>
            <button id="closeTransModal" class="bg-gray-300 text-gray-700 px-4 py-2 rounded shadow ml-2">Close</button>
          </div>
          <div id="transResult" class="mt-4"></div>
        </div>
      </div>
      <!-- Mail Notification Modal -->
      <div id="mailModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-lg">
          <h3 class="text-lg font-bold mb-4 text-yellow-700">Mail Notifications</h3>
          <div id="mailList" class="space-y-4">
            <!-- Dummy mail notifications for testing -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
              <p class="font-semibold">Subject: Loan Application Approved</p>
              <p>To: user1@domain.com</p>
              <p>Date: 2025-08-19</p>
              <p>Message: Your loan application (ID: 123456) has been approved.</p>
            </div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-2">
              <p class="font-semibold">Subject: Payment Reminder</p>
              <p>To: user2@domain.com</p>
              <p>Date: 2025-08-18</p>
              <p>Message: Your next loan installment is due on 2025-08-25.</p>
            </div>
          </div>
          <button id="closeMailModal" class="mt-4 px-6 py-2 bg-gray-300 text-gray-700 rounded shadow">Close</button>
        </div>
      </div>
    </aside>

    <!-- Main content area - Updated style -->
    <main class="flex-1 p-8 space-y-6">
      <!-- DASHBOARD SUMMARY SECTION -->
      <section id="dashboardSummary" class="dynamic-section bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold text-blue-700 mb-6">Dashboard Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="flex items-center bg-blue-100 rounded-lg p-6 shadow">
            <div class="bg-blue-500 text-white rounded-full p-4 mr-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M17 20h5v-2a4 4 0 00-3-3.87M9 20H4v-2a4 4 0 013-3.87M12 12a4 4 0 100-8 4 4 0 000 8zm0 0v4m0 0v4m0-4h4m-4 0H8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold" id="totalCustomers">0</div>
              <div class="text-gray-700">Total Customers</div>
            </div>
          </div>
          <div class="flex items-center bg-green-100 rounded-lg p-6 shadow">
            <div class="bg-green-500 text-white rounded-full p-4 mr-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 17v-6a2 2 0 012-2h2a2 2 0 012 2v6m-6 0h6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold" id="activeLoans">0</div>
              <div class="text-gray-700">Active Loans</div>
            </div>
          </div>
          <div class="flex items-center bg-yellow-100 rounded-lg p-6 shadow">
            <div class="bg-yellow-500 text-white rounded-full p-4 mr-4">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 0V4m0 16v-4" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold" id="totalAmount">‚Çπ0</div>
              <div class="text-gray-700">Total Amount</div>
            </div>
          </div>
        </div>
      </section>
      <section id="applyLoan" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content space-y-8" id="applyLoanContent">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Apply for Loan</h2>
          <form id="loanStepForm" class="w-full space-y-6 bg-white p-6 rounded-xl shadow">
            <!-- Step 1: Select Loan Type -->
            <div id="step1" class="space-y-4">
              <label class="block font-semibold mb-2">Select Loan Type:</label>
              <div class="flex gap-6">
                <label class="flex items-center gap-2">
                  <input type="radio" name="loanType" value="normal" class="form-radio" required>
                  Normal Loan
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="loanType" value="emergency" class="form-radio" required>
                  Emergency Loan
                </label>
              </div>
              <button type="button" id="toStep2Btn" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded shadow">Next</button>
            </div>
            <!-- Step 2: Enter Account Number -->
            <div id="step2" class="space-y-4 hidden">
              <label class="block font-semibold mb-2">Enter Account Number:</label>
              <input type="text" id="loanAccountNumber" name="accountNumber" class="w-full px-4 py-2 border rounded" required>
              <button type="button" id="fetchAccountBtn" class="px-4 py-2 bg-blue-500 text-white rounded shadow">Fetch Details</button>
              <div id="accountFetchMsg" class="text-sm mt-2"></div>
            </div>
            <!-- Step 3: Preloaded and Manual Fields -->
            <div id="step3" class="space-y-4 hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block font-medium">Name</label>
                  <input type="text" id="loanName" name="name" class="w-full px-4 py-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                  <label class="block font-medium">Account Number</label>
                  <input type="text" id="loanAccount" name="account" class="w-full px-4 py-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                  <label class="block font-medium">KGID</label>
                  <input type="text" id="loanKGID" name="kgid" class="w-full px-4 py-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                  <label class="block font-medium">Loan Amount</label>
                  <input type="number" id="loanAmount" name="loanAmount" class="w-full px-4 py-2 border rounded" required>
                </div>
                <div>
                  <label class="block font-medium">Rate of Interest (%)</label>
                  <input type="number" id="loanInterest" name="interestRate" class="w-full px-4 py-2 border rounded" required>
                </div>
                <div>
                  <label class="block font-medium">Loan Tenure (months)</label>
                  <input type="number" id="loanTenure" name="loanTenure" class="w-full px-4 py-2 border rounded" required>
                </div>
                <div class="md:col-span-2">
                  <label class="block font-medium">Purpose of Loan</label>
                  <input type="text" id="loanPurpose" name="loanPurpose" class="w-full px-4 py-2 border rounded" required>
                </div>
              </div>
              <!-- Sureties Section -->
              <div class="mt-6">
                <label class="block font-semibold mb-2">Add Sureties (Max 2):</label>
                <div id="suretiesContainer" class="space-y-4">
                  <!-- Surety 1 -->
                  <div class="bg-gray-50 p-4 rounded-xl shadow mb-2" id="surety1Box">
                    <div class="flex gap-2 mb-2">
                      <input type="text" id="surety1KGID" placeholder="Enter Surety 1 KGID" class="px-4 py-2 border rounded flex-1" required>
                      <button type="button" id="checkSurety1Btn" class="bg-blue-500 text-white px-3 py-1 rounded">Check</button>
                      <button type="button" id="removeSurety1Btn" class="bg-red-500 text-white px-3 py-1 rounded hidden">Remove</button>
                    </div>
                    <span id="surety1Msg" class="text-sm mb-2 block"></span>
                    <div id="surety1Fields" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                  </div>
                  <!-- Surety 2 -->
                  <div class="bg-gray-50 p-4 rounded-xl shadow" id="surety2Box">
                    <div class="flex gap-2 mb-2">
                      <input type="text" id="surety2KGID" placeholder="Enter Surety 2 KGID (optional)" class="px-4 py-2 border rounded flex-1">
                      <button type="button" id="checkSurety2Btn" class="bg-blue-500 text-white px-3 py-1 rounded">Check</button>
                      <button type="button" id="removeSurety2Btn" class="bg-red-500 text-white px-3 py-1 rounded hidden">Remove</button>
                    </div>
                    <span id="surety2Msg" class="text-sm mb-2 block"></span>
                    <div id="surety2Fields" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                  </div>
                </div>
              </div>
              <!-- Terms and Conditions -->
              <div class="mt-6">
                <label class="flex items-start gap-2">
                  <input type="checkbox" id="termsCheckbox" class="mt-1" required>
                  <span>
                    We have agreed to be surety for the loan taken by the said person. We are members of the association, and if he defaults, we have given our consent to the wage payment officers to deduct 50% of our salary or share money to repay the loan.
                  </span>
                </label>
              </div>
              <!-- Error Message -->
              <div id="loanFormError" class="text-red-600 font-semibold mb-2"></div>
              <!-- Apply Button -->
              <button type="submit" id="applyLoanBtn" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded shadow w-full" disabled>Apply</button>
            </div>
          </form>
          <!-- Success Popup -->
          <div id="loanSuccessPopup" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center">
              <div class="text-green-600 text-3xl mb-4">‚úî</div>
              <div class="text-lg font-bold mb-2">Loan Application Submitted Successfully!</div>
              <button id="closeLoanSuccess" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded shadow">Close</button>
            </div>
          </div>
        </div>
      </section>
      <section id="customerDetails" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content">
          <iframe src="/staff/customer-details" class="w-full min-h-[700px] border-0 rounded-xl shadow"></iframe>
        </div>
      </section>
      <section id="addUser" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Add New User</h2>
          <!-- Move message box here, styled as alert -->
          <div id="addUserMsg" class="mb-4 text-center hidden"></div>
          <form id="addUserForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Single Name Field -->
              <div>
                <label class="block text-sm font-medium mb-1">Full Name</label>
                <input type="text" name="name" placeholder="Full Name" class="border p-2 rounded w-full" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">KGID</label>
                <input type="text" name="kgid" placeholder="KGID" class="border p-2 rounded w-full" />
              </div>
              <!-- Phone & Email Row -->
              <div>
                <label class="block text-sm font-medium mb-1">Phone Number</label>
                <input type="text" name="phone" placeholder="Phone Number" class="border p-2 rounded w-full" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Email</label>
                <div class="flex gap-2">
                  <input type="email" name="email" id="emailInput" placeholder="Email" class="border p-2 rounded w-full" required />
                  <button type="button" id="verifyEmailBtn" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600">
                    Verify
                  </button>
                </div>
              </div>
              <!-- OTP Input -->
              <div id="otpContainer" class="col-span-1 md:col-span-2 hidden">
                <label class="block text-sm font-medium mb-1">Enter OTP</label>
                <input type="text" id="otpInput" name="otp" placeholder="Enter OTP" class="border p-2 rounded w-full" />
              </div>
              <!-- More User Details -->
              <div>
                <label class="block text-sm font-medium mb-1">Father's Name</label>
                <input type="text" name="father_name" placeholder="Father's Name" class="border p-2 rounded w-full" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Salary</label>
                <input type="text" name="salary" placeholder="Salary" class="border p-2 rounded w-full" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Organization Name</label>
                <input type="text" name="organization_name" placeholder="Organization Name" class="border p-2 rounded w-full" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Aadhar Number</label>
                <input type="text" name="aadhar_no" placeholder="Aadhar Number" class="border p-2 rounded w-full" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">PAN Number</label>
                <input type="text" name="pan_no" placeholder="PAN Number" class="border p-2 rounded w-full" required />
              </div>
              <!-- Address -->
              <div class="col-span-1 md:col-span-2">
                <label class="block text-sm font-medium mb-1">Address</label>
                <textarea name="address" placeholder="Address" class="border p-2 rounded w-full" required></textarea>
              </div>
              <!-- Photo Upload -->
              <div>
                <label class="block text-sm font-medium mb-1">Upload Photo <span class="text-xs text-gray-500">(Image must be below 50KB)</span></label>
                <input type="file" name="photo" class="border p-2 rounded w-full" accept="image/*" required />
              </div>
              <!-- Signature Upload -->
              <div>
                <label class="block text-sm font-medium mb-1">Upload Signature <span class="text-xs text-gray-500">(Image must be below 50KB)</span></label>
                <input type="file" name="signature" class="border p-2 rounded w-full" accept="image/*" required />
              </div>
            </div>
            <!-- Warning Message -->
            <p id="verifyWarning" class="text-red-500 mt-2 hidden col-span-1 md:col-span-2">‚ö† Please verify your email before proceeding.</p>
            <button id="addUserBtn" type="submit" class="mt-4 px-4 py-2 bg-green-500 text-white rounded">Add User</button>
          </form>
          <!-- Remove the old message box from below the form -->
        </div>
      </section>

      <script>
document.addEventListener('DOMContentLoaded', () => {
  const verifyEmailBtn = document.getElementById('verifyEmailBtn');
  const emailInput = document.getElementById('emailInput');
  const otpContainer = document.getElementById('otpContainer');
  const addUserMsg = document.getElementById('addUserMsg');

  if (verifyEmailBtn) {
    verifyEmailBtn.addEventListener('click', async () => {
      const email = emailInput.value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        addUserMsg.textContent = 'Please enter a valid email address.';
        addUserMsg.className = 'mb-4 text-center text-red-600';
        addUserMsg.classList.remove('hidden');
        return;
      }

      // Disable button to prevent multiple clicks
      verifyEmailBtn.disabled = true;
      verifyEmailBtn.textContent = 'Sending...';
      addUserMsg.textContent = '';
      addUserMsg.classList.add('hidden');

      try {
        const formData = new FormData();
        formData.append('email', email);

        const response = await fetch('/staff/api/add-member/send-otp', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok) {
          addUserMsg.textContent = 'OTP sent successfully! Please check your email.';
          addUserMsg.className = 'mb-4 text-center text-green-600';
          otpContainer.classList.remove('hidden');
          verifyEmailBtn.textContent = 'Resend OTP';
        } else {
          addUserMsg.textContent = data.message || 'Failed to send OTP.';
          addUserMsg.className = 'mb-4 text-center text-red-600';
        }
      } catch (error) {
        addUserMsg.textContent = 'An error occurred. Please try again.';
        addUserMsg.className = 'mb-4 text-center text-red-600';
      } finally {
        addUserMsg.classList.remove('hidden');
        verifyEmailBtn.disabled = false;
      }
    });
  }

  // Handle Add User form submission
  const addUserForm = document.getElementById('addUserForm');
  if (addUserForm) {
    addUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(addUserForm);
      
      // Validate that OTP field is visible and filled
      const otpInput = document.getElementById('otpInput');
      if (!otpInput || otpContainer.classList.contains('hidden')) {
        addUserMsg.textContent = 'Please verify your email first.';
        addUserMsg.className = 'mb-4 text-center text-red-600';
        addUserMsg.classList.remove('hidden');
        return;
      }
      
      if (!otpInput.value.trim()) {
        addUserMsg.textContent = 'Please enter the OTP.';
        addUserMsg.className = 'mb-4 text-center text-red-600';
        addUserMsg.classList.remove('hidden');
        return;
      }

      // Show loading state
      const addUserBtn = document.getElementById('addUserBtn');
      addUserBtn.disabled = true;
      addUserBtn.textContent = 'Adding User...';
      addUserMsg.textContent = '';
      addUserMsg.classList.add('hidden');

      try {
        const response = await fetch('/staff/api/add-member', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok && data.status === 'success') {
          addUserMsg.textContent = 'Member added successfully!';
          addUserMsg.className = 'mb-4 text-center text-green-600';
          addUserForm.reset();
          otpContainer.classList.add('hidden');
          verifyEmailBtn.textContent = 'Verify';
        } else {
          addUserMsg.textContent = data.message || 'Failed to add member.';
          addUserMsg.className = 'mb-4 text-center text-red-600';
        }
      } catch (error) {
        addUserMsg.textContent = 'An error occurred. Please try again.';
        addUserMsg.className = 'mb-4 text-center text-red-600';
      } finally {
        addUserMsg.classList.remove('hidden');
        addUserBtn.disabled = false;
        addUserBtn.textContent = 'Add User';
      }
    });
  }
});
</script>

<section id="checkExpense" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  
  <!-- Header with Download Button -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-blue-700">Add Expense</h2>
    <button id="downloadReportBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
      Download Report
    </button>
  </div>

  <div class="content space-y-4">
    <!-- Transaction ID -->
    <input id="expenseTxnId" type="text" placeholder="Transaction ID" class="w-full border p-2 rounded" />

    <!-- Expense Fields -->
    <input id="expenseName" type="text" placeholder="Expense Name" class="w-full border p-2 rounded" />
    <input id="expenseAmount" type="number" placeholder="Amount" class="w-full border p-2 rounded" />

    <!-- From & To Date -->
    <input id="expenseDate" type="date" class="w-full border p-2 rounded" />

    <textarea id="expenseDescription" placeholder="Description" class="w-full border p-2 rounded"></textarea>

    <div class="flex items-center gap-4">
      <button id="addExpenseBtn" class="px-4 py-2 bg-blue-500 text-white rounded">Add Expense</button>
      <div id="expenseMsg" class="text-sm"></div>
    </div>
  </div>
</section>

<script>
  // Add Expense handler: validate, POST to backend, show processing/completion messages.
  (function(){
    const addBtn = document.getElementById('addExpenseBtn');
    const msg = document.getElementById('expenseMsg');
    if (!addBtn || !msg) return;

    addBtn.addEventListener('click', async function () {
      // collect values
      const txnId = (document.getElementById('expenseTxnId') || {}).value?.trim();
      const name = (document.getElementById('expenseName') || {}).value?.trim();
      const amount = (document.getElementById('expenseAmount') || {}).value?.trim();
      const date = (document.getElementById('expenseDate') || {}).value?.trim();
      const description = (document.getElementById('expenseDescription') || {}).value?.trim();

      // simple validation
      if (!name || !amount || !date) {
        msg.textContent = 'Please fill Expense Name, Amount and Date.';
        msg.className = 'text-sm text-red-600';
        return;
      }

      // show processing state
      addBtn.disabled = true;
      msg.textContent = 'Processing...';
      msg.className = 'text-sm text-blue-600';

      const payload = {
        transaction_id: txnId || null,
        name,
        amount: Number(amount),
        date,
        description
      };

      try {
        const res = await fetch('/api/check-expenses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // attempt to parse JSON response
        let data = null;
        try { data = await res.json(); } catch(e){ data = null; }

        if (!res.ok) {
          // backend responded non-2xx
          const serverMsg = data && data.message ? data.message : res.statusText || 'Server error';
          msg.textContent = 'Failed to save expense. ' + serverMsg;
          msg.className = 'text-sm text-red-600';
        } else if (data && data.status === 'success') {
          // backend may include message (e.g. saved locally)
          const serverMsg = data.message || 'Expense saved successfully.';
          msg.textContent = serverMsg;
          msg.className = 'text-sm text-green-600';
          // optionally clear form
          (document.getElementById('expenseTxnId') || {}).value = '';
          (document.getElementById('expenseName') || {}).value = '';
          (document.getElementById('expenseAmount') || {}).value = '';
          (document.getElementById('expenseDate') || {}).value = '';
          (document.getElementById('expenseDescription') || {}).value = '';
          // reload admin expenses list if opened elsewhere (best-effort)
          if (window.loadExpenses) try { window.loadExpenses(); } catch(e){}
        } else {
          // Backend returned success HTTP but payload indicates error or unexpected shape
          const serverMsg = data && data.message ? data.message : 'Invalid response from backend';
          msg.textContent = 'Failed to save expense. ' + serverMsg;
          msg.className = 'text-sm text-red-600';
        }
      } catch (err) {
        // network / connection error
        console.error('Add expense network error:', err);
        msg.textContent = 'Backend not connected. Please try again later.';
        msg.className = 'text-sm text-red-600';
      } finally {
        addBtn.disabled = false;
      }
    });
  })();
</script>

      <section id="depositWithdraw" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  <div class="content space-y-6">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Deposit / Withdraw</h2>

    <!-- Customer Info -->
    <div id="customerInfo" class="hidden p-3 bg-gray-100 rounded border">
      <p><strong>Name:</strong> <span id="customerName">-</span></p>
      <p><strong>Current Balance:</strong> ‚Çπ<span id="customerBalance">0</span></p>
    </div>

    <!-- Toggle Buttons -->
    <div class="flex gap-2 mb-4">
      <button id="showDepositBtn" class="toggle-btn px-4 py-2 rounded shadow bg-green-500 text-white">Deposit</button>
      <button id="showWithdrawBtn" class="toggle-btn px-4 py-2 rounded shadow bg-gray-300">Withdraw</button>
    </div>

    <!-- Deposit Form -->
    <div id="depositForm" class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-lg font-semibold mb-4 text-green-700 text-center">Deposit</h3>
      <input type="text" placeholder="Customer ID" class="w-full px-4 py-2 border rounded mb-3" id="depositCustomerId" />
      <input type="number" placeholder="Amount" class="w-full px-4 py-2 border rounded mb-3" id="depositAmount" />
      <input type="date" class="w-full px-4 py-2 border rounded mb-3" id="depositDate" />
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="from Account Number" class="w-1/2 px-4 py-2 border rounded" id="depositFromAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="depositFromBank" />
      </div>
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="To Account Number" class="w-1/2 px-4 py-2 border rounded" id="depositToAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="depositToBank" />
      </div>
      <input type="text" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded mb-3" id="depositTxnId" />
      <input type="text" placeholder="Remarks" class="w-full px-4 py-2 border rounded mb-3" id="depositRemarks" />
      <button id="depositBtn" class="bg-green-500 text-white px-6 py-2 rounded w-full shadow hover:bg-green-600 transition">Deposit</button>
    </div>

    <!-- Withdraw Form -->
    <div id="withdrawForm" class="bg-white p-6 rounded-xl shadow hidden">
      <h3 class="text-lg font-semibold mb-4 text-red-700 text-center">Withdraw</h3>
      <input type="text" placeholder="Customer ID" class="w-full px-4 py-2 border rounded mb-3" id="withdrawCustomerId" />
      <input type="number" placeholder="Amount" class="w-full px-4 py-2 border rounded mb-3" id="withdrawAmount" />
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="from Account Number" class="w-1/2 px-4 py-2 border rounded" id="withdrawFromAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="withdrawFromBank" />
      </div>
      <div class="flex gap-2 mb-3">
        <input type="text" placeholder="To Account Number" class="w-1/2 px-4 py-2 border rounded" id="withdrawToAccount" />
        <input type="text" placeholder="Bank Name" class="w-1/2 px-4 py-2 border rounded" id="withdrawToBank" />
      </div>
      <input type="date" class="w-full px-4 py-2 border rounded mb-3" id="withdrawDate" />
      <input type="text" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded mb-3" id="withdrawTxnId" />
      <input type="text" placeholder="Remarks" class="w-full px-4 py-2 border rounded mb-3" id="withdrawRemarks" />
      <button id="withdrawBtn" class="bg-red-500 text-white px-6 py-2 rounded w-full shadow hover:bg-red-600 transition">Withdraw</button>
    </div>

  </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", function () {

  const depositForm = document.getElementById("depositForm");
  const withdrawForm = document.getElementById("withdrawForm");
  const depositBtnToggle = document.getElementById("showDepositBtn");
  const withdrawBtnToggle = document.getElementById("showWithdrawBtn");

  // Toggle Deposit/Withdraw
  function toggleForms(showDeposit) {
    if (showDeposit) {
      depositForm.classList.remove("hidden");
      withdrawForm.classList.add("hidden");
      depositBtnToggle.classList.add("bg-green-500", "text-white");
      depositBtnToggle.classList.remove("bg-gray-300");
      withdrawBtnToggle.classList.add("bg-gray-300");
      withdrawBtnToggle.classList.remove("bg-red-500", "text-white");
    } else {
      withdrawForm.classList.remove("hidden");
      depositForm.classList.add("hidden");
      withdrawBtnToggle.classList.add("bg-red-500", "text-white");
      withdrawBtnToggle.classList.remove("bg-gray-300");
      depositBtnToggle.classList.add("bg-gray-300");
      depositBtnToggle.classList.remove("bg-green-500", "text-white");
    }
  }

  depositBtnToggle.addEventListener("click", () => toggleForms(true));
  withdrawBtnToggle.addEventListener("click", () => toggleForms(false));

  // Deposit
  document.getElementById("depositBtn").addEventListener("click", async () => {
    const depositCustomerId = document.getElementById("depositCustomerId");
    const depositAmount = document.getElementById("depositAmount");
    const depositDate = document.getElementById("depositDate");
    const depositFromAccount = document.getElementById("depositFromAccount");
    const depositFromBank = document.getElementById("depositFromBank");
    const depositToAccount = document.getElementById("depositToAccount");
    const depositToBank = document.getElementById("depositToBank");
    const depositTxnId = document.getElementById("depositTxnId");
    const depositRemarks = document.getElementById("depositRemarks");

    if (
      !depositCustomerId || !depositAmount || !depositDate ||
      !depositFromAccount || !depositFromBank ||
      !depositToAccount || !depositToBank || !depositTxnId
    ) {
      alert("Form error: Some fields are missing in the DOM.");
      return;
    }

    const depositData = {
      customer_id: depositCustomerId.value.trim(),
      amount: depositAmount.value.trim(),
      date: depositDate.value.trim(),
      from_account: depositFromAccount.value.trim(),
      from_bank_name: depositFromBank.value.trim(),
      to_account: depositToAccount.value.trim(),
      to_bank_name: depositToBank.value.trim(),
      transaction_id: depositTxnId.value.trim(),
      remarks: depositRemarks ? depositRemarks.value.trim() : "",
      type: "deposit"
    };

    if (Object.values(depositData).some(v => v === "")) {
      alert("Please fill all Deposit fields.");
      return;
    }

    try {
      const formData = new FormData();
      for (const key in depositData) {
        formData.append(key, depositData[key]);
      }
      const res = await fetch('/staff/api/add-transaction', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (res.ok && data.status === "success" && data.transaction && data.transaction.stid) {
        // Open the receipt in the required format
        const stid = data.transaction.stid;
        const receiptUrl = `/staff/transaction/certificate/${encodeURIComponent(stid)}?action=view`;
        window.open(receiptUrl, '_blank');
        alert("Deposit successful!");
      } else {
        alert(data.message || "Deposit failed.");
      }
    } catch (err) {
      alert("Network error.");
    }
  });

  // Withdraw
  document.getElementById("withdrawBtn").addEventListener("click", async () => {
    const withdrawCustomerId = document.getElementById("withdrawCustomerId");
    const withdrawAmount = document.getElementById("withdrawAmount");
    const withdrawDate = document.getElementById("withdrawDate");
    const withdrawFromAccount = document.getElementById("withdrawFromAccount");
    const withdrawFromBank = document.getElementById("withdrawFromBank");
    const withdrawToAccount = document.getElementById("withdrawToAccount");
    const withdrawToBank = document.getElementById("withdrawToBank");
    const withdrawTxnId = document.getElementById("withdrawTxnId");
    const withdrawRemarks = document.getElementById("withdrawRemarks");

    if (
      !withdrawCustomerId || !withdrawAmount || !withdrawDate ||
      !withdrawFromAccount || !withdrawFromBank ||
      !withdrawToAccount || !withdrawToBank || !withdrawTxnId
    ) {
      alert("Form error: Some fields are missing in the DOM.");
      return;
    }

    const withdrawData = {
      customer_id: withdrawCustomerId.value.trim(),
      amount: withdrawAmount.value.trim(),
      date: withdrawDate.value.trim(),
      from_account: withdrawFromAccount.value.trim(),
      from_bank_name: withdrawFromBank.value.trim(),
      to_account: withdrawToAccount.value.trim(),
      to_bank_name: withdrawToBank.value.trim(),
      transaction_id: withdrawTxnId.value.trim(),
      remarks: withdrawRemarks ? withdrawRemarks.value.trim() : "",
      type: "withdraw"
    };

    if (Object.values(withdrawData).some(v => v === "")) {
      alert("Please fill all Withdraw fields.");
      return;
    }

    try {
      const formData = new FormData();
      for (const key in withdrawData) {
        formData.append(key, withdrawData[key]);
      }
      const res = await fetch('/staff/api/add-transaction', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (res.ok && data.status === "success" && data.transaction && data.transaction.stid) {
        const stid = data.transaction.stid;
        const receiptUrl = `/staff/transaction/certificate/${encodeURIComponent(stid)}?action=view`;
        window.open(receiptUrl, '_blank');
        alert("Withdrawal successful!");
      } else {
        alert(data.message || "Withdrawal failed.");
      }
    } catch (err) {
      alert("Network error.");
    }
  });

  // Customer Details section: iframe loading and error handling
  (function() {
    const customerDetailsSection = document.getElementById('customerDetails');
    if (!customerDetailsSection) return;

    const iframe = customerDetailsSection.querySelector('iframe');
    const loader = customerDetailsSection.querySelector('.loader');
    const content = customerDetailsSection.querySelector('.content');

    function showLoader() {
      loader.classList.remove('hidden');
      content.classList.add('hidden');
    }

    function hideLoader() {
      loader.classList.add('hidden');
      content.classList.remove('hidden');
    }

    // Initial load
    showLoader();
    iframe.onload = hideLoader;
    iframe.onerror = function() {
      hideLoader();
      content.innerHTML = '<div class="text-red-600">Failed to load customer details. Please try again later.</div>';
    };
  })();

  // Loan Repayment Section
  const loanSearchForm = document.getElementById('loanSearchForm');
  const loanSearchInput = document.getElementById('loanSearchInput');
  const loanSearchType = document.getElementById('loanSearchType');
  const loanInfoResult = document.getElementById('loanInfoResult');
  const autoTransactionFormContainer = document.getElementById('autoTransactionFormContainer');

  if (loanSearchForm) {
    loanSearchForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const searchValue = loanSearchInput.value.trim();
      const searchType = loanSearchType.value;
      loanInfoResult.innerHTML = '';
      autoTransactionFormContainer.innerHTML = '';
      if (!searchValue) {
        loanInfoResult.innerHTML = '<div class="text-red-600">Please enter a value.</div>';
        return;
      }
      try {
        let loanApiUrl = '';
        if (searchType === 'loanId') {
          loanApiUrl = `/finance/${encodeURIComponent(searchValue)}`;
        } else {
          loanApiUrl = `/finance/api/fetch_customer_details?customer_id=${encodeURIComponent(searchValue)}`;
        }
        const res = await fetch(loanApiUrl);
        const data = await res.json();

        // Helper to get EMI for a loan
        function calculateEMI(principal, rate, months) {
          principal = Number(principal) || 0;
          rate = Number(rate) || 0;
          months = Number(months) || 0;
          const monthlyRate = rate / (12 * 100);
          if (monthlyRate > 0 && months > 0) {
            return Math.round(principal * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1));
          } else if (months > 0) {
            return Math.round(principal / months);
          }
          return principal;
        }

        // Render repayment form for a loan
        function renderRepaymentForm(loan, summaryRow) {
          const outstanding = summaryRow ? Number(summaryRow.outstanding_balance || 0) : 0;
          const emi = calculateEMI(loan.loan_amount, loan.interest_rate, loan.loan_term_months);
          autoTransactionFormContainer.innerHTML = `
            <div class="bg-gray-50 p-6 rounded-xl shadow max-w-md mx-auto mt-4">
              <h4 class="font-bold mb-2 text-blue-700">Loan Repayment</h4>
              <div class="mb-2"><b>Loan ID:</b> ${loan.loan_id}</div>
              <div class="mb-2"><b>Outstanding:</b> <span class="font-semibold text-yellow-700">‚Çπ${outstanding.toLocaleString()}</span></div>
              <div class="mb-2"><b>Installment (EMI):</b> <span class="font-semibold text-blue-700">‚Çπ${emi.toLocaleString()}</span></div>
              <form id="repayLoanForm">
                <label class="block mb-1 font-medium">Repayment Amount</label>
                <input type="number" id="repaymentAmount" name="amount" min="1" max="${outstanding}" class="w-full px-4 py-2 border rounded mb-2" placeholder="Enter custom amount or leave blank for EMI" />
                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded w-full">Repay</button>
                <div id="repayLoanMsg" class="mt-2 text-sm"></div>
              </form>
            </div>
          `;
          const repayLoanForm = document.getElementById('repayLoanForm');
          const repayLoanMsg = document.getElementById('repayLoanMsg');
          if (repayLoanForm) {
            repayLoanForm.onsubmit = async function(e) {
              e.preventDefault();
              repayLoanMsg.textContent = '';
              let amount = document.getElementById('repaymentAmount').value;
              if (!amount) amount = emi;
              repayLoanMsg.textContent = 'Processing...';
              try {
                const res = await fetch('/finance/repay-loan', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    loan_id: loan.id,
                    amount: Number(amount)
                  })
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                  repayLoanMsg.textContent = `Repayment successful. Outstanding: ‚Çπ${Number(data.outstanding_balance).toLocaleString()}`;
                  repayLoanMsg.className = 'mt-2 text-green-600';
                } else {
                  repayLoanMsg.textContent = data.message || 'Repayment failed.';
                  repayLoanMsg.className = 'mt-2 text-red-600';
                }
              } catch (err) {
                repayLoanMsg.textContent = 'Network error.';
                repayLoanMsg.className = 'mt-2 text-red-600';
              }
            };
          }
        }

      if (searchType === 'loanId') {
        if (!data || data.status !== 'success' || !data.loan) {
          loanInfoResult.innerHTML = '<div class="text-red-600">Loan not found.</div>';
          return;
        }
        const loan = data.loan;
        const records = data.records || [];
        const summaryRow = records.find(r => r.repayment_amount === null || r.repayment_amount === undefined);
        const outstanding = summaryRow ? Number(summaryRow.outstanding_balance || 0) : 0;
        const emi = calculateEMI(loan.loan_amount, loan.interest_rate, loan.loan_term_months);
        loanInfoResult.innerHTML = `
          <div class="border rounded p-4 mb-3">
            <div><b>Loan ID:</b> ${loan.loan_id}</div>
            <div><b>Principal:</b> ‚Çπ${Number(loan.loan_amount).toLocaleString()}</div>
            <div><b>Interest:</b> ‚Çπ${summaryRow ? Number(summaryRow.interest_amount || 0).toLocaleString() : 0}</div>
            <div><b>Outstanding:</b> <span class="font-semibold text-yellow-700">‚Çπ${outstanding.toLocaleString()}</span></div>
            <div><b>Installment (EMI):</b> <span class="font-semibold text-blue-700">‚Çπ${emi.toLocaleString()}</span></div>
            <button class="mt-2 px-4 py-1 bg-blue-600 text-white rounded" onclick="showRepaymentForm('${loan.id}', '${loan.loan_id}', ${outstanding}, ${emi})">Repay</button>
          </div>
        `;
        window.showRepaymentForm = function(loanUuid, loanId, outstanding, emi) {
          renderRepaymentForm(loan, summaryRow);
        };
        autoTransactionFormContainer.innerHTML = '';
      } else {
        if (!data || data.status !== 'success' || !data.loans || data.loans.length === 0) {
          loanInfoResult.innerHTML = '<div class="text-red-600">No loans found for this account.</div>';
          return;
        }
        loanInfoResult.innerHTML = data.loans.map(loan => {
          const summaryRow = (loan.repayment_records || []).find(r => r.repayment_amount === null || r.repayment_amount === undefined);
          const outstanding = summaryRow ? Number(summaryRow.outstanding_balance || 0) : 0;
          const emi = calculateEMI(loan.loan_amount, loan.interest_rate, loan.loan_term_months);
          return `
            <div class="border rounded p-4 mb-3">
              <div><b>Loan ID:</b> ${loan.loan_id}</div>
              <div><b>Principal:</b> ‚Çπ${Number(loan.loan_amount).toLocaleString()}</div>
              <div><b>Interest:</b> ‚Çπ${summaryRow ? Number(summaryRow.interest_amount || 0).toLocaleString() : 0}</div>
              <div><b>Outstanding:</b> <span class="font-semibold text-yellow-700">‚Çπ${outstanding.toLocaleString()}</span></div>
              <div><b>Installment (EMI):</b> <span class="font-semibold text-blue-700">‚Çπ${emi.toLocaleString()}</span></div>
              <button class="mt-2 px-4 py-1 bg-blue-600 text-white rounded" onclick="showRepaymentForm('${loan.id}', '${loan.loan_id}', ${outstanding}, ${emi})">Repay</button>
            </div>
          `;
        }).join('');
        window.showRepaymentForm = function(loanUuid, loanId, outstanding, emi) {
          // Find the loan object from the last fetched data
          const loan = data.loans.find(l => l.id == loanUuid);
          const summaryRow = (loan.repayment_records || []).find(r => r.repayment_amount === null || r.repayment_amount === undefined);
          renderRepaymentForm(loan, summaryRow);
        };
      }
    } catch (err) {
      loanInfoResult.innerHTML = '<div class="text-red-600">Error fetching loan details.</div>';
    }
  });
}

    // Fix: Loan Repayment sidebar button loads loan_repayment.html as a section (not iframe)
    const loanRepaymentBtn = document.querySelector('.nav-button[data-target="loanRepayment"]');
    if (loanRepaymentBtn) {
      loanRepaymentBtn.addEventListener('click', () => {
        window.open('/loan_repayment', '_blank');
      });
    }
  <div>
    <button id="queryBtn" class="fixed bottom-6 right-6 bg-blue-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-blue-700">
      üì© Query
    </button>

    <!-- Floating Query Box -->
  <div id="queryBox" class="floating-box hidden fixed bottom-20 right-6 w-80 bg-white rounded-xl shadow-2xl p-4 z-50">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-bold">Send Us a Query</h3>
      <button id="closeQuery" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <input class="w-full mb-3 px-4 py-2 border rounded" placeholder="Name">
    <input class="w-full mb-3 px-4 py-2 border rounded" placeholder="KGID">
    <textarea class="w-full mb-3 px-4 py-2 border rounded" placeholder="Description"></textarea>
    <button id="sendQuery" class="bg-blue-600 text-white px-6 py-2 rounded w-full hover:bg-blue-700">Send Message</button>
  </div>

  <!-- Floating Civil Score Button -->
  <button id="civilBtn" class="fixed bottom-20 right-6 bg-green-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-green-700">
    üìä Civil Score
  </button>

  <!-- Floating Civil Score Box -->
  <div id="civilBox" class="floating-box hidden fixed bottom-36 right-6 w-80 bg-white rounded-xl shadow-2xl p-4 z-50">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-bold">Check Civil Score</h3>
      <button id="closeCivil" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <input class="w-full mb-3 px-4 py-2 border rounded" placeholder="Enter KGID Number">
    <button id="checkCivil" class="bg-green-600 text-white px-6 py-2 rounded w-full hover:bg-green-700">Check Now</button>
  </div>
  <script src="shared.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      initializeFloatingBoxes();
    });
  </script>
</body>
</html>
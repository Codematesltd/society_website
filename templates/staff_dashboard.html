<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loan Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .floating-box {
      transform: translateY(100%);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }
    .floating-box.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
  <script>
    // Ensure Loan Repayment, Next Installment, and Check Transaction buttons work
    document.addEventListener('DOMContentLoaded', function() {
      const sections = document.querySelectorAll('.dynamic-section');
      const repaymentBtn = document.querySelector('[data-target="loanRepayment"]');
      const installmentBtn = document.querySelector('[data-target="nextInstallment"]');
      const transactionBtn = document.querySelector('[data-target="checkTransaction"]');
      if (repaymentBtn) {
        repaymentBtn.addEventListener('click', function() {
          sections.forEach(sec => sec.classList.add('hidden'));
          const target = document.getElementById('loanRepayment');
          if (target) target.classList.remove('hidden');

        });
      }
    });
    // Ensure Check Expense and Deposit/Withdraw buttons work
    document.addEventListener('DOMContentLoaded', function() {
      const sections = document.querySelectorAll('.dynamic-section');
      const expenseBtn = document.querySelector('[data-target="checkExpense"]');
      const depositBtn = document.querySelector('[data-target="depositWithdraw"]');
      if (expenseBtn) {
        expenseBtn.addEventListener('click', function() {
          sections.forEach(sec => sec.classList.add('hidden'));
          const target = document.getElementById('checkExpense');
          if (target) target.classList.remove('hidden');
        });
      }
      if (depositBtn) {
        depositBtn.addEventListener('click', function() {
          sections.forEach(sec => sec.classList.add('hidden'));
          const target = document.getElementById('depositWithdraw');
          if (target) target.classList.remove('hidden');
        });
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      const sections = document.querySelectorAll('.dynamic-section');
      const buttons = document.querySelectorAll('.nav-button');

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          sections.forEach((sec) => sec.classList.add('hidden'));
          const target = document.getElementById(btn.dataset.target);
          if (target) {
            target.classList.remove('hidden');
            const content = target.querySelector('.content');
            const loader = target.querySelector('.loader');
            content.classList.add('hidden');
            loader.classList.remove('hidden');
            setTimeout(() => {
              loader.classList.add('hidden');
              content.classList.remove('hidden');
            }, 800);
          }
        });
      });

      // Customer Account Info search logic
      const form = document.getElementById('customerSearchForm');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          editing = false;
          const kgid = document.getElementById('kgidInput').value.trim();
          const resultDiv = document.getElementById('customerInfoResult');
          resultDiv.innerHTML = '<div class="text-blue-600">Loading...</div>';
          try {
            const res = await fetch(`/api/customer?kgid=${encodeURIComponent(kgid)}`);
            if (res.ok) {
              const data = await res.json();
              currentData = data;
              if (data && data.name) {
                resultDiv.innerHTML = renderCustomerInfo(data, false);
                attachEditHandler(data);
              } else {
                resultDiv.innerHTML = `
                  <div class="text-red-600 font-semibold mb-4">No account found for KGID: ${kgid}</div>
                  <button onclick="window.location.href='landing page.html'" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Create Account</button>
                `;
              }
            } else {
              resultDiv.innerHTML = `<div class="text-red-600">Error fetching data.</div>`;
            }
          } catch {
            resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
          }
        });
      }

      let editing = false;
      let currentData = null;

      function renderCustomerInfo(data, editable) {
        if (!editable) {
          return `
            <div class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
              <div class="mb-4">
                <p><strong>Name:</strong> ${data.name}</p>
                <p><strong>KGID:</strong> ${data.kgid}</p>
                <p><strong>Phone:</strong> ${data.phone}</p>
                <p><strong>Email:</strong> ${data.email}</p>
                <p><strong>Address:</strong> ${data.address}</p>
              </div>
              <button id="editProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Edit Profile</button>
            </div>
          `;
        } else {
          return `
            <form id="editProfileForm" class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
              <div class="mb-4">
                <label class="block mb-1 font-medium">Name</label>
                <input type="text" name="name" value="${data.name}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">KGID</label>
                <input type="text" name="kgid" value="${data.kgid}" class="w-full px-4 py-2 border rounded mb-2" disabled />
                <label class="block mb-1 font-medium">Phone</label>
                <input type="text" name="phone" value="${data.phone}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">Email</label>
                <input type="email" name="email" value="${data.email}" class="w-full px-4 py-2 border rounded mb-2" />
                <label class="block mb-1 font-medium">Address</label>
                <input type="text" name="address" value="${data.address}" class="w-full px-4 py-2 border rounded mb-2" />
              </div>
              <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded shadow">Update</button>
            </form>
          `;
        }
      }

      function attachEditHandler(data) {
        const editBtn = document.getElementById('editProfileBtn');
        if (editBtn) {
          editBtn.onclick = function() {
            editing = true;
            const resultDiv = document.getElementById('customerInfoResult');
            resultDiv.innerHTML = renderCustomerInfo(data, true);
            attachUpdateHandler();
          };
        }
      }

      function attachUpdateHandler() {
        const editForm = document.getElementById('editProfileForm');
        if (editForm) {
          editForm.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(editForm);
            const updatedData = {
              name: formData.get('name'),
              kgid: formData.get('kgid'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address')
            };
            const resultDiv = document.getElementById('customerInfoResult');
            resultDiv.innerHTML = '<div class="text-blue-600">Updating...</div>';
            try {
              const res = await fetch(`/api/customer/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
              });
              if (res.ok) {
                resultDiv.innerHTML = renderCustomerInfo(updatedData, false);
                attachEditHandler(updatedData);
              } else {
                resultDiv.innerHTML = `<div class="text-red-600">Update failed.</div>`;
              }
            } catch {
              resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
            }
          };
        }
      }

      /* -------- Loan Type Toggle Logic -------- */
      const normalLoanBtn = document.getElementById("normalLoanBtn");
      const emergencyLoanBtn = document.getElementById("emergencyLoanBtn");
      const normalLoanForm = document.getElementById("normalLoanForm");
      const emergencyLoanForm = document.getElementById("emergencyLoanForm");

      if (normalLoanBtn && emergencyLoanBtn && normalLoanForm && emergencyLoanForm) {
        normalLoanBtn.addEventListener("click", () => {
          normalLoanForm.style.display = "block";
          emergencyLoanForm.style.display = "none";
          normalLoanBtn.classList.add("bg-blue-600", "text-white");
          normalLoanBtn.classList.remove("bg-gray-300", "text-black");
          emergencyLoanBtn.classList.add("bg-gray-300", "text-black");
          emergencyLoanBtn.classList.remove("bg-blue-600", "text-white");
        });

        emergencyLoanBtn.addEventListener("click", () => {
          normalLoanForm.style.display = "none";
          emergencyLoanForm.style.display = "block";
          emergencyLoanBtn.classList.add("bg-blue-600", "text-white");
          emergencyLoanBtn.classList.remove("bg-gray-300", "text-black");
          normalLoanBtn.classList.add("bg-gray-300", "text-black");
          normalLoanBtn.classList.remove("bg-blue-600", "text-white");
        });
      }

      /* -------- Loan Apply Section Integration -------- */
      // Normal Loan/Emergency Loan form selectors
      // (already declared above)

      // Helper to fetch surety details and show in UI
      async function fetchSuretyDetails(customerId, displayDiv) {
        if (!customerId) {
          displayDiv.innerHTML = '';
          return;
        }
        displayDiv.innerHTML = '<span class="text-blue-600">Checking...</span>';
        try {
          const res = await fetch(`/loan/surety/${encodeURIComponent(customerId)}`);
          if (res.ok) {
            const data = await res.json();
            if (data.status === "success") {
              const m = data.member;
              displayDiv.innerHTML = `
                <div class="text-green-700 text-sm flex items-center gap-2">
                  <img src="${m.photo_url || ''}" alt="Photo" style="height:32px;width:32px;border-radius:50%;border:1px solid #ccc;">
                  <img src="${m.signature_url || ''}" alt="Signature" style="height:32px;width:64px;border:1px solid #ccc;">
                  <div>
                    <div><b>${m.name || ''}</b> (${m.customer_id || ''})</div>
                    <div>Phone: ${m.phone || ''}</div>
                    <div>Active Loans Backed: <b>${data.active_loan_count}</b></div>
                  </div>
                </div>
              `;
            } else {
              displayDiv.innerHTML = `<span class="text-red-600 text-sm">Surety not found or error.</span>`;
            }
          } else {
            displayDiv.innerHTML = `<span class="text-red-600 text-sm">Surety not found or error.</span>`;
          }
        } catch {
          displayDiv.innerHTML = `<span class="text-red-600 text-sm">Network error.</span>`;
        }
      }

      // Attach listeners to Normal Loan form
      if (normalLoanForm) {
        // Remove old surety fields, add only customer_id fields and info display
        const suretyFields = normalLoanForm.querySelectorAll('input[placeholder^="Surety"], input[placeholder="Phone Number"]');
        suretyFields.forEach(f => f.parentElement.remove());

        // Add new surety customer_id fields and info
        const suretySection = document.createElement('div');
        suretySection.className = "mb-4";
        suretySection.innerHTML = `
          <label class="block mb-1 font-medium">Surety 1 Customer ID</label>
          <input type="text" id="normalSurety1Input" placeholder="Surety 1 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="normalSurety1Info" class="mb-2"></div>
          <label class="block mb-1 font-medium">Surety 2 Customer ID (optional)</label>
          <input type="text" id="normalSurety2Input" placeholder="Surety 2 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="normalSurety2Info" class="mb-2"></div>
        `;
        normalLoanForm.appendChild(suretySection);

        const surety1Input = document.getElementById('normalSurety1Input');
        const surety2Input = document.getElementById('normalSurety2Input');
        const surety1Div = document.getElementById('normalSurety1Info');
        const surety2Div = document.getElementById('normalSurety2Info');
        const applyBtn = normalLoanForm.querySelector('button');

        surety1Input && surety1Input.addEventListener('blur', () => fetchSuretyDetails(surety1Input.value, surety1Div));
        surety2Input && surety2Input.addEventListener('blur', () => fetchSuretyDetails(surety2Input.value, surety2Div));

        applyBtn && applyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          // Collect form data
          const name = normalLoanForm.querySelector('input[placeholder="Name"]').value.trim();
          const kgid = normalLoanForm.querySelector('input[placeholder="KGID"]').value.trim();
          const interest_rate = normalLoanForm.querySelector('input[placeholder="Interest Rate"]').value.trim();
          const account_number = normalLoanForm.querySelector('input[placeholder="Account Number"]').value.trim();
          const loan_purpose = normalLoanForm.querySelector('input[placeholder="Loan Purpose"]').value.trim();
          const loan_amount = normalLoanForm.querySelector('input[placeholder="Loan Amount"]').value.trim();
          const loan_tenure = normalLoanForm.querySelector('input[placeholder="Loan Tenure"]').value.trim();
          const surety1 = surety1Input.value.trim();
          const surety2 = surety2Input.value.trim();

          if (!name || !kgid || !interest_rate || !account_number || !loan_purpose || !loan_amount || !loan_tenure || !surety1) {
            alert("Please fill all required fields including at least one surety.");
            return;
          }

          const payload = {
            name,
            kgid,
            interest_rate,
            account_number,
            loan_purpose,
            loan_amount,
            loan_tenure,
            sureties: surety2 ? [surety1, surety2] : [surety1]
          };

          applyBtn.disabled = true;
          applyBtn.textContent = "Applying...";

          try {
            const res = await fetch('/loan/apply', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === 'success') {
              alert("Loan application submitted successfully!");
              normalLoanForm.reset();
              surety1Div.innerHTML = '';
              surety2Div.innerHTML = '';
            } else {
              alert("Loan application failed: " + (data.message || "Unknown error"));
            }
          } catch {
            alert("Network error during loan application.");
          } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = "Apply Normal Loan";
          }
        });
      }

      // Attach listeners to Emergency Loan form (similar logic)
      if (emergencyLoanForm) {
        // Remove old surety fields, add only customer_id fields and info display
        const suretyFields = emergencyLoanForm.querySelectorAll('input[placeholder^="Surety"], input[placeholder="Phone Number"]');
        suretyFields.forEach(f => f.parentElement.remove());

        const suretySection = document.createElement('div');
        suretySection.className = "mb-4";
        suretySection.innerHTML = `
          <label class="block mb-1 font-medium">Surety 1 Customer ID</label>
          <input type="text" id="emergencySurety1Input" placeholder="Surety 1 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="emergencySurety1Info" class="mb-2"></div>
          <label class="block mb-1 font-medium">Surety 2 Customer ID (optional)</label>
          <input type="text" id="emergencySurety2Input" placeholder="Surety 2 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="emergencySurety2Info" class="mb-2"></div>
        `;
        emergencyLoanForm.appendChild(suretySection);

        const surety1Input = document.getElementById('emergencySurety1Input');
        const surety2Input = document.getElementById('emergencySurety2Input');
        const surety1Div = document.getElementById('emergencySurety1Info');
        const surety2Div = document.getElementById('emergencySurety2Info');
        const applyBtn = emergencyLoanForm.querySelector('button');

        surety1Input && surety1Input.addEventListener('blur', () => fetchSuretyDetails(surety1Input.value, surety1Div));
        surety2Input && surety2Input.addEventListener('blur', () => fetchSuretyDetails(surety2Input.value, surety2Div));

        applyBtn && applyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          // Collect form data
          const name = emergencyLoanForm.querySelector('input[placeholder="Name"]').value.trim();
          const kgid = emergencyLoanForm.querySelector('input[placeholder="KGID"]').value.trim();
          const interest_rate = emergencyLoanForm.querySelector('input[placeholder="Interest Rate"]').value.trim();
          const account_number = emergencyLoanForm.querySelector('input[placeholder="Account Number"]').value.trim();
          const loan_purpose = emergencyLoanForm.querySelector('input[placeholder="Loan Purpose"]').value.trim();
          const loan_amount = emergencyLoanForm.querySelector('input[placeholder="Loan Amount"]').value.trim();
          const loan_tenure = emergencyLoanForm.querySelector('input[placeholder="Loan Tenure"]').value.trim();
          const surety1 = surety1Input.value.trim();
          const surety2 = surety2Input.value.trim();

          if (!name || !kgid || !interest_rate || !account_number || !loan_purpose || !loan_amount || !loan_tenure || !surety1) {
            alert("Please fill all required fields including at least one surety.");
            return;
          }

          const payload = {
            name,
            kgid,
            interest_rate,
            account_number,
            loan_purpose,
            loan_amount,
            loan_tenure,
            sureties: surety2 ? [surety1, surety2] : [surety1]
          };

          applyBtn.disabled = true;
          applyBtn.textContent = "Applying...";

          try {
            const res = await fetch('/loan/apply', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === 'success') {
              alert("Loan application submitted successfully!");
              emergencyLoanForm.reset();
              surety1Div.innerHTML = '';
              surety2Div.innerHTML = '';
            } else {
              alert("Loan application failed: " + (data.message || "Unknown error"));
            }
          } catch {
            alert("Network error during loan application.");
          } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = "Apply Emergency Loan";
          }
        });
      }

      // Show Add User section by default
      document.querySelectorAll('.dynamic-section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById('addUser').classList.remove('hidden');
    });
  </script>
</head>
<body class="bg-gray-50">
  <!-- Header - Updated to match landing page style -->
  <header class="w-full bg-white shadow-lg">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold text-xl">F</div>
        <span class="text-2xl font-bold text-blue-700">FinanceApp</span>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-gray-700">Welcome, Staff</span>
        <a href="{{ url_for('staff_api.staff_logout') }}" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition">Logout</a>
      </div>
    </div>
  </header>

  <div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar - Updated style -->
    <aside class="w-64 bg-white shadow-lg p-6 space-y-4">
      <h2 class="font-bold text-xl text-blue-700 mb-6">Staff Dashboard</h2>
      <nav class="space-y-3">
        <a href="landing page.html" class="block w-full px-4 py-2 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 text-left transition">🏠 Home</a>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="applyLoan">📝 Apply Loan</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="accountInfo">👤 Customer Info</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="addUser">➕ Add User</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="checkExpense">💸 Check Expense</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="depositWithdraw">🏦 Deposit/Withdraw</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="loanRepayment">💰 Loan Repayment</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="nextInstallment">📆 Next Installment</button>
        <button type="button" class="nav-button w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="checkTransaction">🔎 Check Transaction</button>
      </nav>
    </aside>

    <!-- Main content area - Updated style -->
    <main class="flex-1 p-8 space-y-6">
      <section id="applyLoan" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content space-y-8">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Apply for Loan</h2>
          <!-- Switch buttons side by side -->
          <div class="flex flex-row space-x-4 mb-6">
            <button id="normalLoanBtn" class="px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 transition">Normal Loan</button>
            <button id="emergencyLoanBtn" class="px-4 py-2 bg-gray-300 text-black rounded shadow hover:bg-gray-400 transition">Emergency Loan</button>
          </div>
          <!-- Loan Containers, only one visible at a time -->
          <div id="normalLoanForm" class="bg-white p-6 rounded-xl shadow text-center">
            <h3 class="text-lg font-semibold mb-4 text-blue-700">Normal Loan</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <input type="text" placeholder="Name" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="KGID" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Interest Rate" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Account Number" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Loan Purpose" class="w-full px-4 py-2 border rounded" />
              <input type="number" placeholder="Loan Amount" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Loan Tenure" class="w-full px-4 py-2 border rounded" />
            </div>
            <div class="mt-4 text-left">
              <h4 class="font-semibold mb-2 text-gray-700">Sureties (Max 2)</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" placeholder="Surety 1" class="w-full px-4 py-2 border rounded mb-2" />
                <input type="number" placeholder="Phone Number" class="w-full px-4 py-2 border rounded mb-2" />
                <input type="text" placeholder="Surety 2" class="w-full px-4 py-2 border rounded mb-2" />
                <input type="number" placeholder="Phone Number" class="w-full px-4 py-2 border rounded mb-2" />
              </div>
            </div>
            <button class="mt-6 bg-blue-500 text-white px-6 py-2 rounded w-full shadow hover:bg-blue-600 transition">Apply Normal Loan</button>
          </div>
          <div id="emergencyLoanForm" class="bg-white p-6 rounded-xl shadow text-center" style="display:none;">
            <h3 class="text-lg font-semibold mb-4 text-blue-700">Emergency Loan</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <input type="text" placeholder="Name" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="KGID" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Interest Rate" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Account Number" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Loan Purpose" class="w-full px-4 py-2 border rounded" />
              <input type="number" placeholder="Loan Amount" class="w-full px-4 py-2 border rounded" />
              <input type="text" placeholder="Loan Tenure" class="w-full px-4 py-2 border rounded" />
            </div>
            <div class="mt-4 text-left">
              <h4 class="font-semibold mb-2 text-gray-700">Sureties (Max 2)</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" placeholder="Surety 1" class="w-full px-4 py-2 border rounded mb-2" />
                <input type="number" placeholder="Phone Number" class="w-full px-4 py-2 border rounded mb-2" />
                <input type="text" placeholder="Surety 2" class="w-full px-4 py-2 border rounded mb-2" />
                <input type="number" placeholder="Phone Number" class="w-full px-4 py-2 border rounded mb-2" />
              </div>
            </div>
            <button class="mt-6 bg-blue-500 text-white px-6 py-2 rounded w-full shadow hover:bg-blue-600 transition">Apply Emergency Loan</button>
          </div>
        </div>
      </section>

      <section id="accountInfo" class="dynamic-section hidden bg-white p-6 rounded shadow">
        <div class="loader hidden text-center text-blue-600">Loading...</div>
        <div class="content">
          <h2 class="text-xl font-bold text-blue-700 mb-4">Customer Account Info</h2>
          <form id="customerSearchForm" class="mb-4 flex gap-2">
            <input type="text" id="kgidInput" placeholder="Enter Account Number" class="border p-2 w-full rounded" />
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Search</button>
          </form>
          <div id="customerInfoResult"></div>
        </div>
      </section>
      <script>
document.addEventListener('DOMContentLoaded', () => {
  let editing = false;
  let currentData = null;

  const form = document.getElementById('customerSearchForm');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      editing = false;
      const kgid = document.getElementById('kgidInput').value.trim();
      const resultDiv = document.getElementById('customerInfoResult');
      resultDiv.innerHTML = '<div class="text-blue-600">Loading...</div>';
      try {
        const res = await fetch(`/api/customer?kgid=${encodeURIComponent(kgid)}`);
        if (res.ok) {
          const data = await res.json();
          currentData = data;
          if (data && data.name) {
            resultDiv.innerHTML = renderCustomerInfo(data, false);
            attachEditHandler(data);
          } else {
            resultDiv.innerHTML = `
              <div class="text-red-600 font-semibold mb-4">No account found for KGID: ${kgid}</div>
              <button onclick="window.location.href='landing page.html'" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Create Account</button>
            `;
          }
        } else {
          resultDiv.innerHTML = `<div class="text-red-600">Error fetching data.</div>`;
        }
      } catch {
        resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
      }
    });
  }

  function renderCustomerInfo(data, editable) {
    if (!editable) {
      return `
        <div class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
          <div class="mb-4">
            <p><strong>Name:</strong> ${data.name}</p>
            <p><strong>KGID:</strong> ${data.kgid}</p>
            <p><strong>Phone:</strong> ${data.phone}</p>
            <p><strong>Email:</strong> ${data.email}</p>
            <p><strong>Address:</strong> ${data.address}</p>
          </div>
          <button id="editProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Edit Profile</button>
        </div>
      `;
    } else {
      return `
        <form id="editProfileForm" class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
          <div class="mb-4">
            <label class="block mb-1 font-medium">Name</label>
            <input type="text" name="name" value="${data.name}" class="w-full px-4 py-2 border rounded mb-2" />
            <label class="block mb-1 font-medium">KGID</label>
            <input type="text" name="kgid" value="${data.kgid}" class="w-full px-4 py-2 border rounded mb-2" disabled />
            <label class="block mb-1 font-medium">Phone</label>
            <input type="text" name="phone" value="${data.phone}" class="w-full px-4 py-2 border rounded mb-2" />
            <label class="block mb-1 font-medium">Email</label>
            <input type="text" name="Adhar " value="${data.dhar}" class="w-full px-4 py-2 border rounded mb-2" />
            <label class="block mb-1 font-medium">Email</label>
            <input type="text" name="Pan" value="${data.pan}" class="w-full px-4 py-2 border rounded mb-2" />
            <label class="block mb-1 font-medium">Email</label>
            <input type="email" name="email" value="${data.email}" class="w-full px-4 py-2 border rounded mb-2" />
            <label class="block mb-1 font-medium">Address</label>
            <input type="text" name="address" value="${data.address}" class="w-full px-4 py-2 border rounded mb-2" />
            <input type="text" name="Current Balance " value="${data.balance}" class="w-full px-4 py-2 border rounded mb-2" />
            <label class="block mb-1 font-medium">Email</label>
          </div>
          <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded shadow">Update</button>
        </form>
      `;
    }
  }

  function attachEditHandler(data) {
    const editBtn = document.getElementById('editProfileBtn');
    if (editBtn) {
      editBtn.onclick = function() {
        editing = true;
        const resultDiv = document.getElementById('customerInfoResult');
        resultDiv.innerHTML = renderCustomerInfo(data, true);
        attachUpdateHandler();
      };
    }
  }

  function attachUpdateHandler() {
    const editForm = document.getElementById('editProfileForm');
    if (editForm) {
      editForm.onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(editForm);
        const updatedData = {
          name: formData.get('name'),
          kgid: formData.get('kgid'),
          phone: formData.get('phone'),
          email: formData.get('email'),
          address: formData.get('address')
        };
        const resultDiv = document.getElementById('customerInfoResult');
        resultDiv.innerHTML = '<div class="text-blue-600">Updating...</div>';
        try {
          const res = await fetch(`/api/customer/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
          });
          if (res.ok) {
            resultDiv.innerHTML = renderCustomerInfo(updatedData, false);
            attachEditHandler(updatedData);
          } else {
            resultDiv.innerHTML = `<div class="text-red-600">Update failed.</div>`;
          }
        } catch {
          resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
        }
      };
    }
  }

      /* -------- Loan Type Toggle Logic -------- */
      const normalLoanBtn = document.getElementById("normalLoanBtn");
      const emergencyLoanBtn = document.getElementById("emergencyLoanBtn");
      const normalLoanForm = document.getElementById("normalLoanForm");
      const emergencyLoanForm = document.getElementById("emergencyLoanForm");

      if (normalLoanBtn && emergencyLoanBtn && normalLoanForm && emergencyLoanForm) {
        normalLoanBtn.addEventListener("click", () => {
          normalLoanForm.style.display = "block";
          emergencyLoanForm.style.display = "none";
          normalLoanBtn.classList.add("bg-blue-600", "text-white");
          normalLoanBtn.classList.remove("bg-gray-300", "text-black");
          emergencyLoanBtn.classList.add("bg-gray-300", "text-black");
          emergencyLoanBtn.classList.remove("bg-blue-600", "text-white");
        });

        emergencyLoanBtn.addEventListener("click", () => {
          normalLoanForm.style.display = "none";
          emergencyLoanForm.style.display = "block";
          emergencyLoanBtn.classList.add("bg-blue-600", "text-white");
          emergencyLoanBtn.classList.remove("bg-gray-300", "text-black");
          normalLoanBtn.classList.add("bg-gray-300", "text-black");
          normalLoanBtn.classList.remove("bg-blue-600", "text-white");
        });
      }

      /* -------- Loan Apply Section Integration -------- */
      // Normal Loan/Emergency Loan form selectors
      // (already declared above)

      // Helper to fetch surety details and show in UI
      async function fetchSuretyDetails(customerId, displayDiv) {
        if (!customerId) {
          displayDiv.innerHTML = '';
          return;
        }
        displayDiv.innerHTML = '<span class="text-blue-600">Checking...</span>';
        try {
          const res = await fetch(`/loan/surety/${encodeURIComponent(customerId)}`);
          if (res.ok) {
            const data = await res.json();
            if (data.status === "success") {
              const m = data.member;
              displayDiv.innerHTML = `
                <div class="text-green-700 text-sm flex items-center gap-2">
                  <img src="${m.photo_url || ''}" alt="Photo" style="height:32px;width:32px;border-radius:50%;border:1px solid #ccc;">
                  <img src="${m.signature_url || ''}" alt="Signature" style="height:32px;width:64px;border:1px solid #ccc;">
                  <div>
                    <div><b>${m.name || ''}</b> (${m.customer_id || ''})</div>
                    <div>Phone: ${m.phone || ''}</div>
                    <div>Active Loans Backed: <b>${data.active_loan_count}</b></div>
                  </div>
                </div>
              `;
            } else {
              displayDiv.innerHTML = `<span class="text-red-600 text-sm">Surety not found or error.</span>`;
            }
          } else {
            displayDiv.innerHTML = `<span class="text-red-600 text-sm">Surety not found or error.</span>`;
          }
        } catch {
          displayDiv.innerHTML = `<span class="text-red-600 text-sm">Network error.</span>`;
        }
      }

      // Attach listeners to Normal Loan form
      if (normalLoanForm) {
        // Remove old surety fields, add only customer_id fields and info display
        const suretyFields = normalLoanForm.querySelectorAll('input[placeholder^="Surety"], input[placeholder="Phone Number"]');
        suretyFields.forEach(f => f.parentElement.remove());

        // Add new surety customer_id fields and info
        const suretySection = document.createElement('div');
        suretySection.className = "mb-4";
        suretySection.innerHTML = `
          <label class="block mb-1 font-medium">Surety 1 Customer ID</label>
          <input type="text" id="normalSurety1Input" placeholder="Surety 1 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="normalSurety1Info" class="mb-2"></div>
          <label class="block mb-1 font-medium">Surety 2 Customer ID (optional)</label>
          <input type="text" id="normalSurety2Input" placeholder="Surety 2 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="normalSurety2Info" class="mb-2"></div>
        `;
        normalLoanForm.appendChild(suretySection);

        const surety1Input = document.getElementById('normalSurety1Input');
        const surety2Input = document.getElementById('normalSurety2Input');
        const surety1Div = document.getElementById('normalSurety1Info');
        const surety2Div = document.getElementById('normalSurety2Info');
        const applyBtn = normalLoanForm.querySelector('button');

        surety1Input && surety1Input.addEventListener('blur', () => fetchSuretyDetails(surety1Input.value, surety1Div));
        surety2Input && surety2Input.addEventListener('blur', () => fetchSuretyDetails(surety2Input.value, surety2Div));

        applyBtn && applyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          // Collect form data
          const name = normalLoanForm.querySelector('input[placeholder="Name"]').value.trim();
          const kgid = normalLoanForm.querySelector('input[placeholder="KGID"]').value.trim();
          const interest_rate = normalLoanForm.querySelector('input[placeholder="Interest Rate"]').value.trim();
          const account_number = normalLoanForm.querySelector('input[placeholder="Account Number"]').value.trim();
          const loan_purpose = normalLoanForm.querySelector('input[placeholder="Loan Purpose"]').value.trim();
          const loan_amount = normalLoanForm.querySelector('input[placeholder="Loan Amount"]').value.trim();
          const loan_tenure = normalLoanForm.querySelector('input[placeholder="Loan Tenure"]').value.trim();
          const surety1 = surety1Input.value.trim();
          const surety2 = surety2Input.value.trim();

          if (!name || !kgid || !interest_rate || !account_number || !loan_purpose || !loan_amount || !loan_tenure || !surety1) {
            alert("Please fill all required fields including at least one surety.");
            return;
          }

          const payload = {
            name,
            kgid,
            interest_rate,
            account_number,
            loan_purpose,
            loan_amount,
            loan_tenure,
            sureties: surety2 ? [surety1, surety2] : [surety1]
          };

          applyBtn.disabled = true;
          applyBtn.textContent = "Applying...";

          try {
            const res = await fetch('/loan/apply', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === 'success') {
              alert("Loan application submitted successfully!");
              normalLoanForm.reset();
              surety1Div.innerHTML = '';
              surety2Div.innerHTML = '';
            } else {
              alert("Loan application failed: " + (data.message || "Unknown error"));
            }
          } catch {
            alert("Network error during loan application.");
          } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = "Apply Normal Loan";
          }
        });
      }

      // Attach listeners to Emergency Loan form (similar logic)
      if (emergencyLoanForm) {
        // Remove old surety fields, add only customer_id fields and info display
        const suretyFields = emergencyLoanForm.querySelectorAll('input[placeholder^="Surety"], input[placeholder="Phone Number"]');
        suretyFields.forEach(f => f.parentElement.remove());

        const suretySection = document.createElement('div');
        suretySection.className = "mb-4";
        suretySection.innerHTML = `
          <label class="block mb-1 font-medium">Surety 1 Customer ID</label>
          <input type="text" id="emergencySurety1Input" placeholder="Surety 1 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="emergencySurety1Info" class="mb-2"></div>
          <label class="block mb-1 font-medium">Surety 2 Customer ID (optional)</label>
          <input type="text" id="emergencySurety2Input" placeholder="Surety 2 Customer ID" class="w-full px-4 py-2 border rounded mb-2" />
          <div id="emergencySurety2Info" class="mb-2"></div>
        `;
        emergencyLoanForm.appendChild(suretySection);

        const surety1Input = document.getElementById('emergencySurety1Input');
        const surety2Input = document.getElementById('emergencySurety2Input');
        const surety1Div = document.getElementById('emergencySurety1Info');
        const surety2Div = document.getElementById('emergencySurety2Info');
        const applyBtn = emergencyLoanForm.querySelector('button');

        surety1Input && surety1Input.addEventListener('blur', () => fetchSuretyDetails(surety1Input.value, surety1Div));
        surety2Input && surety2Input.addEventListener('blur', () => fetchSuretyDetails(surety2Input.value, surety2Div));

        applyBtn && applyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          // Collect form data
          const name = emergencyLoanForm.querySelector('input[placeholder="Name"]').value.trim();
          const kgid = emergencyLoanForm.querySelector('input[placeholder="KGID"]').value.trim();
          const interest_rate = emergencyLoanForm.querySelector('input[placeholder="Interest Rate"]').value.trim();
          const account_number = emergencyLoanForm.querySelector('input[placeholder="Account Number"]').value.trim();
          const loan_purpose = emergencyLoanForm.querySelector('input[placeholder="Loan Purpose"]').value.trim();
          const loan_amount = emergencyLoanForm.querySelector('input[placeholder="Loan Amount"]').value.trim();
          const loan_tenure = emergencyLoanForm.querySelector('input[placeholder="Loan Tenure"]').value.trim();
          const surety1 = surety1Input.value.trim();
          const surety2 = surety2Input.value.trim();

          if (!name || !kgid || !interest_rate || !account_number || !loan_purpose || !loan_amount || !loan_tenure || !surety1) {
            alert("Please fill all required fields including at least one surety.");
            return;
          }

          const payload = {
            name,
            kgid,
            interest_rate,
            account_number,
            loan_purpose,
            loan_amount,
            loan_tenure,
            sureties: surety2 ? [surety1, surety2] : [surety1]
          };

          applyBtn.disabled = true;
          applyBtn.textContent = "Applying...";

          try {
            const res = await fetch('/loan/apply', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === 'success') {
              alert("Loan application submitted successfully!");
              emergencyLoanForm.reset();
              surety1Div.innerHTML = '';
              surety2Div.innerHTML = '';
            } else {
              alert("Loan application failed: " + (data.message || "Unknown error"));
            }
          } catch {
            alert("Network error during loan application.");
          } finally {
            applyBtn.disabled = false;
            applyBtn.textContent = "Apply Emergency Loan";
          }
        });
      }

      // Show Add User section by default
      document.querySelectorAll('.dynamic-section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById('addUser').classList.remove('hidden');
    });
  </script>

  <!-- Place this above the customer info/search section -->
  <div id="customerMsg" class="mb-4 text-center text-sm font-semibold" style="display:none;"></div>

  <section id="addUser" class="dynamic-section bg-white p-6 rounded shadow">
    <div class="loader hidden text-center text-blue-600">Loading...</div>
    <div class="content">
      <h2 class="text-xl font-bold text-blue-700 mb-4">Add New User</h2>
      <!-- Move message box here, styled as alert -->
      <div id="addUserMsg" class="mb-4 text-center hidden"></div>
      <form id="addUserForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- First / Middle / Last Name -->
          <div>
            <label class="block text-sm font-medium mb-1">First Name</label>
            <input type="text" name="first_name" placeholder="First Name" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Middle Name</label>
            <input type="text" name="middle_name" placeholder="Middle Name" class="border p-2 rounded w-full" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Last Name</label>
            <input type="text" name="last_name" placeholder="Last Name" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">KGID</label>
            <input type="text" name="kgid" placeholder="KGID" class="border p-2 rounded w-full" required />
          </div>
          <!-- Phone & Email Row -->
          <div>
            <label class="block text-sm font-medium mb-1">Phone Number</label>
            <input type="text" name="phone" placeholder="Phone Number" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <div class="flex gap-2">
              <input type="email" name="email" id="emailInput" placeholder="Email" class="border p-2 rounded w-full" required />
              <button type="button" id="verifyEmailBtn" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600">
                Verify
              </button>
            </div>
          </div>
          <!-- OTP Input -->
          <div id="otpContainer" class="col-span-1 md:col-span-2 hidden">
            <label class="block text-sm font-medium mb-1">Enter OTP</label>
            <input type="text" id="otpInput" name="otp" placeholder="Enter OTP" class="border p-2 rounded w-full" />
          </div>
          <!-- More User Details -->
          <div>
            <label class="block text-sm font-medium mb-1">Father's Name</label>
            <input type="text" name="father_name" placeholder="Father's Name" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Salary</label>
            <input type="text" name="salary" placeholder="Salary" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Organization Name</label>
            <input type="text" name="organization_name" placeholder="Organization Name" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Aadhar Number</label>
            <input type="text" name="aadhar_no" placeholder="Aadhar Number" class="border p-2 rounded w-full" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">PAN Number</label>
            <input type="text" name="pan_no" placeholder="PAN Number" class="border p-2 rounded w-full" required />
          </div>
          <!-- Address -->
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium mb-1">Address</label>
            <textarea name="address" placeholder="Address" class="border p-2 rounded w-full" required></textarea>
          </div>
          <!-- Photo Upload -->
          <div>
            <label class="block text-sm font-medium mb-1">Upload Photo <span class="text-xs text-gray-500">(Image must be below 50KB)</span></label>
            <input type="file" name="photo" class="border p-2 rounded w-full" accept="image/*" required />
          </div>
          <!-- Signature Upload -->
          <div>
            <label class="block text-sm font-medium mb-1">Upload Signature <span class="text-xs text-gray-500">(Image must be below 50KB)</span></label>
            <input type="file" name="signature" class="border p-2 rounded w-full" accept="image/*" required />
          </div>
        </div>
        <!-- Warning Message -->
        <p id="verifyWarning" class="text-red-500 mt-2 hidden col-span-1 md:col-span-2">⚠ Please verify your email before proceeding.</p>
        <button id="addUserBtn" type="submit" class="mt-4 px-4 py-2 bg-green-500 text-white rounded">Add User</button>
      </form>
    </div>
  </section>
  <script>
(function() {
  let otpSent = false;
  let otpVerified = false;

  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Add User script loaded');
    
    const verifyBtn = document.getElementById('verifyEmailBtn');
    const otpContainer = document.getElementById('otpContainer');
    const otpInput = document.getElementById('otpInput');
    const warning = document.getElementById('verifyWarning');
    const addUserBtn = document.getElementById('addUserBtn');
    const addUserForm = document.getElementById('addUserForm');
    const addUserMsg = document.getElementById('addUserMsg');
    const emailInput = document.getElementById('emailInput');

    if (!verifyBtn) {
      console.error('Verify button not found!');
      return;
    }

    console.log('All elements found, attaching event listeners');

    // Send OTP to email
    verifyBtn.addEventListener('click', async function() {
      console.log('Verify button clicked');
      
      const email = emailInput.value.trim();
      
      // Show message box and set initial styling
      addUserMsg.classList.remove('hidden');
      addUserMsg.className = "mb-4 text-center bg-blue-100 text-blue-700 px-4 py-2 rounded shadow";
      
      if (!email) {
        addUserMsg.textContent = "Please enter an email.";
        addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
        return;
      }
      
      verifyBtn.disabled = true;
      verifyBtn.textContent = "Sending...";
      addUserMsg.textContent = "Sending OTP...";
      
      try {
        const formData = new FormData();
        formData.append('email', email);
        
        console.log('Sending request to /staff/api/add-member/send-otp');
        
        const response = await fetch('/staff/api/add-member/send-otp', {
          method: 'POST',
          body: formData
        });
        
        console.log('Response status:', response.status);
        
        let data;
        try {
          data = await response.json();
          console.log('Response data:', data);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          addUserMsg.textContent = "Server error. Invalid response format.";
          addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify";
          return;
        }
        
        if (data.status === 'success') {
          otpContainer.classList.remove('hidden');
          otpInput.focus();
          addUserMsg.textContent = "OTP sent to email. Enter OTP to continue.";
          addUserMsg.className = "mb-4 text-center bg-green-100 text-green-700 px-4 py-2 rounded shadow";
          otpSent = true;
          verifyBtn.textContent = "OTP Sent";
        } else {
          addUserMsg.textContent = data.message || "Failed to send OTP.";
          addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify";
        }
      } catch (error) {
        console.error('Network error:', error);
        addUserMsg.textContent = "Network error. Check your connection.";
        addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
        verifyBtn.disabled = false;
        verifyBtn.textContent = "Verify";
      }
    });

    // OTP input handler
    otpInput.addEventListener('input', function() {
      if (otpInput.value.length >= 6) {
        otpVerified = true;
        otpInput.classList.add('border-green-500');
        addUserMsg.textContent = "OTP verified!";
        addUserMsg.className = "mb-4 text-center bg-green-100 text-green-700 px-4 py-2 rounded shadow";
      } else {
        otpVerified = false;
        otpInput.classList.remove('border-green-500');
      }
    });

    // Form submit handler
    addUserForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!otpSent || !otpVerified) {
        warning.classList.remove('hidden');
        addUserMsg.textContent = "Please verify your email and enter OTP.";
        addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
        addUserMsg.classList.remove('hidden');
        return;
      }
      
      warning.classList.add('hidden');
      addUserMsg.textContent = "Submitting user...";
      addUserMsg.className = "mb-4 text-center bg-blue-100 text-blue-700 px-4 py-2 rounded shadow";
      addUserBtn.disabled = true;
      
      const formData = new FormData(addUserForm);

      // Combine first/middle/last name into 'name'
      const name = [
        formData.get('first_name') || '',
        formData.get('middle_name') || '',
        formData.get('last_name') || ''
      ].filter(Boolean).join(' ');
      formData.set('name', name);

      // Remove individual name fields
      formData.delete('first_name');
      formData.delete('middle_name');
      formData.delete('last_name');

      try {
        const response = await fetch('/staff/api/add-member', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          addUserMsg.textContent = "User added successfully!";
          addUserMsg.className = "mb-4 text-center bg-green-100 text-green-700 px-4 py-2 rounded shadow";
          addUserForm.reset();
          otpContainer.classList.add('hidden');
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify";
          otpSent = false;
          otpVerified = false;
        } else {
          addUserMsg.textContent = data.message || "Failed to add user.";
          addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
        }
      } catch (error) {
        console.error('Submit error:', error);
        addUserMsg.textContent = "Network error during submission.";
        addUserMsg.className = "mb-4 text-center bg-red-100 text-red-700 px-4 py-2 rounded shadow";
      } finally {
        addUserBtn.disabled = false;
      }
    });
  });
})();
</script>

      <section id="checkExpense" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  
  <!-- Header with Download Button -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-blue-700">Check Expense</h2>
    <button id="downloadReportBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
      Download Report
    </button>
  </div>

  <div class="content space-y-4">
    <!-- Transaction ID -->
    <input type="text" placeholder="Transaction ID" class="w-full border p-2 rounded" />

    <!-- Expense Fields -->
    <input type="text" placeholder="Expense Name" class="w-full border p-2 rounded" />
    <input type="number" placeholder="Amount" class="w-full border p-2 rounded" />

    <!-- From & To Date -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="date" placeholder="From Date" class="w-full border p-2 rounded" />
      <input type="date" placeholder="End Date" class="w-full border p-2 rounded" />
    </div>

    <textarea placeholder="Description" class="w-full border p-2 rounded"></textarea>

    <button class="px-4 py-2 bg-blue-500 text-white rounded">Add Expense</button>
  </div>
</section>

<script>
// Download Report Logic Placeholder
document.getElementById('downloadReportBtn').addEventListener('click', () => {
  alert("Report download functionality will be implemented here.");
});
</script>

      <!-- Deposit/Withdraw Section -->
      <section id="depositWithdraw" class="dynamic-section hidden bg-white p-6 rounded shadow">
  <div class="loader hidden text-center text-blue-600">Loading...</div>
  <div class="content space-y-6">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Deposit / Withdraw</h2>

 

    <!-- Toggle Buttons -->
    <div class="flex gap-2 mb-4">
      <button id="showDepositBtn" class="toggle-btn px-4 py-2 rounded shadow bg-green-500 text-white">Deposit</button>
      <button id="showWithdrawBtn" class="toggle-btn px-4 py-2 rounded shadow bg-gray-300">Withdraw</button>
    </div>

    <!-- Deposit Form -->
    <div id="depositForm" class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-lg font-semibold mb-4 text-green-700 text-center">Deposit</h3>
      <input type="text" placeholder="Customer ID" class="w-full px-4 py-2 border rounded mb-3" id="depositCustomerId" />
      <input type="text" placeholder="Account Number (To Account)" class="w-full px-4 py-2 border rounded mb-3" id="depositAccount" />
      <input type="text" placeholder="From Account (e.g. CASH, Bank)" class="w-full px-4 py-2 border rounded mb-3" id="depositFromAccount" />
      <input type="number" placeholder="Amount" class="w-full px-4 py-2 border rounded mb-3" id="depositAmount" />
      <input type="date" class="w-full px-4 py-2 border rounded mb-3" id="depositDate" />
      <input type="text" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded mb-3" id="depositTxnId" />
      <input type="text" placeholder="Remarks (optional)" class="w-full px-4 py-2 border rounded mb-3" id="depositRemarks" />
      <input type="hidden" id="depositStaffId" />
      <input type="hidden" id="depositStaffName" />
      <button id="depositBtn" class="bg-green-500 text-white px-6 py-2 rounded w-full shadow hover:bg-green-600 transition">Deposit</button>
    </div>

    <!-- Withdraw Form -->
    <div id="withdrawForm" class="bg-white p-6 rounded-xl shadow hidden">
      <h3 class="text-lg font-semibold mb-4 text-red-700 text-center">Withdraw</h3>
      <input type="text" placeholder="Customer ID" class="w-full px-4 py-2 border rounded mb-3" id="withdrawCustomerId" />
      <input type="text" placeholder="Account Number (From Account)" class="w-full px-4 py-2 border rounded mb-3" id="withdrawAccount" />
      <input type="text" placeholder="To Account (e.g. CASH, Bank)" class="w-full px-4 py-2 border rounded mb-3" id="withdrawToAccount" />
      <input type="number" placeholder="Amount" class="w-full px-4 py-2 border rounded mb-3" id="withdrawAmount" />
      <input type="date" class="w-full px-4 py-2 border rounded mb-3" id="withdrawDate" />
      <input type="text" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded mb-3" id="withdrawTxnId" />
      <input type="text" placeholder="Remarks (optional)" class="w-full px-4 py-2 border rounded mb-3" id="withdrawRemarks" />
      <input type="hidden" id="withdrawStaffId" />
      <input type="hidden" id="withdrawStaffName" />
      <button id="withdrawBtn" class="bg-red-500 text-white px-6 py-2 rounded w-full shadow hover:bg-red-600 transition">Withdraw</button>
    </div>

    <!-- Add this somewhere inside the deposit/withdraw section for messages -->
    <div id="transactionMsg" class="mb-4 text-center text-sm font-semibold" style="display:none;"></div>
  </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Set staff info (replace with actual values from session/backend)
  const staffId = window.staffId || ""; // e.g. set from backend/session
  const staffName = window.staffName || ""; // e.g. set from backend/session
  document.getElementById("depositStaffId").value = staffId;
  document.getElementById("depositStaffName").value = staffName;
  document.getElementById("withdrawStaffId").value = staffId;
  document.getElementById("withdrawStaffName").value = staffName;

  function showTransactionMsg(msg, type) {
    const el = document.getElementById("transactionMsg");
    el.textContent = msg;
    el.className = "mb-4 text-center text-sm font-semibold " +
      (type === "success" ? "text-green-600 bg-green-100" :
       type === "error" ? "text-red-600 bg-red-100" :
       "text-blue-600 bg-blue-100");
    el.style.display = "block";
    setTimeout(() => {
      el.style.display = "none";
      el.textContent = "";
    }, 4000); // Hide after 4 seconds
  }

  // Deposit
  document.getElementById("depositBtn").addEventListener("click", async () => {
    const depositData = {
      customer_id: document.getElementById("depositCustomerId").value.trim(),
      account_number: document.getElementById("depositAccount").value.trim(),
      type: "deposit",
      amount: document.getElementById("depositAmount").value.trim(),
      from_account: document.getElementById("depositFromAccount").value.trim(),
      to_account: document.getElementById("depositAccount").value.trim(),
      date: document.getElementById("depositDate").value.trim(),
      transaction_id: document.getElementById("depositTxnId").value.trim(),
      remarks: document.getElementById("depositRemarks").value.trim(),
      staff_id: document.getElementById("depositStaffId").value.trim(),
      staff_name: document.getElementById("depositStaffName").value.trim()
    };

    // Basic validation
    if (!depositData.customer_id || !depositData.account_number || !depositData.amount || !depositData.date || !depositData.transaction_id || !depositData.from_account) {
      alert("Please fill all required Deposit fields.");
      return;
    }

    const formData = new FormData();
    Object.entries(depositData).forEach(([k, v]) => formData.append(k, v));

    try {
      const res = await fetch("/staff/api/add-transaction", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if (data.status === "success") {
        showTransactionMsg("Deposit successful! New balance: ₹" + data.balance_after, "success");
        // Redirect to certificate page
        if (data.receipt_url) {
          window.location.href = data.receipt_url;
        }
      } else {
        showTransactionMsg("Deposit failed: " + (data.message || "Unknown error"), "error");
      }
    } catch (err) {
      showTransactionMsg("Network error during deposit.", "error");
    }
  });

  // Withdraw
  document.getElementById("withdrawBtn").addEventListener("click", async () => {
    const withdrawData = {
      customer_id: document.getElementById("withdrawCustomerId").value.trim(),
      account_number: document.getElementById("withdrawAccount").value.trim(),
      type: "withdraw",
      amount: document.getElementById("withdrawAmount").value.trim(),
      from_account: document.getElementById("withdrawAccount").value.trim(),
      to_account: document.getElementById("withdrawToAccount").value.trim(),
      date: document.getElementById("withdrawDate").value.trim(),
      transaction_id: document.getElementById("withdrawTxnId").value.trim(),
      remarks: document.getElementById("withdrawRemarks").value.trim(),
      staff_id: document.getElementById("withdrawStaffId").value.trim(),
      staff_name: document.getElementById("withdrawStaffName").value.trim()
    };

    // Basic validation
    if (!withdrawData.customer_id || !withdrawData.account_number || !withdrawData.amount || !withdrawData.date || !withdrawData.transaction_id || !withdrawData.to_account) {
      alert("Please fill all required Withdraw fields.");
      return;
    }

    const formData = new FormData();
    Object.entries(withdrawData).forEach(([k, v]) => formData.append(k, v));

    try {
      const res = await fetch("/staff/api/add-transaction", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if (data.status === "success") {
        showTransactionMsg("Withdraw successful! New balance: ₹" + data.balance_after, "success");
        // Redirect to certificate page
        if (data.receipt_url) {
          window.location.href = data.receipt_url;
        }
      } else {
        showTransactionMsg("Withdraw failed: " + (data.message || "Unknown error"), "error");
      }
    } catch (err) {
      showTransactionMsg("Network error during withdraw.", "error");
    }
  });

  // Toggle Deposit/Withdraw forms
  const depositBtnToggle = document.getElementById("showDepositBtn");
  const withdrawBtnToggle = document.getElementById("showWithdrawBtn");
  const depositForm = document.getElementById("depositForm");
  const withdrawForm = document.getElementById("withdrawForm");

  depositBtnToggle.addEventListener("click", function () {
    depositForm.classList.remove("hidden");
    withdrawForm.classList.add("hidden");
    depositBtnToggle.classList.add("bg-green-500", "text-white");
    depositBtnToggle.classList.remove("bg-gray-300");
    withdrawBtnToggle.classList.remove("bg-red-500", "text-white");
    withdrawBtnToggle.classList.add("bg-gray-300");
  });

  withdrawBtnToggle.addEventListener("click", function () {
    withdrawForm.classList.remove("hidden");
    depositForm.classList.add("hidden");
    withdrawBtnToggle.classList.add("bg-red-500", "text-white");
    withdrawBtnToggle.classList.remove("bg-gray-300");
    depositBtnToggle.classList.remove("bg-green-500", "text-white");
    depositBtnToggle.classList.add("bg-gray-300");
  });

  // Search Customer functionality (replace with actual API call)
  const searchCustomerBtn = document.getElementById("searchCustomerBtn");
  if (searchCustomerBtn) {
    searchCustomerBtn.addEventListener("click", async function () {
      const customerId = document.getElementById("customerIdInput").value.trim();
      if (!customerId) {
        showCustomerMsg("Please enter a Customer ID or KGID", "error");
        return;
      }

      try {
        const res = await fetch(`/staff/api/get-customer?customer_id=${encodeURIComponent(customerId)}`);
        if (res.ok) {
          const data = await res.json();
          if (data && data.name) {
            document.getElementById("customerName").innerText = data.name;
            document.getElementById("customerBalance").innerText = data.balance;
            document.getElementById("customerInfo").classList.remove("hidden");
            document.getElementById("depositCustomerId").value = customerId;
            document.getElementById("withdrawCustomerId").value = customerId;
            showCustomerMsg("Customer found.", "success");
          } else {
            showCustomerMsg("Customer ID not found!", "error");
            document.getElementById("customerInfo").classList.add("hidden");
          }
        } else {
          if (res.status === 404) {
            showCustomerMsg("Customer ID not found!", "error");
            document.getElementById("customerInfo").classList.add("hidden");
          } else {
            showCustomerMsg("Error fetching customer info.", "error");
            document.getElementById("customerInfo").classList.add("hidden");
          }
        }
      } catch (err) {
        showCustomerMsg("Network error while searching customer.", "error");
        document.getElementById("customerInfo").classList.add("hidden");
      }
    });
  }

  // Loan Repayment search logic
  const loanSearchForm = document.getElementById('loanSearchForm');
  if (loanSearchForm) {
    loanSearchForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const type = document.getElementById('loanSearchType').value;
      const value = document.getElementById('loanSearchInput').value.trim();
      const resultDiv = document.getElementById('loanInfoResult');
      const autoTxnDiv = document.getElementById('autoTransactionFormContainer');
      resultDiv.innerHTML = '<div class="text-blue-600">Loading...</div>';
      autoTxnDiv.innerHTML = '';
      try {
        const res = await fetch(`/api/loan?${type}=${encodeURIComponent(value)}`);
        if (res.ok) {
          const data = await res.json();
          if (data && data.loanAmount) {
            resultDiv.innerHTML = `
              <div class="bg-gray-50 p-4 rounded shadow mb-2 text-left">
                <p><strong>Loan Amount:</strong> ₹${data.loanAmount}</p>
                <p><strong>Recovered:</strong> ₹${data.recovered}</p>
                <p><strong>Pending:</strong> ₹${data.pending}</p>
                <p><strong>Term:</strong> ${data.term} months</p>
              </div>
            `;
            autoTxnDiv.innerHTML = `
              <div class="bg-white p-6 rounded-xl shadow mt-4">
                <h3 class="text-lg font-semibold mb-4 text-blue-700">Auto Transaction to Another Person</h3>
                <form id="autoTransactionForm" class="space-y-3">
                  <input type="text" name="holderName" placeholder="Account Holder Name" class="w-full px-4 py-2 border rounded" required />
                  <input type="text" name="bankName" placeholder="Bank Name" class="w-full px-4 py-2 border rounded" required />
                  <input type="text" name="accountNo" placeholder="Account Number" class="w-full px-4 py-2 border rounded" required />
                  <input type="text" name="transactionId" placeholder="Transaction ID" class="w-full px-4 py-2 border rounded" required />
                  <input type="date" name="date" class="w-full px-4 py-2 border rounded" required />
                  <input type="number" name="amount" placeholder="Amount" class="w-full px-4 py-2 border rounded" required />
                  <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded w-full shadow hover:bg-blue-600 transition">Submit</button>
                </form>
                <div id="autoTxnResult" class="mt-2"></div>
              </div>
            `;
            // Handle auto transaction submit
            const autoTxnForm = document.getElementById('autoTransactionForm');
            if (autoTxnForm) {
              autoTxnForm.onsubmit = async function(ev) {
                ev.preventDefault();
                const formData = new FormData(autoTxnForm);
                const payload = {
                  holderName: formData.get('holderName'),
                  bankName: formData.get('bankName'),
                  accountNo: formData.get('accountNo'),
                  transactionId: formData.get('transactionId'),
                  date: formData.get('date'),
                  amount: formData.get('amount'),
                  loanId: data.loanId
                };
                const result = document.getElementById('autoTxnResult');
                result.innerHTML = '<div class="text-blue-600">Processing...</div>';
                try {
                  const resp = await fetch('/api/loan/auto-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                  });
                  if (resp.ok) {
                    result.innerHTML = '<div class="text-green-600">Transaction submitted successfully!</div>';
                  } else {
                    result.innerHTML = '<div class="text-red-600">Transaction failed.</div>';
                  }
                } catch {
                  result.innerHTML = '<div class="text-red-600">Network error.</div>';
                }
              };
            }
          } else {
            resultDiv.innerHTML = `<div class="text-red-600">No loan found.</div>`;
          }
        } else {
          resultDiv.innerHTML = `<div class="text-red-600">Error fetching data.</div>`;
        }
      } catch {
        resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
      }
    });
  }

  // Loan Repayment logic
  document.addEventListener('DOMContentLoaded', () => {
    const loanRepaymentForm = document.getElementById('loanRepaymentForm');
    if (loanRepaymentForm) {
      loanRepaymentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const loan_id = document.getElementById('repayLoanIdInput').value.trim();
        const amount = document.getElementById('repayAmountInput').value.trim();
        const resultDiv = document.getElementById('loanRepaymentResult');
        resultDiv.innerHTML = '<div class="text-blue-600">Processing...</div>';
        try {
          const res = await fetch('/api/loan/repay', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ loan_id, amount })
          });
          const data = await res.json();
          if (res.ok) {
            resultDiv.innerHTML = `<div class="text-green-600">${data.message}</div>`;
          } else {
            resultDiv.innerHTML = `<div class="text-red-600">${data.message || 'Repayment failed.'}</div>`;
          }
        } catch {
          resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
        }
      });
    }

    // Next Installment logic
    const nextInstallmentForm = document.getElementById('nextInstallmentForm');
    if (nextInstallmentForm) {
      nextInstallmentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const loan_id = document.getElementById('nextInstallmentLoanIdInput').value.trim();
        const resultDiv = document.getElementById('nextInstallmentResult');
        resultDiv.innerHTML = '<div class="text-blue-600">Checking...</div>';
        try {
          const res = await fetch(`/api/loan/next-installment?loan_id=${encodeURIComponent(loan_id)}`);
          const data = await res.json();
          if (res.ok) {
            resultDiv.innerHTML = `
              <div class="bg-gray-50 p-4 rounded shadow mb-2 text-left">
                <p><strong>Next Installment:</strong> ₹${data.next_installment}</p>
                <p><strong>Due Date:</strong> ${data.due_date}</p>
                <p><strong>Status:</strong> ${data.status}</p>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `<div class="text-red-600">${data.message || 'Error fetching installment.'}</div>`;
          }
        } catch {
          resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
        }
      });
    }
  });

  // Check Transaction logic
  const transactionForm = document.getElementById('transactionSearchForm');
  if (transactionForm) {
    transactionForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const stid = document.getElementById('transactionIdInput').value.trim();
      const resultDiv = document.getElementById('transactionResult');
      resultDiv.innerHTML = '<div class="text-blue-600">Loading...</div>';
      try {
        const res = await fetch(`/staff/transaction/check/${encodeURIComponent(stid)}`);
        const data = await res.json();
        if (res.ok) {
          resultDiv.innerHTML = `
            <div class="bg-gray-50 p-4 rounded shadow mb-2 text-left">
              <p><strong>Transaction ID:</strong> ${data.transaction_id}</p>
              <p><strong>Amount:</strong> ₹${data.amount}</p>
              <p><strong>Status:</strong> ${data.status}</p>
              <p><strong>Date:</strong> ${data.date}</p>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="text-red-600">${data.message || 'Transaction not found.'}</div>`;
        }
      } catch {
        resultDiv.innerHTML = `<div class="text-red-600">Network error.</div>`;
      }
    });
  }
</script>
<script>
  // Dedicated fix for Loan Repayment, Next Installment, and Check Transaction buttons
  document.addEventListener('DOMContentLoaded', function() {
    function showSection(sectionId) {
      document.querySelectorAll('.dynamic-section').forEach(sec => sec.classList.add('hidden'));
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.remove('hidden');
        // Also show content and hide loader if present
        const content = section.querySelector('.content');
        const loader = section.querySelector('.loader');
        if (content) content.classList.remove('hidden');
        if (loader) loader.classList.add('hidden');
      }
    }
    const repaymentBtn = document.querySelector('[data-target="loanRepayment"]');
    const installmentBtn = document.querySelector('[data-target="nextInstallment"]');
    const transactionBtn = document.querySelector('[data-target="checkTransaction"]');
    if (repaymentBtn) {
      repaymentBtn.addEventListener('click', function(e) {
        e.stopImmediatePropagation();
        showSection('loanRepayment');
      });
    }
    if (installmentBtn) {
      installmentBtn.addEventListener('click', function(e) {
        e.stopImmediatePropagation();
        showSection('nextInstallment');
      });
    }
    if (transactionBtn) {
      transactionBtn.addEventListener('click', function(e) {
        e.stopImmediatePropagation();
        showSection('checkTransaction');
      });
    }
  });
</script>
</body>
</html>
{% extends 'admin/base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block header %}{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-50">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-lg p-6 space-y-4">
    <h2 class="font-bold text-xl text-blue-700 mb-6">Admin Dashboard</h2>
    <nav class="space-y-3">
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="welcome">üè† Home</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="accountRequests">üìù Account Requests</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="loanApprovals">üí∞ Loan Approvals</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="fdApprovals">üè¶ FD Approvals</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="customerDetails">üë§ Customer Details</button>
      <button id="navAuditBtn" type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="audit">üìä Audit</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="recentTransactions">üïí Recent Transactions</button>
      <!-- New: View Expenses -->
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="viewExpenses" id="viewExpensesBtn">üìã View Expenses</button>
      <!-- NEW: Queries -->
      <button type="button" id="navAdminQueries" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="adminQueries">üì¨ Queries</button>
      <!-- NEW: Add Staff -->
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="addStaff">üë• Add Staff</button>
      <!-- NEW: Add Staff Salary -->
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="addStaffSalary">ÔøΩ Add Staff Salary</button>
      <!-- NEW: Loan Info Button -->
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="loanInfo">üìÑ Loan Info</button>
    </nav>
    <hr class="my-6">
  </aside>

  <!-- Main Content Area -->
  <main class="flex-1 p-8 space-y-6">
    <!-- Top bar with Logout -->
    <div class="flex items-center justify-end mb-2">
  <span class="mr-4 text-gray-700 font-semibold">{{ session['name'] }}</span>
  <button id="adminLogoutTop" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow">Logout</button>
    </div>
    <!-- Welcome Section -->
    <section id="welcome" class="admin-section">
      <div class="bg-white p-8 rounded-xl shadow text-center">
        <h1 class="text-3xl font-bold text-blue-700 mb-4">Welcome to Admin Dashboard</h1>
        <p class="text-gray-600">Use the navigation menu to manage accounts and view requests.</p>
        
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
          <!-- Account Requests Card -->
          <div class="bg-blue-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
            <div class="text-4xl text-blue-500 mb-2">üìù</div>
            <h3 class="text-xl font-bold text-blue-700 mb-2">Account Requests</h3>
            <p class="text-gray-600 mb-4">Review and approve new member account requests</p>
            <button class="admin-nav-btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition" data-target="accountRequests">View Requests</button>
          </div>
          
          <!-- Loan Approvals Card -->
          <div class="bg-green-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
            <div class="text-4xl text-green-500 mb-2">üí∞</div>
            <h3 class="text-xl font-bold text-green-700 mb-2">Loan Approvals</h3>
            <p class="text-gray-600 mb-4">Review and manage pending loan applications</p>
            <button class="admin-nav-btn bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition" data-target="loanApprovals">View Loans</button>
          </div>
          
          <!-- Stats Card -->
          <div class="bg-purple-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
            <div class="text-4xl text-purple-500 mb-2">üìä</div>
            <h3 class="text-xl font-bold text-purple-700 mb-2">Society Stats</h3>
            <p class="text-gray-600 mb-4">View overall society statistics and metrics</p>
            <button id="viewStatsBtn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">View Stats</button>
          </div>
        </div>
      </div>
  </section>
  <script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
    
    <!-- Recent Transactions Section -->
    <section id="recentTransactions" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-blue-700">Recent Transactions</h2>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600" for="rtYear">Year</label>
            <select id="rtYear" class="px-3 py-1 border rounded-lg"></select>
            <label class="text-sm text-gray-600" for="rtMonth">Month</label>
            <select id="rtMonth" class="px-3 py-1 border rounded-lg"></select>
            <label class="text-sm text-gray-600" for="rtDay">Day</label>
            <select id="rtDay" class="px-3 py-1 border rounded-lg"></select>
            <button id="rtFilterBtn" class="px-3 py-1 rounded-lg bg-blue-600 text-white">Filter</button>
            <button id="rtDownloadExcelBtn" class="px-3 py-1 rounded-lg bg-green-600 text-white">Download Excel</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ref</th>
              </tr>
            </thead>
            <tbody id="rtTableBody" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- Account Requests Section -->
    <section id="accountRequests" class="admin-section hidden">
      <iframe src="{{ url_for('admin.admin_account_requests') }}" class="w-full min-h-[600px] border-0 rounded-xl shadow"></iframe>
    </section>
    
    <!-- Loan Approvals Section -->
    <section id="loanApprovals" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Pending Loan Approvals</h2>
        
        <!-- Tabs for loan categories -->
        <div class="mb-6 border-b">
          <div class="flex space-x-4">
            <button class="loan-tab-btn px-4 py-2 border-b-2 border-green-500 text-green-700 font-medium" data-target="pendingLoans">Pending</button>
            <button class="loan-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-target="approvedLoans">Approved</button>
            <button class="loan-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-target="rejectedLoans">Rejected</button>
          </div>
        </div>
        
        <!-- Loan listings by status -->
        <div id="pendingLoans" class="loan-tab-content">
          <iframe src="{{ url_for('admin.pending_loan_approvals') }}" class="w-full min-h-[500px] border-0"></iframe>
        </div>
        
        <div id="approvedLoans" class="loan-tab-content hidden">
          <iframe src="{{ url_for('admin.approved_loans') }}" class="w-full min-h-[500px] border-0"></iframe>
        </div>
        
        <div id="rejectedLoans" class="loan-tab-content hidden">
          <iframe src="{{ url_for('admin.rejected_loans') }}" class="w-full min-h-[500px] border-0"></iframe>
        </div>
      </div>
    </section>
    
    <!-- FD Approvals Section -->
    <section id="fdApprovals" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Pending Fixed Deposits</h2>
        <iframe src="{{ url_for('admin.fd_approvals') }}" class="w-full min-h-[520px] border-0 rounded-lg"></iframe>
      </div>
    </section>
    
    <!-- Customer Details Section -->
    <section id="customerDetails" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-blue-700 mb-6">Customer Details</h2>
        
        <!-- Search Form -->
        <div class="mb-6">
          <form id="customerSearchForm" class="flex gap-4 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">Search Customer</label>
              <input type="text" id="customerSearchInput" placeholder="Enter Customer ID or KGID" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              Search
            </button>
          </form>
        </div>
        
        <!-- Loading State -->
        <div id="customerSearchLoading" class="hidden text-center py-4">
          <div class="inline-flex items-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-2"></div>
            <span class="text-blue-600">Searching...</span>
          </div>
        </div>
        
        <!-- Search Results -->
        <div id="customerSearchResults" class="hidden">
          <!-- Customer Basic Info Card -->
          <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Customer Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="customerBasicInfo">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Loans Summary -->
          <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Loan Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="loanSummaryInfo">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Detailed Loans Table -->
          <div class="bg-white border rounded-lg overflow-hidden">
            <h3 class="text-lg font-bold text-gray-800 p-4 border-b bg-gray-50">Loan Details</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Loan ID</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Applied Date</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Balance</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody id="loansTableBody">
                  <!-- Content will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Selected Loan Detailed Panel -->
          <div id="selectedLoanDetails" class="hidden bg-white border rounded-lg overflow-hidden mt-6">
            <div class="flex items-center justify-between p-4 border-b bg-gray-50">
              <h3 class="text-lg font-bold text-gray-800">Selected Loan Comprehensive View</h3>
              <button id="hideLoanDetailsBtn" class="text-sm text-gray-500 hover:text-gray-700">Hide ‚úï</button>
            </div>
            <div id="selectedLoanContent" class="p-4 text-sm">
              <!-- Filled dynamically -->
            </div>
          </div>
        </div>
        
        <!-- Error State -->
        <div id="customerSearchError" class="hidden">
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-red-800 font-medium" id="customerSearchErrorMessage">Customer not found</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Audit Section (Loans + Transactions) -->
    <section id="audit" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <h2 class="text-2xl font-bold text-blue-700">Audit</h2>
            <div class="hidden md:flex items-center gap-3 p-3 rounded-xl bg-blue-50 border border-blue-100">
              <div class="text-sm text-blue-700">Total (Balance + Interest + Share Amount)</div>
              <div id="auditTotalAmount" class="text-xl font-bold text-blue-800">‚Çπ0</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="auditTabLoans" class="px-3 py-1 rounded-lg bg-blue-600 text-white">Loans</button>
            <button id="auditTabTransactions" class="px-3 py-1 rounded-lg bg-gray-100 text-gray-700">Transactions</button>
            <button id="auditTabSalaries" class="px-3 py-1 rounded-lg bg-gray-100 text-gray-700">Salaries</button>
            <button id="auditTabExpenses" class="px-3 py-1 rounded-lg bg-gray-100 text-gray-700">Expenses</button>
            <button id="auditTabShareAmount" class="px-3 py-1 rounded-lg bg-gray-100 text-gray-700">Share Amount</button>
          </div>
        </div>

        <!-- Loans (Yearly) Panel -->
        <div id="loanAuditPanel">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <label for="loanAuditYear" class="text-sm text-gray-600">Year</label>
              <select id="loanAuditYear" class="px-3 py-1 border rounded-lg"></select>
            </div>
            <button id="loansDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">Download Excel</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="p-5 rounded-xl bg-indigo-50 border border-indigo-100 shadow">
              <div class="text-sm text-indigo-700">Total Disbursed (Year)</div>
              <div id="auditTotalDisbursed" class="text-3xl font-bold text-indigo-800 mt-1">‚Çπ0</div>
            </div>
            <div class="p-5 rounded-xl bg-emerald-50 border border-emerald-100 shadow">
              <div class="text-sm text-emerald-700">Total Recovered (Year)</div>
              <div id="auditTotalRecovered" class="text-3xl font-bold text-emerald-800 mt-1">‚Çπ0</div>
            </div>
          </div>
          <div class="bg-white rounded-xl border p-4 h-[320px]">
            <canvas id="loanAuditChart" height="280"></canvas>
          </div>
        </div>

        <!-- Transactions (Monthly) Panel -->
        <div id="txnAuditPanel" class="hidden">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <label for="txnAuditYear" class="text-sm text-gray-600">Year</label>
              <select id="txnAuditYear" class="px-3 py-1 border rounded-lg"></select>
              <label for="txnAuditMonth" class="text-sm text-gray-600 ml-2">Month</label>
              <select id="txnAuditMonth" class="px-3 py-1 border rounded-lg"></select>
            </div>
            <button id="transactionsDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">Download Excel</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="p-5 rounded-xl bg-green-50 border border-green-100 shadow">
              <div class="text-sm text-green-700">Total Deposits (Month)</div>
              <div id="auditTotalDeposit" class="text-3xl font-bold text-green-800 mt-1">‚Çπ0</div>
            </div>
            <div class="p-5 rounded-xl bg-red-50 border border-red-100 shadow">
              <div class="text-sm text-red-700">Total Withdrawals (Month)</div>
              <div id="auditTotalWithdrawal" class="text-3xl font-bold text-red-800 mt-1">‚Çπ0</div>
            </div>
          </div>
          <div class="bg-white rounded-xl border p-4 h-[320px]">
            <canvas id="txnAuditChart" height="280"></canvas>
          </div>
        </div>

        <!-- Salaries (Yearly) Panel -->
        <div id="salaryAuditPanel" class="hidden">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <label for="salaryAuditYear" class="text-sm text-gray-600">Year</label>
              <select id="salaryAuditYear" class="px-3 py-1 border rounded-lg"></select>
            </div>
            <button id="salariesDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">Download Excel</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="p-5 rounded-xl bg-amber-50 border border-amber-100 shadow">
              <div class="text-sm text-amber-700">Total Salaries (Year)</div>
              <div id="auditTotalSalariesYear" class="text-3xl font-bold text-amber-800 mt-1">‚Çπ0</div>
            </div>
            <div class="p-5 rounded-xl bg-amber-50 border border-amber-100 shadow">
              <div class="text-sm text-amber-700">Average Per Month</div>
              <div id="auditAvgSalariesMonth" class="text-3xl font-bold text-amber-800 mt-1">‚Çπ0</div>
            </div>
          </div>
          <div class="bg-white rounded-xl border p-4 h-[320px]">
            <canvas id="salaryAuditChart" height="280"></canvas>
          </div>
        </div>

        <!-- Expenses (Monthly) Panel -->
        <div id="expensesAuditPanel" class="hidden">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <label for="expensesAuditYear" class="text-sm text-gray-600">Year</label>
              <select id="expensesAuditYear" class="px-3 py-1 border rounded-lg"></select>
              <label for="expensesAuditMonth" class="text-sm text-gray-600 ml-2">Month</label>
              <select id="expensesAuditMonth" class="px-3 py-1 border rounded-lg"></select>
            </div>
            <button id="expensesDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">Download Excel</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="p-5 rounded-xl bg-yellow-50 border border-yellow-100 shadow">
              <div class="text-sm text-yellow-700">Total Expenses (Month)</div>
              <div id="auditTotalExpensesMonth" class="text-3xl font-bold text-yellow-800 mt-1">‚Çπ0</div>
            </div>
            <div class="p-5 rounded-xl bg-yellow-50 border border-yellow-100 shadow">
              <div class="text-sm text-yellow-700">Daily Average</div>
              <div id="auditAvgExpensesDay" class="text-3xl font-bold text-yellow-800 mt-1">‚Çπ0</div>
            </div>
          </div>
          <div class="bg-white rounded-xl border p-4 h-[320px]">
            <canvas id="expensesAuditChart" height="280"></canvas>
          </div>
        </div>

        <!-- Share Amount Panel -->
        <div id="shareAmountAuditPanel" class="hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Share Amount Distribution</h3>
            <button id="shareAmountDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow">Download Excel</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="p-5 rounded-xl bg-purple-50 border border-purple-100 shadow">
              <div class="text-sm text-purple-700">Total Share Amount</div>
              <div id="auditTotalShareAmount" class="text-3xl font-bold text-purple-800 mt-1">‚Çπ0</div>
            </div>
            <div class="p-5 rounded-xl bg-purple-50 border border-purple-100 shadow">
              <div class="text-sm text-purple-700">Total Members</div>
              <div id="auditShareMemberCount" class="text-3xl font-bold text-purple-800 mt-1">0</div>
            </div>
            <div class="p-5 rounded-xl bg-purple-50 border border-purple-100 shadow">
              <div class="text-sm text-purple-700">Average per Member</div>
              <div id="auditAvgShareAmount" class="text-3xl font-bold text-purple-800 mt-1">‚Çπ0</div>
            </div>
          </div>
          <div class="bg-white rounded-xl border p-4">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-md font-semibold text-gray-700">Member Share Details</h4>
            </div>
            <div class="overflow-x-auto max-h-80">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Share Amount</th>
                  </tr>
                </thead>
                <tbody id="shareAmountTableBody" class="bg-white divide-y divide-gray-200">
                  <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Queries Section (Admin) -->
    <section id="adminQueries" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">User Queries</h2>
        <div id="adminQueriesMsg" class="mb-4"></div>
        <div class="overflow-x-auto">
          <table id="adminQueriesTable" class="min-w-full table-auto border-collapse">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">#</th>
                <th class="px-4 py-2 text-left">Name</th>
                <th class="px-4 py-2 text-left">Email / Phone</th>
                <th class="px-4 py-2 text-left">KGID / Customer</th>
                <th class="px-4 py-2 text-left">Description</th>
                <th class="px-4 py-2 text-left">Status</th>
                <th class="px-4 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="adminQueriesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- View Expenses Section (renders new file) -->
    <section id="viewExpenses" class="admin-section hidden">
      {% include 'admin/view_expenses.html' %}
    </section>

    <!-- NEW: Add Staff Section -->
    <section id="addStaff" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Add Staff</h2>
        <iframe src="{{ url_for('admin.admin_add_staff') }}" class="w-full min-h-[850px] border-0 rounded-xl shadow" title="Add Staff"></iframe>
      </div>
    </section>

    <!-- NEW: Add Staff Salary Section -->
    <section id="addStaffSalary" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow max-w-xl mx-auto">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Add Staff Salary</h2>
        <form id="addStaffSalaryForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input type="text" name="name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">KGID</label>
            <input type="text" name="kgid" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Salary Amount</label>
            <input type="number" name="salary" step="0.01" min="0" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">To Account</label>
            <input type="text" name="to_account" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">From Account</label>
            <input type="text" name="from_account" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Transaction ID</label>
            <input type="text" name="transaction_id" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
            <input type="date" name="date" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <button type="submit" id="addSalaryBtn" class="w-full flex items-center justify-center gap-2 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-60 disabled:cursor-not-allowed">
              <span id="addSalaryBtnText">Add Salary</span>
              <svg id="addSalarySpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
              </svg>
            </button>
          </div>
          <div id="addSalaryMsg" class="text-center text-sm mt-2"></div>
        </form>

        <!-- Recent Salaries Table -->
        <div class="mt-8">
          <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Staff Salaries</h3>
          <div id="salaryTableContainer" class="overflow-x-auto">
            <table class="w-full table-auto border rounded-lg">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-left">Name</th>
                  <th class="px-4 py-2 text-left">KGID</th>
                  <th class="px-4 py-2 text-left">Salary</th>
                  <th class="px-4 py-2 text-left">To Account</th>
                  <th class="px-4 py-2 text-left">From Account</th>
                  <th class="px-4 py-2 text-left">Transaction ID</th>
                  <th class="px-4 py-2 text-left">Date</th>
                </tr>
              </thead>
              <tbody id="salaryTableBody">
                <tr><td colspan="7" class="text-center text-gray-500 py-4">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="flex justify-between items-center mt-4">
            <button id="salaryPrevPage" class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50" disabled>Prev</button>
            <span id="salaryPageInfo" class="text-sm text-gray-600"></span>
            <button id="salaryNextPage" class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50">Next</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Loan Info Section -->
    <section id="loanInfo" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow max-w-lg mx-auto">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Loan Info Search</h2>
        <form id="loanInfoSearchForm" class="flex gap-2 mb-4">
          <input type="text" id="loanInfoSearchInput" placeholder="Enter Loan ID " class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" required>
          <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Search</button>
        </form>
        <div id="loanInfoSearchResult"></div>
      </div>
    </section>
  </main>
</div>
  <!-- Floating Civil Score Button for Admin -->
  <style>
    .floating-box { transform: translateY(100%); opacity: 0; transition: transform 0.4s ease, opacity 0.4s ease; }
    .floating-box.show { transform: translateY(0); opacity: 1; }
  </style>
  <button id="adminCivilBtn" class="fixed bottom-20 right-6 bg-green-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-green-700 z-50">
    üìä Civil Score
  </button>
  <div id="adminCivilBox" class="floating-box hidden fixed bottom-28 right-6 w-80 bg-white rounded-xl shadow-2xl p-4 z-50">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-bold">Check Civil Score</h3>
      <button id="closeAdminCivil" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <input id="adminCivilInput" class="w-full mb-3 px-4 py-2 border rounded" placeholder="Enter Customer ID or KGID Number">
    <button id="adminCheckCivil" class="bg-green-600 text-white px-6 py-2 rounded w-full hover:bg-green-700">Check Now</button>
    <div id="adminCivilResult" class="mt-3 text-center text-blue-700"></div>
  </div>

  <script>
// Admin Logout: clear per-tab token then hit server logout
function wireAdminLogout(btnId){
  const el = document.getElementById(btnId);
  if(!el) return;
  el.addEventListener('click', ()=>{
    try{ sessionStorage.removeItem('authToken'); }catch(e){}
    window.location.href = '/auth/logout';
  });
}
wireAdminLogout('adminLogoutTop');
// Wire View Stats button to open the Audit section
document.addEventListener('DOMContentLoaded', function(){
  const viewStatsBtn = document.getElementById('viewStatsBtn');
  const navAuditBtn = document.getElementById('navAuditBtn');
  if(viewStatsBtn && navAuditBtn){
    viewStatsBtn.addEventListener('click', ()=> navAuditBtn.click());
  }
});
// Admin Queries: load and render
document.addEventListener('DOMContentLoaded', function(){
  const adminQueriesTbody = document.getElementById('adminQueriesTbody');
  const adminQueriesMsg = document.getElementById('adminQueriesMsg');
  const navBtn = document.getElementById('navAdminQueries');

  async function loadAdminQueries(){
    if (!adminQueriesTbody) return;
    adminQueriesMsg.textContent = '';
    adminQueriesTbody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 text-center text-gray-500">Loading...</td></tr>';
    try{
      const res = await fetch('/api/queries');
      if (!res.ok) throw new Error('Network error');
      const payload = await res.json();
      if (payload.status !== 'success') throw new Error(payload.message || 'Failed to load');
      renderAdminQueries(payload.data || []);
    }catch(e){
      adminQueriesTbody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 text-center text-red-600">Error loading queries.</td></tr>';
      adminQueriesMsg.textContent = e.message || String(e);
      adminQueriesMsg.className = 'mb-4 text-red-600';
    }
  }

  function renderAdminQueries(list){
    if (!adminQueriesTbody) return;
    if (!Array.isArray(list) || list.length === 0){
      adminQueriesTbody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 text-center text-gray-500">No queries found.</td></tr>';
      return;
    }
    const rows = list.map((q, idx)=>{
      const id = q.id || '';
      const name = q.name || '';
      const email = q.email || '';
      const phone = q.phone || '';
      const ident = q.kgid || q.customer_id || '';
      const desc = (q.description || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const status = q.status || 'open';
      const created = q.created_at ? new Date(q.created_at).toLocaleString() : '';
      const actionBtn = status === 'solved'
        ? '<button class="px-3 py-1 bg-gray-300 text-gray-700 rounded" disabled>Solved</button>'
        : `<button data-id="${id}" class="adminMarkSolved px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Mark Solved</button>`;
      return `
        <tr class="border-t">
          <td class="px-4 py-2 align-top">${idx+1}</td>
          <td class="px-4 py-2 align-top">${name}</td>
          <td class="px-4 py-2 align-top">${email}<br><span class="text-gray-500">${phone}</span></td>
          <td class="px-4 py-2 align-top">${ident}</td>
          <td class="px-4 py-2 align-top"><div title="${created}">${desc}</div></td>
          <td class="px-4 py-2 align-top">${status}</td>
          <td class="px-4 py-2 align-top">${actionBtn}</td>
        </tr>`;
    }).join('\n');
    adminQueriesTbody.innerHTML = rows;
    document.querySelectorAll('.adminMarkSolved').forEach(btn=>{
      if (btn.dataset.wired) return;
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-id');
        if (!id) return;
        btn.disabled = true; btn.textContent = 'Marking...';
        try{
          const res = await fetch(`/api/queries/${id}/mark-solved`, { method: 'POST' });
          const data = await res.json();
          if (res.ok && data.status === 'success'){
            loadAdminQueries();
          } else {
            alert(data.message || 'Failed to mark solved');
            btn.disabled = false; btn.textContent = 'Mark Solved';
          }
        }catch(err){
          alert('Network error');
          btn.disabled = false; btn.textContent = 'Mark Solved';
        }
      });
      btn.dataset.wired = '1';
    });
  }

  if (navBtn) navBtn.addEventListener('click', ()=> setTimeout(loadAdminQueries, 150));
  // Also fetch shortly after load so table fills if section is shown
  setTimeout(loadAdminQueries, 300);
});
// Add Staff Salary form logic and salary table with pagination
document.addEventListener('DOMContentLoaded', function() {
  const addStaffSalaryForm = document.getElementById('addStaffSalaryForm');
  const salaryTableBody = document.getElementById('salaryTableBody');
  const salaryPrevPage = document.getElementById('salaryPrevPage');
  const salaryNextPage = document.getElementById('salaryNextPage');
  const salaryPageInfo = document.getElementById('salaryPageInfo');
  let salaryPage = 1;
  let salaryPageSize = 10;
  let salaryTotal = 0;

  async function loadSalaries(page=1) {
    salaryTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">Loading...</td></tr>';
    try {
      const res = await fetch(`/admin/api/list-staff-salaries?page=${page}&page_size=${salaryPageSize}`);
      const data = await res.json();
      if (res.ok && data.status === 'success') {
        const list = data.salaries || [];
        salaryTotal = data.total || 0;
        if (list.length === 0) {
          salaryTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">No salaries found.</td></tr>';
        } else {
          salaryTableBody.innerHTML = list.map(s => `
            <tr class="border-t">
              <td class="px-4 py-2">${s.name}</td>
              <td class="px-4 py-2">${s.kgid}</td>
              <td class="px-4 py-2">‚Çπ${Number(s.salary).toLocaleString()}</td>
              <td class="px-4 py-2">${s.to_account}</td>
              <td class="px-4 py-2">${s.from_account}</td>
              <td class="px-4 py-2">${s.transaction_id}</td>
              <td class="px-4 py-2">${s.date ? new Date(s.date).toLocaleDateString() : ''}</td>
            </tr>
          `).join('');
        }
        // Update page info and buttons
        const totalPages = Math.ceil(salaryTotal / salaryPageSize) || 1;
        salaryPageInfo.textContent = `Page ${salaryPage} of ${totalPages}`;
        salaryPrevPage.disabled = salaryPage <= 1;
        salaryNextPage.disabled = salaryPage >= totalPages;
      } else {
        salaryTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-red-600 py-4">Failed to load salaries.</td></tr>';
        salaryPageInfo.textContent = '';
      }
    } catch (e) {
      salaryTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-red-600 py-4">Network error.</td></tr>';
      salaryPageInfo.textContent = '';
    }
  }

  if (salaryPrevPage && salaryNextPage) {
    salaryPrevPage.addEventListener('click', function() {
      if (salaryPage > 1) {
        salaryPage--;
        loadSalaries(salaryPage);
      }
    });
    salaryNextPage.addEventListener('click', function() {
      const totalPages = Math.ceil(salaryTotal / salaryPageSize) || 1;
      if (salaryPage < totalPages) {
        salaryPage++;
        loadSalaries(salaryPage);
      }
    });
  }

  // Initial load
  loadSalaries(salaryPage);

  if (addStaffSalaryForm) {
    const addSalaryBtn = document.getElementById('addSalaryBtn');
    const addSalarySpinner = document.getElementById('addSalarySpinner');
    const addSalaryBtnText = document.getElementById('addSalaryBtnText');
    const addSalaryMsg = document.getElementById('addSalaryMsg');
    addStaffSalaryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      addSalaryMsg.textContent = '';
      addSalaryBtn.disabled = true;
      addSalarySpinner.classList.remove('hidden');
      addSalaryBtnText.textContent = 'Adding...';
      const formData = new FormData(addStaffSalaryForm);
      const payload = {};
      formData.forEach((v, k) => payload[k] = v);
      try {
        const res = await fetch('/admin/api/add-staff-salary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok && data.status === 'success') {
          addSalaryMsg.textContent = 'Salary added successfully!';
          addSalaryMsg.className = 'text-center text-green-600 text-sm mt-2';
          addStaffSalaryForm.reset();
          // Reload salaries
          salaryPage = 1;
          loadSalaries(salaryPage);
        } else {
          addSalaryMsg.textContent = data.message || 'Failed to add salary.';
          addSalaryMsg.className = 'text-center text-red-600 text-sm mt-2';
        }
      } catch (err) {
        addSalaryMsg.textContent = 'Network error.';
        addSalaryMsg.className = 'text-center text-red-600 text-sm mt-2';
      } finally {
        addSalaryBtn.disabled = false;
        addSalarySpinner.classList.add('hidden');
        addSalaryBtnText.textContent = 'Add Salary';
      }
    });
  }

  // Loan Info Search logic
  const loanInfoSearchForm = document.getElementById('loanInfoSearchForm');
  const loanInfoSearchInput = document.getElementById('loanInfoSearchInput');
  const loanInfoSearchResult = document.getElementById('loanInfoSearchResult');
  if (loanInfoSearchForm && loanInfoSearchInput && loanInfoSearchResult) {
    loanInfoSearchForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const val = loanInfoSearchInput.value.trim();
      loanInfoSearchResult.innerHTML = '';
      if (!val) {
        loanInfoSearchResult.innerHTML = '<div class="text-red-600">Please enter a Loan ID.</div>';
        return;
      }
      loanInfoSearchResult.innerHTML = '<div class="text-blue-600">Searching...</div>';
      let url = '/staff/api/loan-info?loan_id=' + encodeURIComponent(val);
      try {
        const res = await fetch(url);
        let data = null; 
        try { data = await res.json(); } catch {}
        if (res.ok && data && data.status === 'success' && data.loan_info) {
          const info = data.loan_info;
          // Always show 0 if falsy/null/undefined for totals
          const totalPrincipalRepaid = (typeof info.total_principal_repaid === 'number' && !isNaN(info.total_principal_repaid)) ? info.total_principal_repaid : 0;
          const totalInterestRepaid = (typeof info.total_interest_repaid === 'number' && !isNaN(info.total_interest_repaid)) ? info.total_interest_repaid : 0;
          loanInfoSearchResult.innerHTML = `
            <div class="bg-gray-50 p-4 rounded shadow">
              <div><strong>Name:</strong> ${info.name ?? '-'} </div>
              <div><strong>Loan Amount:</strong> ‚Çπ${info.loan_amount ?? '-'} </div>
              <div><strong>Loan Term (months):</strong> ${info.loan_term_months ?? '-'} </div>
              <div><strong>Interest Rate:</strong> ${info.interest_rate ?? '-'}% </div>
              <div><strong>Total Principal Repaid:</strong> ‚Çπ${totalPrincipalRepaid} </div>
              <div><strong>Total Interest Repaid:</strong> ‚Çπ${totalInterestRepaid} </div>
              <div><strong>Outstanding Amount:</strong> ‚Çπ${info.outstanding_amount ?? '-'} </div>
            </div>`;
        } else {
          const msg = (data && data.message) ? data.message : 'No loan found.';
          loanInfoSearchResult.innerHTML = `<div class="text-red-600">${msg}</div>`;
        }
      } catch {
        loanInfoSearchResult.innerHTML = '<div class="text-red-600">Network error.</div>';
      }
    });
  }

  // Show/hide sections logic for admin-nav-btn
  const navBtns = document.querySelectorAll('.admin-nav-btn');
  const sections = document.querySelectorAll('.admin-section');
  navBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const target = btn.dataset.target;
      // Highlight active sidebar button
      navBtns.forEach(b => {
        b.classList.remove('bg-blue-600', 'text-white');
        b.classList.add('bg-blue-100', 'text-blue-700');
      });
      btn.classList.remove('bg-blue-100', 'text-blue-700');
      btn.classList.add('bg-blue-600', 'text-white');
      // Show section
      sections.forEach(sec => sec.classList.add('hidden'));
      const showSec = document.getElementById(target);
      if (showSec) {
        showSec.classList.remove('hidden');
        // If viewExpenses, trigger a resize event to force table redraw (fixes some Tailwind/JS table issues)
        if (target === 'viewExpenses') {
          setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
        }
      }
    });
  });
  // Show welcome section by default and highlight its button
  sections.forEach(sec => sec.classList.add('hidden'));
  document.getElementById('welcome').classList.remove('hidden');
  // Highlight the Home button by default
  const defaultBtn = document.querySelector('.admin-nav-btn[data-target="welcome"]');
  if (defaultBtn) {
    defaultBtn.classList.remove('bg-blue-100', 'text-blue-700');
    defaultBtn.classList.add('bg-blue-600', 'text-white');
  }

  // Recent Transactions: selectors + loader
  const rtYearSel = document.getElementById('rtYear');
  const rtMonthSel = document.getElementById('rtMonth');
  const rtDaySel = document.getElementById('rtDay');
  const rtBtn = document.getElementById('rtFilterBtn');
  const rtBody = document.getElementById('rtTableBody');

  function populateRtSelectors() {
    if (!rtYearSel || !rtMonthSel || !rtDaySel) return;
    const now = new Date();
    const cy = now.getFullYear();
    const cm = now.getMonth() + 1;
    const cd = now.getDate();
    const years = [];
    for (let y = cy; y >= cy - 5; y--) years.push(y);
    rtYearSel.innerHTML = ['<option value="">All</option>'].concat(years.map(y => `<option value="${y}">${y}</option>`)).join('');
    rtYearSel.value = String(cy);
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    rtMonthSel.innerHTML = ['<option value="">All</option>'].concat(monthNames.map((n,i) => `<option value="${i+1}">${n}</option>`)).join('');
    rtMonthSel.value = String(cm);
    const days = Array.from({length: 31}, (_,i) => i+1);
    rtDaySel.innerHTML = ['<option value="">All</option>'].concat(days.map(d => `<option value="${d}">${d}</option>`)).join('');
    rtDaySel.value = String(cd);
  }

  async function loadRecentTransactions() {
    if (!rtBody) return;
    rtBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>';
    try {
      const qs = new URLSearchParams();
      if (rtYearSel && rtYearSel.value) qs.set('year', rtYearSel.value);
      if (rtMonthSel && rtMonthSel.value) qs.set('month', rtMonthSel.value);
      if (rtDaySel && rtDaySel.value) qs.set('day', rtDaySel.value);
      const res = await fetch(`/admin/api/recent-transactions${qs.toString() ? ('?' + qs.toString()) : ''}`);
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      const events = data.events || [];
      if (!events.length) {
        rtBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No data</td></tr>';
        return;
      }
      rtBody.innerHTML = events.map(ev => `
        <tr>
          <td class="px-4 py-2">${ev.date ? new Date(ev.date).toLocaleString() : '-'}</td>
          <td class="px-4 py-2">${ev.type || '-'}</td>
          <td class="px-4 py-2">‚Çπ${Number(ev.amount || 0).toLocaleString()}</td>
          <td class="px-4 py-2">${ev.details || '-'}</td>
          <td class="px-4 py-2">${ev.ref_id || '-'}</td>
        </tr>
      `).join('');
    } catch (e) {
      console.error('Recent transactions load failed:', e);
      rtBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-600">Failed to load</td></tr>';
    }
  }
  populateRtSelectors();
  if (rtBtn) rtBtn.addEventListener('click', loadRecentTransactions);

  // Loan tab navigation
  const loanTabBtns = document.querySelectorAll('.loan-tab-btn');
  const loanTabContents = document.querySelectorAll('.loan-tab-content');
  loanTabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update active tab styling
      loanTabBtns.forEach(b => {
        b.classList.remove('border-green-500', 'text-green-700');
        b.classList.add('border-transparent', 'text-gray-500');
      });
      btn.classList.remove('border-transparent', 'text-gray-500');
      btn.classList.add('border-green-500', 'text-green-700');
      // Show selected tab content
      const target = btn.getAttribute('data-target');
      loanTabContents.forEach(content => content.classList.add('hidden'));
      // Defensive: only show if exists
      const tgt = document.getElementById(target);
      if (tgt) tgt.classList.remove('hidden');
    });
  });

  // Ensure the first tab and its content are visible by default
  // (fix for: approved/rejected tabs not showing on first load)
  if (loanTabBtns.length && loanTabContents.length) {
    // Remove all tab content hidden
    loanTabContents.forEach(content => content.classList.add('hidden'));
    // Find the active tab (with border-green-500), else default to first
    let activeIdx = Array.from(loanTabBtns).findIndex(btn => btn.classList.contains('border-green-500'));
    if (activeIdx < 0) activeIdx = 0;
    loanTabBtns.forEach((btn, idx) => {
      if (idx === activeIdx) {
        btn.classList.add('border-green-500', 'text-green-700');
        btn.classList.remove('border-transparent', 'text-gray-500');
        loanTabContents[idx].classList.remove('hidden');
      } else {
        btn.classList.remove('border-green-500', 'text-green-700');
        btn.classList.add('border-transparent', 'text-gray-500');
      }
    });
  }

  // Customer Details Search functionality
  const customerSearchForm = document.getElementById('customerSearchForm');
  const customerSearchInput = document.getElementById('customerSearchInput');
  const customerSearchLoading = document.getElementById('customerSearchLoading');
  const customerSearchResults = document.getElementById('customerSearchResults');
  const customerSearchError = document.getElementById('customerSearchError');
  const customerSearchErrorMessage = document.getElementById('customerSearchErrorMessage');

  if (customerSearchForm) {
    customerSearchForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const searchValue = customerSearchInput.value.trim();
      if (!searchValue) {
        showError('Please enter a Customer ID or KGID');
        return;
      }

      // Reset previous states
      hideAllSearchStates();
      customerSearchLoading.classList.remove('hidden');

      try {
        let customerId = searchValue;
        // If input looks like a KGID (not all digits), resolve to customer_id first
        if (!/^\d+$/.test(searchValue)) {
          // Looks like KGID, resolve to customer_id via API
          const resp = await fetch(`/admin/api/member-details-by-kgid?kgid=${encodeURIComponent(searchValue)}`);
          const data = await resp.json();
          if (data.status === 'success' && data.member && data.member.customer_id) {
            customerId = data.member.customer_id;
          } else {
            // Try fallback: search by KGID as customer_id (for legacy/edge cases)
            const fallbackResp = await fetch(`/admin/api/customer-info?customer_id=${encodeURIComponent(searchValue)}`);
            const fallbackData = await fallbackResp.json();
            if (fallbackData.status === 'success') {
              displayCustomerDetails(fallbackData);
              customerSearchLoading.classList.add('hidden');
              return;
            }
            showError('KGID not found or not mapped to a customer.');
            customerSearchLoading.classList.add('hidden');
            return;
          }
        }
        let url = '/admin/api/customer-info?customer_id=' + encodeURIComponent(customerId);
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success') {
          displayCustomerDetails(data);
        } else {
          showError(data.message || 'Customer not found');
        }
      } catch (error) {
        console.error('Error fetching customer details:', error);
        showError('Network error. Please try again.');
      } finally {
        customerSearchLoading.classList.add('hidden');
      }
    });
  }

  function hideAllSearchStates() {
    customerSearchLoading.classList.add('hidden');
    customerSearchResults.classList.add('hidden');
    customerSearchError.classList.add('hidden');
  }

  function showError(message) {
    hideAllSearchStates();
    customerSearchErrorMessage.textContent = message;
    customerSearchError.classList.remove('hidden');
  }

  function displayCustomerDetails(data) {
    hideAllSearchStates();

    const customerInfo = data.customer;
    // Only include loans that are not rejected for outstanding calculation
    const loans = (data.loans || []);
    const activeLoans = loans.filter(l => String(l.status).toLowerCase() !== 'rejected');

    // Populate basic customer info with photos on the right side
    const basicInfoContainer = document.getElementById('customerBasicInfo');
    basicInfoContainer.innerHTML = `
      <div class="col-span-1 md:col-span-2 lg:col-span-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Name</p>
            <p class="font-medium">${customerInfo.name || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Customer ID</p>
            <p class="font-medium">${customerInfo.customer_id || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">KGID</p>
            <p class="font-medium">${customerInfo.kgid || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Phone</p>
            <p class="font-medium">${customerInfo.phone || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Email</p>
            <p class="font-medium">${customerInfo.email || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Current Balance</p>
            <p class="font-medium text-blue-700">‚Çπ${Number(customerInfo.balance || 0).toLocaleString()}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Share Amount</p>
            <p class="font-medium text-green-700">
              ‚Çπ${Number(customerInfo.share_amount || 0).toLocaleString()}
              ${Number(customerInfo.share_amount || 0) >= 30000 ? '<span class="ml-2 inline-block px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-700 align-middle">Share Account Completed</span>' : ''}
            </p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Organization</p>
            <p class="font-medium">${customerInfo.organization_name || 'N/A'}</p>
          </div>
        </div>
      </div>
      <div class="col-span-1 lg:col-span-1 flex flex-col items-center space-y-4">
        <div class="text-center">
          <h4 class="font-medium text-gray-700 mb-2">Profile Photo</h4>
          ${customerInfo.photo_url ? `
            <img src="${customerInfo.photo_url}" 
                 alt="Customer Photo" 
                 class="w-32 h-32 object-cover rounded-lg border-2 border-gray-300 shadow-md cursor-pointer hover:shadow-lg transition-shadow"
                 onclick="showImageModal('${customerInfo.photo_url}', 'Customer Photo')" />
          ` : `
            <div class="w-32 h-32 bg-gray-200 rounded-lg border-2 border-gray-300 flex items-center justify-center">
              <span class="text-gray-500 text-sm text-center">No Photo<br>Available</span>
            </div>
          `}
        </div>
        <div class="text-center">
          <h4 class="font-medium text-gray-700 mb-2">Signature</h4>
          ${customerInfo.signature_url ? `
            <img src="${customerInfo.signature_url}" 
                 alt="Customer Signature" 
                 class="w-32 h-20 object-contain rounded-lg border-2 border-gray-300 shadow-md cursor-pointer hover:shadow-lg transition-shadow bg-white"
                 onclick="showImageModal('${customerInfo.signature_url}', 'Customer Signature')" />
          ` : `
            <div class="w-32 h-20 bg-gray-200 rounded-lg border-2 border-gray-300 flex items-center justify-center">
              <span class="text-gray-500 text-xs text-center">No Signature<br>Available</span>
            </div>
          `}
        </div>
      </div>
    `;

    // Populate loan summary (exclude rejected loans from outstanding)
    const loanSummaryContainer = document.getElementById('loanSummaryInfo');
    let totalLoans = loans.length;
    let totalOutstanding = activeLoans.reduce((sum, l) => sum + (Number(l.outstanding_amount) || 0), 0);
    loanSummaryContainer.innerHTML = `
      <div class="text-center p-4 bg-blue-50 rounded-lg">
        <p class="text-2xl font-bold text-blue-600">${totalLoans}</p>
        <p class="text-sm text-gray-600">Total Loans</p>
      </div>
      <div class="text-center p-4 bg-red-50 rounded-lg">
        <p class="text-2xl font-bold text-red-600">‚Çπ${(totalOutstanding || 0).toLocaleString()}</p>
        <p class="text-sm text-gray-600">Outstanding</p>
      </div>
    `;

    // Populate loans table
    const loansTableBody = document.getElementById('loansTableBody');
    if (loans.length === 0) {
      loansTableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No loans found</td></tr>';
    } else {
      loansTableBody.innerHTML = loans.map(loan => `
        <tr class="border-t">
          <td class="px-4 py-3">${loan.loan_id || '-'}</td>
          <td class="px-4 py-3">${loan.loan_type || '-'}</td>
          <td class="px-4 py-3">‚Çπ${(loan.loan_amount || 0).toLocaleString()}</td>
          <td class="px-4 py-3">${loan.status || '-'}</td>
          <td class="px-4 py-3">${loan.created_at ? new Date(loan.created_at).toLocaleDateString() : '-'}</td>
          <td class="px-4 py-3">‚Çπ${(loan.outstanding_amount || 0).toLocaleString()}</td>
          <td class="px-4 py-3"></td>
        </tr>
      `).join('');
    }

    // Transactions table is not available from this API, so clear it
    const transactionsTableBody = document.getElementById('transactionsTableBody');
    if (transactionsTableBody) {
      transactionsTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No transactions found</td></tr>';
    }

    customerSearchResults.classList.remove('hidden');
  }

  // ===== Audit: Loans (yearly) + Transactions (monthly) =====
  let loanAuditChartInstance = null;
  let txnAuditChartInstance = null;
  let salaryAuditChartInstance = null;
  let expensesAuditChartInstance = null;
  let shareAmountChartInstance = null;
  async function loadTotalAmount() {
    const el = document.getElementById('auditTotalAmount');
    if (!el) return;
    el.textContent = 'Loading...';
    try {
      const res = await fetch('/admin/api/total-amount-summary');
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      el.textContent = `‚Çπ${Number(data.total_amount || 0).toLocaleString()}`;
      el.title = `Balance: ‚Çπ${Number(data.total_balance||0).toLocaleString()} + Share Amount: ‚Çπ${Number(data.total_share_amount||0).toLocaleString()} + Interest: ‚Çπ${Number(data.total_interest_earned||0).toLocaleString()}`;
    } catch (e) {
      el.textContent = '‚Äî';
      console.error('Total amount load failed:', e);
    }
  }
  async function ensureChartJs() {
    if (window.Chart) return;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
    });
  }
  function populateLoanAuditYears() {
    const sel = document.getElementById('loanAuditYear');
    if (!sel) return;
    const current = new Date().getFullYear();
    const years = [];
    for (let y = current; y >= current - 5; y--) years.push(y);
    sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    sel.value = String(current);
  }
  function populateTxnAuditSelectors() {
    const ySel = document.getElementById('txnAuditYear');
    const mSel = document.getElementById('txnAuditMonth');
    if (!ySel || !mSel) return;
    const now = new Date();
    const cy = now.getFullYear();
    const cm = now.getMonth() + 1;
    const years = [];
    for (let y = cy; y >= cy - 5; y--) years.push(y);
    ySel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    ySel.value = String(cy);
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    mSel.innerHTML = monthNames.map((n,i) => `<option value="${i+1}">${n}</option>`).join('');
    mSel.value = String(cm);
  }
  function populateSalaryAuditYears() {
    const sel = document.getElementById('salaryAuditYear');
    if (!sel) return;
    const current = new Date().getFullYear();
    const years = [];
    for (let y = current; y >= current - 5; y--) years.push(y);
    sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    sel.value = String(current);
  }
  function populateExpensesAuditSelectors() {
    const ySel = document.getElementById('expensesAuditYear');
    const mSel = document.getElementById('expensesAuditMonth');
    if (!ySel || !mSel) return;
    const now = new Date();
    const cy = now.getFullYear();
    const cm = now.getMonth() + 1;
    const years = [];
    for (let y = cy; y >= cy - 5; y--) years.push(y);
    ySel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    ySel.value = String(cy);
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    mSel.innerHTML = monthNames.map((n,i) => `<option value="${i+1}">${n}</option>`).join('');
    mSel.value = String(cm);
  }
  async function loadLoanAudit(year) {
    const disEl = document.getElementById('auditTotalDisbursed');
    const recEl = document.getElementById('auditTotalRecovered');
    const canvas = document.getElementById('loanAuditChart');
    if (!disEl || !recEl || !canvas) return;
    disEl.textContent = 'Loading...';
    recEl.textContent = 'Loading...';
    try {
      const qs = new URLSearchParams();
      if (year) qs.set('year', String(year));
      const res = await fetch(`/admin/api/loan-yearly-summary${qs.toString() ? ('?' + qs.toString()) : ''}`);
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      disEl.textContent = `‚Çπ${Number(data.total_disbursed || 0).toLocaleString()}`;
      recEl.textContent = `‚Çπ${Number(data.total_recovered || 0).toLocaleString()}`;

      const labels = (data.labels || []);
      const disbursed = data.disbursed || [];
      const recovered = data.recovered || [];
      await ensureChartJs();
      const ctx = canvas.getContext('2d');
      if (loanAuditChartInstance) loanAuditChartInstance.destroy();
      loanAuditChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { 
          labels, 
          datasets: [
            { 
              label: 'Disbursed', 
              data: disbursed, 
              backgroundColor: 'rgba(79,70,229,0.5)', 
              borderColor: '#4f46e5', 
              borderWidth: 1 
            },
            { 
              label: 'Recovered', 
              data: recovered, 
              backgroundColor: 'rgba(16,185,129,0.5)', 
              borderColor: '#10b981', 
              borderWidth: 1 
            }
          ] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { position: 'top' }, 
            tooltip: { 
              callbacks: { 
                label: (ctx) => `${ctx.dataset.label}: ‚Çπ${Number(ctx.parsed.y).toLocaleString()}` 
              } 
            } 
          },
          scales: { 
            y: { 
              beginAtZero: true, 
              ticks: { 
                callback: (v) => `‚Çπ${Number(v).toLocaleString()}` 
              } 
            }, 
            x: { 
              title: { 
                display: true, 
                text: 'Month' 
              } 
            } 
          }
        }
      });
    } catch (e) {
      disEl.textContent = '‚Äî';
      recEl.textContent = '‚Äî';
      console.error('Loan audit load failed:', e);
    }
  }
  async function loadTxnAudit(year, month) {
    const depEl = document.getElementById('auditTotalDeposit');
    const wdwEl = document.getElementById('auditTotalWithdrawal');
    const canvas = document.getElementById('txnAuditChart');
    if (!depEl || !wdwEl || !canvas) return;
    depEl.textContent = 'Loading...';
    wdwEl.textContent = 'Loading...';
    try {
      const qs = new URLSearchParams();
      if (year) qs.set('year', String(year));
      if (month) qs.set('month', String(month));
      const res = await fetch(`/admin/api/monthly-summary${qs.toString() ? ('?' + qs.toString()) : ''}`);
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      depEl.textContent = `‚Çπ${Number(data.total_deposit || 0).toLocaleString()}`;
      wdwEl.textContent = `‚Çπ${Number(data.total_withdrawal || 0).toLocaleString()}`;

      const labels = (data.labels || []).map(String);
      const deposits = data.deposits || [];
      const withdrawals = data.withdrawals || [];
      await ensureChartJs();
      const ctx = canvas.getContext('2d');
      if (txnAuditChartInstance) txnAuditChartInstance.destroy();
      txnAuditChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Deposits', data: deposits, borderColor: '#16a34a', backgroundColor: 'rgba(22,163,74,0.15)', tension: 0.25, fill: true },
          { label: 'Withdrawals', data: withdrawals, borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.15)', tension: 0.25, fill: true }
        ] },
        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (ctx) => `‚Çπ${Number(ctx.parsed.y).toLocaleString()}` } } },
          scales: { y: { ticks: { callback: (v) => `‚Çπ${Number(v).toLocaleString()}` } }, x: { title: { display: true, text: 'Day of Month' } } }
        }
      });
    } catch (e) {
      depEl.textContent = '‚Äî';
      wdwEl.textContent = '‚Äî';
      console.error('Transactions audit load failed:', e);
    }
  }
  async function loadSalaryAudit(year) {
    const totalEl = document.getElementById('auditTotalSalariesYear');
    const avgEl = document.getElementById('auditAvgSalariesMonth');
    const canvas = document.getElementById('salaryAuditChart');
    if (!totalEl || !avgEl || !canvas) return;
    totalEl.textContent = 'Loading...';
    avgEl.textContent = 'Loading...';
    try {
      const qs = new URLSearchParams(); if (year) qs.set('year', String(year));
      const res = await fetch(`/admin/api/staff-salary-yearly-summary${qs.toString() ? ('?' + qs.toString()) : ''}`);
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      totalEl.textContent = `‚Çπ${Number(data.total_year || 0).toLocaleString()}`;
      const months = 12; const avg = (Number(data.total_year || 0) / months) || 0;
      avgEl.textContent = `‚Çπ${avg.toFixed(2).toLocaleString()}`;
      const labels = data.labels || []; const totals = data.totals = data.totals || [];
      await ensureChartJs();
      const ctx = canvas.getContext('2d');
      if (salaryAuditChartInstance) salaryAuditChartInstance.destroy();
      salaryAuditChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Salaries', data: totals, backgroundColor: 'rgba(245,158,11,0.5)', borderColor: '#f59e0b', borderWidth: 1 }]},

        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => `‚Çπ${Number(v).toLocaleString()}` } } }, plugins: { legend: { display: false } } }
      });
    } catch (e) {
      totalEl.textContent = '‚Äî';
      avgEl.textContent = '‚Äî';
      console.error('Salary audit load failed:', e);
    }
  }
  async function loadExpensesAudit(year, month) {
    const totalEl = document.getElementById('auditTotalExpensesMonth');
    const avgEl = document.getElementById('auditAvgExpensesDay');
    const canvas = document.getElementById('expensesAuditChart');
    if (!totalEl || !avgEl || !canvas) return;
    totalEl.textContent = 'Loading...';
    avgEl.textContent = 'Loading...';
    try {
      const qs = new URLSearchParams(); if (year) qs.set('year', String(year)); if (month) qs.set('month', String(month));
      const res = await fetch(`/admin/api/expenses-monthly-summary${qs.toString() ? ('?' + qs.toString()) : ''}`);
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      totalEl.textContent = `‚Çπ${Number(data.total_month || 0).toLocaleString()}`;
      const days = (data.labels || []).length || 1; const avg = (Number(data.total_month || 0) / days) || 0;
      avgEl.textContent = `‚Çπ${avg.toFixed(2).toLocaleString()}`;
      const labels = (data.labels || []).map(String); const totals = data.totals || [];
      await ensureChartJs();
      const ctx = canvas.getContext('2d');
      if (expensesAuditChartInstance) expensesAuditChartInstance.destroy();
      expensesAuditChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Expenses', data: totals, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.15)', tension: 0.25, fill: true }]},
        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (ctx) => `‚Çπ${Number(ctx.parsed.y).toLocaleString()}` } } }, scales: { y: { ticks: { callback: v => `‚Çπ${Number(v).toLocaleString()}` } }, x: { title: { display: true, text: 'Day of Month' } } } }
      });
    } catch (e) {
      totalEl.textContent = '‚Äî'; avgEl.textContent = '‚Äî'; console.error('Expenses audit load failed:', e);
    }
  }

  async function loadShareAmountAudit() {
    const totalEl = document.getElementById('auditTotalShareAmount');
    const countEl = document.getElementById('auditShareMemberCount');
    const avgEl = document.getElementById('auditAvgShareAmount');
    const tableBody = document.getElementById('shareAmountTableBody');
    
    if (!totalEl || !countEl || !avgEl || !tableBody) return;
    
    totalEl.textContent = 'Loading...';
    countEl.textContent = 'Loading...';
    avgEl.textContent = 'Loading...';
    tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';
    
    try {
      const res = await fetch('/admin/api/share-amount-summary');
      const data = await res.json();
      if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load');
      
      totalEl.textContent = `‚Çπ${Number(data.total_share_amount || 0).toLocaleString()}`;
      countEl.textContent = Number(data.member_count || 0).toLocaleString();
      const avgAmount = data.member_count > 0 ? (data.total_share_amount / data.member_count) : 0;
      avgEl.textContent = `‚Çπ${Number(avgAmount).toLocaleString()}`;
      
      // Populate table
      const members = data.members || [];
      if (members.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No share amounts found</td></tr>';
      } else {
        tableBody.innerHTML = members.map(member => `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.name || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.customer_id || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-600">‚Çπ${Number(member.share_amount || 0).toLocaleString()}</td>
          </tr>
        `).join('');
      }
    } catch (e) {
      totalEl.textContent = '‚Äî';
      countEl.textContent = '‚Äî';
      avgEl.textContent = '‚Äî';
      tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error loading data</td></tr>';
      console.error('Share amount audit load failed:', e);
    }
  }

  // Initialize Audit controls and handlers
  populateLoanAuditYears();
  populateTxnAuditSelectors();
  populateSalaryAuditYears();
  populateExpensesAuditSelectors();
  loadTotalAmount();
  const loanYearSel = document.getElementById('loanAuditYear');
  const txnYearSel = document.getElementById('txnAuditYear');
  const txnMonthSel = document.getElementById('txnAuditMonth');
  const salaryYearSel = document.getElementById('salaryAuditYear');
  const expensesYearSel = document.getElementById('expensesAuditYear');
  const expensesMonthSel = document.getElementById('expensesAuditMonth');
  
  if (loanYearSel) loanYearSel.addEventListener('change', () => loadLoanAudit(loanYearSel.value));
  if (txnYearSel && txnMonthSel) {
    const refreshTxn = () => loadTxnAudit(txnYearSel.value, txnMonthSel.value);
    txnYearSel.addEventListener('change', refreshTxn);
    txnMonthSel.addEventListener('change', refreshTxn);
  }
  if (salaryYearSel) salaryYearSel.addEventListener('change', () => loadSalaryAudit(salaryYearSel.value));
  if (expensesYearSel && expensesMonthSel) {
    const refreshExpenses = () => loadExpensesAudit(expensesYearSel.value, expensesMonthSel.value);
    expensesYearSel.addEventListener('change', refreshExpenses);
    expensesMonthSel.addEventListener('change', refreshExpenses);
  }
  // Tabs toggle
  const tabLoans = document.getElementById('auditTabLoans');
  const tabTxns = document.getElementById('auditTabTransactions');
  const tabSalaries = document.getElementById('auditTabSalaries');
  const tabExpenses = document.getElementById('auditTabExpenses');
  const tabShareAmount = document.getElementById('auditTabShareAmount');
  const loanPanel = document.getElementById('loanAuditPanel');
  const txnPanel = document.getElementById('txnAuditPanel');
  const salaryPanel = document.getElementById('salaryAuditPanel');
  const expensesPanel = document.getElementById('expensesAuditPanel');
  const shareAmountPanel = document.getElementById('shareAmountAuditPanel');
  function showLoanTab() {
    loanPanel.classList.remove('hidden');
    txnPanel.classList.add('hidden');
    salaryPanel.classList.add('hidden');
    expensesPanel.classList.add('hidden');
    shareAmountPanel.classList.add('hidden');
    tabLoans.classList.remove('bg-gray-100','text-gray-700');
    tabLoans.classList.add('bg-blue-600','text-white');
    [tabTxns, tabSalaries, tabExpenses, tabShareAmount].forEach(b => { 
      b.classList.remove('bg-blue-600','text-white'); 
      b.classList.add('bg-gray-100','text-gray-700'); 
    });
    // Delay chart loading to ensure canvas is visible
    setTimeout(() => {
      loadLoanAudit(loanYearSel ? loanYearSel.value : new Date().getFullYear());
    }, 100);
  }
  function showTxnTab() {
    txnPanel.classList.remove('hidden');
    loanPanel.classList.add('hidden');
    salaryPanel.classList.add('hidden');
    expensesPanel.classList.add('hidden');
    shareAmountPanel.classList.add('hidden');
    tabTxns.classList.remove('bg-gray-100','text-gray-700'); tabTxns.classList.add('bg-blue-600','text-white');
    [tabLoans, tabSalaries, tabExpenses, tabShareAmount].forEach(b => { b.classList.remove('bg-blue-600','text-white'); b.classList.add('bg-gray-100','text-gray-700'); });
    loadTxnAudit(txnYearSel ? txnYearSel.value : undefined, txnMonthSel ? txnMonthSel.value : undefined);
  }
  function showSalaryTab() {
    salaryPanel.classList.remove('hidden');
    loanPanel.classList.add('hidden');
    txnPanel.classList.add('hidden');
    expensesPanel.classList.add('hidden');
    shareAmountPanel.classList.add('hidden');
    tabSalaries.classList.remove('bg-gray-100','text-gray-700'); tabSalaries.classList.add('bg-blue-600','text-white');
    [tabLoans, tabTxns, tabExpenses, tabShareAmount].forEach(b => { 
      b.classList.remove('bg-blue-600','text-white'); 
      b.classList.add('bg-gray-100','text-gray-700'); 
    });
    setTimeout(() => {
      loadSalaryAudit(salaryYearSel ? salaryYearSel.value : new Date().getFullYear());
    }, 100);
  }
  function showExpensesTab() {
    expensesPanel.classList.remove('hidden');
    loanPanel.classList.add('hidden');
    txnPanel.classList.add('hidden');
    salaryPanel.classList.add('hidden');
    shareAmountPanel.classList.add('hidden');
    tabExpenses.classList.remove('bg-gray-100','text-gray-700'); tabExpenses.classList.add('bg-blue-600','text-white');
    [tabLoans, tabTxns, tabSalaries, tabShareAmount].forEach(b => { 
      b.classList.remove('bg-blue-600','text-white'); 
      b.classList.add('bg-gray-100','text-gray-700'); 
    });
    setTimeout(() => {
      loadExpensesAudit(expensesYearSel?.value, expensesMonthSel?.value);
    }, 100);
  }
  function showShareAmountTab() {
    shareAmountPanel.classList.remove('hidden');
    loanPanel.classList.add('hidden');
    txnPanel.classList.add('hidden');
    salaryPanel.classList.add('hidden');
    expensesPanel.classList.add('hidden');
    tabShareAmount.classList.remove('bg-gray-100','text-gray-700'); tabShareAmount.classList.add('bg-blue-600','text-white');
    [tabLoans, tabTxns, tabSalaries, tabExpenses].forEach(b => { 
      b.classList.remove('bg-blue-600','text-white'); 
      b.classList.add('bg-gray-100','text-gray-700'); 
    });
    setTimeout(() => {
      loadShareAmountAudit();
    }, 100);
  }
  if (tabLoans) tabLoans.addEventListener('click', showLoanTab);
  if (tabTxns) tabTxns.addEventListener('click', showTxnTab);
  if (tabSalaries) tabSalaries.addEventListener('click', showSalaryTab);
  if (tabExpenses) tabExpenses.addEventListener('click', showExpensesTab);
  if (tabShareAmount) tabShareAmount.addEventListener('click', showShareAmountTab);

  // Excel Download for Share Amount
  const shareAmountDownloadBtn = document.getElementById('shareAmountDownloadBtn');
  if (shareAmountDownloadBtn) {
    shareAmountDownloadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/admin/api/share-amount/excel');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'share_amounts.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Excel download failed:', error);
        alert('Failed to download Excel file');
      }
    });
  }

  // Excel Download for Loans
  const loansDownloadBtn = document.getElementById('loansDownloadBtn');
  if (loansDownloadBtn) {
    loansDownloadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/admin/api/audit-loans/excel');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_loans.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Excel download failed:', error);
        alert('Failed to download Excel file');
      }
    });
  }

  // Excel Download for Transactions
  const transactionsDownloadBtn = document.getElementById('transactionsDownloadBtn');
  if (transactionsDownloadBtn) {
    transactionsDownloadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/admin/api/audit-transactions/excel');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_transactions.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Excel download failed:', error);
        alert('Failed to download Excel file');
      }
    });
  }

  // Excel Download for Expenses
  const expensesDownloadBtn = document.getElementById('expensesDownloadBtn');
  if (expensesDownloadBtn) {
    expensesDownloadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/admin/api/audit-expenses/excel');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_expenses.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Excel download failed:', error);
        alert('Failed to download Excel file');
      }
    });
  }

  // Excel Download for Salaries
  const salariesDownloadBtn = document.getElementById('salariesDownloadBtn');
  if (salariesDownloadBtn) {
    salariesDownloadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/admin/api/audit-salaries/excel');
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_salaries.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Excel download failed:', error);
        alert('Failed to download Excel file');
      }
    });
  }

  // Initialize with loans tab active and load initial data
  setTimeout(() => {
    showLoanTab();
  }, 500);
});
</script>
{% endblock %}
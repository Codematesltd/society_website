{% extends 'admin/base.html' %}

{% block title %}Admin Dashboard - Chit Fund Management{% endblock %}

{% block header %}{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-50">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-lg p-6 space-y-4">
    <h2 class="font-bold text-xl text-blue-700 mb-6">Admin Dashboard</h2>
    <nav class="space-y-3">
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="welcome">🏠 Home</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="accountRequests">📝 Account Requests</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="loanApprovals">💰 Loan Approvals</button>
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="customerDetails">👤 Customer Details</button>
      <!-- New: View Expenses -->
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="expenses">📋 View Expenses</button>
      <!-- NEW: Add Staff -->
      <button type="button" class="admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all" data-target="addStaff">👥 Add Staff</button>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="flex-1 p-8 space-y-6">
    <!-- Welcome Section -->
    <section id="welcome" class="admin-section">
      <div class="bg-white p-8 rounded-xl shadow text-center">
        <h1 class="text-3xl font-bold text-blue-700 mb-4">Welcome to Admin Dashboard</h1>
        <p class="text-gray-600">Use the navigation menu to manage accounts and view requests.</p>
        
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
          <!-- Account Requests Card -->
          <div class="bg-blue-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
            <div class="text-4xl text-blue-500 mb-2">📝</div>
            <h3 class="text-xl font-bold text-blue-700 mb-2">Account Requests</h3>
            <p class="text-gray-600 mb-4">Review and approve new member account requests</p>
            <button class="admin-nav-btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition" data-target="accountRequests">View Requests</button>
          </div>
          
          <!-- Loan Approvals Card -->
          <div class="bg-green-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
            <div class="text-4xl text-green-500 mb-2">💰</div>
            <h3 class="text-xl font-bold text-green-700 mb-2">Loan Approvals</h3>
            <p class="text-gray-600 mb-4">Review and manage pending loan applications</p>
            <button class="admin-nav-btn bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition" data-target="loanApprovals">View Loans</button>
          </div>
          
          <!-- Stats Card -->
          <div class="bg-purple-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
            <div class="text-4xl text-purple-500 mb-2">📊</div>
            <h3 class="text-xl font-bold text-purple-700 mb-2">Society Stats</h3>
            <p class="text-gray-600 mb-4">View overall society statistics and metrics</p>
            <button class="admin-nav-btn bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition" data-target="welcome">View Stats</button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Account Requests Section -->
    <section id="accountRequests" class="admin-section hidden">
      <iframe src="{{ url_for('admin.admin_account_requests') }}" class="w-full min-h-[600px] border-0 rounded-xl shadow"></iframe>
    </section>
    
    <!-- Loan Approvals Section -->
    <section id="loanApprovals" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Pending Loan Approvals</h2>
        
        <!-- Tabs for loan categories -->
        <div class="mb-6 border-b">
          <div class="flex space-x-4">
            <button class="loan-tab-btn px-4 py-2 border-b-2 border-green-500 text-green-700 font-medium" data-target="pendingLoans">Pending</button>
            <button class="loan-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-target="approvedLoans">Approved</button>
            <button class="loan-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-target="rejectedLoans">Rejected</button>
          </div>
        </div>
        
        <!-- Loan listings by status -->
        <div id="pendingLoans" class="loan-tab-content">
          <iframe src="{{ url_for('admin.pending_loan_approvals') }}" class="w-full min-h-[500px] border-0"></iframe>
        </div>
        
        <div id="approvedLoans" class="loan-tab-content hidden">
          <iframe src="{{ url_for('admin.approved_loans') }}" class="w-full min-h-[500px] border-0"></iframe>
        </div>
        
        <div id="rejectedLoans" class="loan-tab-content hidden">
          <iframe src="{{ url_for('admin.rejected_loans') }}" class="w-full min-h-[500px] border-0"></iframe>
        </div>
      </div>
    </section>
    
    <!-- Customer Details Section -->
    <section id="customerDetails" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-blue-700 mb-6">Customer Details</h2>
        
        <!-- Search Form -->
        <div class="mb-6">
          <form id="customerSearchForm" class="flex gap-4 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">Search Customer</label>
              <input type="text" id="customerSearchInput" placeholder="Enter Customer ID or KGID" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              Search
            </button>
          </form>
        </div>
        
        <!-- Loading State -->
        <div id="customerSearchLoading" class="hidden text-center py-4">
          <div class="inline-flex items-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-2"></div>
            <span class="text-blue-600">Searching...</span>
          </div>
        </div>
        
        <!-- Search Results -->
        <div id="customerSearchResults" class="hidden">
          <!-- Customer Basic Info Card -->
          <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Customer Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="customerBasicInfo">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Loans Summary -->
          <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Loan Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="loanSummaryInfo">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Detailed Loans Table -->
          <div class="bg-white border rounded-lg overflow-hidden">
            <h3 class="text-lg font-bold text-gray-800 p-4 border-b bg-gray-50">Loan Details</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Loan ID</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Applied Date</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Balance</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody id="loansTableBody">
                  <!-- Content will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Selected Loan Detailed Panel -->
          <div id="selectedLoanDetails" class="hidden bg-white border rounded-lg overflow-hidden mt-6">
            <div class="flex items-center justify-between p-4 border-b bg-gray-50">
              <h3 class="text-lg font-bold text-gray-800">Selected Loan Comprehensive View</h3>
              <button id="hideLoanDetailsBtn" class="text-sm text-gray-500 hover:text-gray-700">Hide ✕</button>
            </div>
            <div id="selectedLoanContent" class="p-4 text-sm">
              <!-- Filled dynamically -->
            </div>
          </div>
          
          <!-- Transactions History -->
          <div class="bg-white border rounded-lg overflow-hidden mt-6">
            <h3 class="text-lg font-bold text-gray-800 p-4 border-b bg-gray-50">Recent Transactions</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Balance After</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Remarks</th>
                  </tr>
                </thead>
                <tbody id="transactionsTableBody">
                  <!-- Content will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Error State -->
        <div id="customerSearchError" class="hidden">
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-red-800 font-medium" id="customerSearchErrorMessage">Customer not found</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Queries Section (Admin) -->
    <section id="adminQueries" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">User Queries</h2>
        <div id="adminQueriesMsg" class="mb-4"></div>
        <div class="overflow-x-auto">
          <table id="adminQueriesTable" class="min-w-full table-auto border-collapse">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">#</th>
                <th class="px-4 py-2 text-left">Name</th>
                <th class="px-4 py-2 text-left">Email / Phone</th>
                <th class="px-4 py-2 text-left">KGID / Customer</th>
                <th class="px-4 py-2 text-left">Description</th>
                <th class="px-4 py-2 text-left">Status</th>
                <th class="px-4 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="adminQueriesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- Expenses Section -->
    <section id="expenses" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Expenses</h2>
        <!-- Filters -->
        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Search ID / Name</label>
            <input id="expenseSearch" type="search" placeholder="Enter ID or name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-300" />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Date range</label>
            <div class="flex gap-2">
              <input id="expenseDateFrom" type="date" class="w-full px-3 py-2 border rounded-lg" />
              <input id="expenseDateTo" type="date" class="w-full px-3 py-2 border rounded-lg" />
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Month</label>
            <select id="expenseMonth" class="w-full px-3 py-2 border rounded-lg">
              <option value="">All months</option>
            </select>
          </div>
        </div>
        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Amount min / max</label>
            <div class="flex gap-2">
              <input id="amountMin" type="number" placeholder="Min" class="w-full px-3 py-2 border rounded-lg" />
              <input id="amountMax" type="number" placeholder="Max" class="w-full px-3 py-2 border rounded-lg" />
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="applyFiltersBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Apply</button>
            <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Clear</button>
            <button id="refreshExpensesBtn" class="px-4 py-2 bg-white border text-gray-700 rounded-lg">Refresh</button>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-500">Count: <span id="expensesCount">0</span></div>
            <div class="text-sm text-yellow-600 font-semibold">Total: ₹<span id="expensesTotal">0</span></div>
          </div>
        </div>

        <div id="expensesLoading" class="hidden text-center py-4">
          <div class="inline-flex items-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mr-2"></div>
            <span class="text-indigo-600">Loading expenses...</span>
          </div>
        </div>
        <div id="expensesError" class="hidden text-red-600 mb-4"></div>
        <div id="expensesContainer" class="overflow-x-auto hidden">
          <table class="w-full table-auto">
            <thead id="expensesTableHead" class="bg-gray-100">
              <!-- headers will be generated dynamically -->
            </thead>
            <tbody id="expensesTableBody" class="bg-white"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- NEW: Add Staff Section -->
    <section id="addStaff" class="admin-section hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Add Staff</h2>
        <iframe src="{{ url_for('admin.admin_add_staff') }}" class="w-full min-h-[850px] border-0 rounded-xl shadow" title="Add Staff"></iframe>
      </div>
    </section>
  </main>
</div>
  <!-- Floating Civil Score Button for Admin -->
  <style>
    .floating-box { transform: translateY(100%); opacity: 0; transition: transform 0.4s ease, opacity 0.4s ease; }
    .floating-box.show { transform: translateY(0); opacity: 1; }
  </style>
  <button id="adminCivilBtn" class="fixed bottom-20 right-6 bg-green-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-green-700 z-50">
    📊 Civil Score
  </button>
  <div id="adminCivilBox" class="floating-box hidden fixed bottom-28 right-6 w-80 bg-white rounded-xl shadow-2xl p-4 z-50">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-bold">Check Civil Score</h3>
      <button id="closeAdminCivil" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <input id="adminCivilInput" class="w-full mb-3 px-4 py-2 border rounded" placeholder="Enter Customer ID or KGID Number">
    <button id="adminCheckCivil" class="bg-green-600 text-white px-6 py-2 rounded w-full hover:bg-green-700">Check Now</button>
    <div id="adminCivilResult" class="mt-3 text-center text-blue-700"></div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  // Sidebar navigation logic
  const navBtns = document.querySelectorAll('.admin-nav-btn');
  const sections = document.querySelectorAll('.admin-section');
  navBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const target = btn.getAttribute('data-target');
      sections.forEach(sec => sec.classList.add('hidden'));
      document.getElementById(target).classList.remove('hidden');
    });
  });
  
  // Loan tab navigation
  const loanTabBtns = document.querySelectorAll('.loan-tab-btn');
  const loanTabContents = document.querySelectorAll('.loan-tab-content');
  loanTabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update active tab styling
      loanTabBtns.forEach(b => {
        b.classList.remove('border-green-500', 'text-green-700');
        b.classList.add('border-transparent', 'text-gray-500');
      });
      btn.classList.remove('border-transparent', 'text-gray-500');
      btn.classList.add('border-green-500', 'text-green-700');
      
      // Show selected tab content
      const target = btn.getAttribute('data-target');
      loanTabContents.forEach(content => content.classList.add('hidden'));
      document.getElementById(target).classList.remove('hidden');
    });
  });
  
  // Customer Details Search functionality
  const customerSearchForm = document.getElementById('customerSearchForm');
  const customerSearchInput = document.getElementById('customerSearchInput');
  const customerSearchLoading = document.getElementById('customerSearchLoading');
  const customerSearchResults = document.getElementById('customerSearchResults');
  const customerSearchError = document.getElementById('customerSearchError');
  const customerSearchErrorMessage = document.getElementById('customerSearchErrorMessage');
  
  if (customerSearchForm) {
    customerSearchForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const searchValue = customerSearchInput.value.trim();
      if (!searchValue) {
        showError('Please enter a Customer ID or KGID');
        return;
      }
      
      // Reset previous states
      hideAllSearchStates();
      customerSearchLoading.classList.remove('hidden');
      
      try {
        // Call the fetch_customer_details API
        const response = await fetch(`/finance/api/fetch_customer_details?customer_id=${encodeURIComponent(searchValue)}`);
        const data = await response.json();
        
        if (data.status === 'success') {
          displayCustomerDetails(data);
        } else {
          showError(data.message || 'Customer not found');
        }
      } catch (error) {
        console.error('Error fetching customer details:', error);
        showError('Network error. Please try again.');
      } finally {
        customerSearchLoading.classList.add('hidden');
      }
    });
  }
  
  function hideAllSearchStates() {
    customerSearchLoading.classList.add('hidden');
    customerSearchResults.classList.add('hidden');
    customerSearchError.classList.add('hidden');
  }
  
  function showError(message) {
    hideAllSearchStates();
    customerSearchErrorMessage.textContent = message;
    customerSearchError.classList.remove('hidden');
  }
  
  function displayCustomerDetails(data) {
    hideAllSearchStates();
    
    const customerInfo = data.customer; // CHANGED from data.customer_info
    const loanSummary = data.summary;   // CHANGED from data.loan_summary
    const loans = data.loans || [];
    const transactions = data.transactions || [];
    
    // Populate basic customer info with photos on the right side
    const basicInfoContainer = document.getElementById('customerBasicInfo');
    basicInfoContainer.innerHTML = `
      <div class="col-span-1 md:col-span-2 lg:col-span-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-1"
            <p class="text-sm text-gray-600">Name</p>
            <p class="font-medium">${customerInfo.name || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Customer ID</p>
            <p class="font-medium">${customerInfo.customer_id || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">KGID</p>
            <p class="font-medium">${customerInfo.kgid || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Phone</p>
            <p class="font-medium">${customerInfo.phone || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Email</p>
            <p class="font-medium">${customerInfo.email || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Current Balance</p>
            <p class="font-medium text-green-600">₹${(customerInfo.balance || 0).toLocaleString()}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Organization</p>
            <p class="font-medium">${customerInfo.organization_name || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Address</p>
            <p class="font-medium">${customerInfo.address || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Aadhar No</p>
            <p class="font-medium">${customerInfo.aadhar_no || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">PAN No</p>
            <p class="font-medium">${customerInfo.pan_no || 'N/A'}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Salary</p>
            <p class="font-medium">₹${(customerInfo.salary || 0).toLocaleString()}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-600">Account Status</p>
            <p class="font-medium">
              <span class="px-2 py-1 rounded-full text-xs ${customerInfo.status === 'approved' ? 'bg-green-100 text-green-800' : customerInfo.status === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                ${(customerInfo.status || 'pending').toUpperCase()}
              </span>
            </p>
          </div>
        </div>
      </div>
      
      <!-- Customer Photos on the Right Side -->
      <div class="col-span-1 lg:col-span-1 flex flex-col items-center space-y-4">
        <!-- Profile Photo -->
        <div class="text-center">
          <h4 class="font-medium text-gray-700 mb-2">Profile Photo</h4>
          ${customerInfo.photo_url ? `
            <img src="${customerInfo.photo_url}" 
                 alt="Customer Photo" 
                 class="w-32 h-32 object-cover rounded-lg border-2 border-gray-300 shadow-md cursor-pointer hover:shadow-lg transition-shadow"
                 onclick="showImageModal('${customerInfo.photo_url}', 'Customer Photo')" />
          ` : `
            <div class="w-32 h-32 bg-gray-200 rounded-lg border-2 border-gray-300 flex items-center justify-center">
              <span class="text-gray-500 text-sm text-center">No Photo<br>Available</span>
            </div>
          `}
        </div>
        
        <!-- Customer Signature -->
        <div class="text-center">
          <h4 class="font-medium text-gray-700 mb-2">Signature</h4>
          ${customerInfo.signature_url ? `
            <img src="${customerInfo.signature_url}" 
                 alt="Customer Signature" 
                 class="w-32 h-20 object-contain rounded-lg border-2 border-gray-300 shadow-md cursor-pointer hover:shadow-lg transition-shadow bg-white"
                 onclick="showImageModal('${customerInfo.signature_url}', 'Customer Signature')" />
          ` : `
            <div class="w-32 h-20 bg-gray-200 rounded-lg border-2 border-gray-300 flex items-center justify-center">
              <span class="text-gray-500 text-xs text-center">No Signature<br>Available</span>
            </div>
          `}
        </div>
      </div>
    `;
    
    // Remove the separate photos section creation since it's now integrated
    
    // Populate loan summary
    const loanSummaryContainer = document.getElementById('loanSummaryInfo');
    loanSummaryContainer.innerHTML = `
      <div class="text-center p-4 bg-blue-50 rounded-lg">
        <p class="text-2xl font-bold text-blue-600">${loanSummary.total_loans}</p>
        <p class="text-sm text-gray-600">Total Loans</p>
      </div>
      <div class="text-center p-4 bg-green-50 rounded-lg">
        <p class="text-2xl font-bold text-green-600">${loanSummary.active_loans}</p>
        <p class="text-sm text-gray-600">Active Loans</p>
      </div>
      <div class="text-center p-4 bg-yellow-50 rounded-lg">
        <p class="text-2xl font-bold text-yellow-600">${loanSummary.pending_loans}</p>
        <p class="text-sm text-gray-600">Pending</p>
      </div>
      <div class="text-center p-4 bg-red-50 rounded-lg">
        <p class="text-2xl font-bold text-red-600">₹${(loanSummary.total_outstanding || 0).toLocaleString()}</p>
        <p class="text-sm text-gray-600">Outstanding</p>
      </div>
    `;
    
    // Populate loans table
    const loansTableBody = document.getElementById('loansTableBody');
    if (loans.length === 0) {
      loansTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No loans found</td></tr>';
    } else {
      loansTableBody.innerHTML = loans.map(loan => {
        // Map status to display: "ACTIVE" if approved, "REJECTED" if rejected, else "PENDING"
        let statusLabel = "PENDING";
        let statusClass = "bg-yellow-100 text-yellow-800";
        if (loan.status === 'approved') {
          statusLabel = "ACTIVE";
          statusClass = "bg-green-100 text-green-800";
        } else if (loan.status === 'rejected') {
          statusLabel = "REJECTED";
          statusClass = "bg-red-100 text-red-800";
        }
        return `
          <tr class="border-t">
            <td class="px-4 py-3">${loan.loan_id || 'Pending'}</td>
            <td class="px-4 py-3 capitalize">${loan.loan_type || 'N/A'}</td>
            <td class="px-4 py-3">₹${(loan.loan_amount || 0).toLocaleString()}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
                ${statusLabel}
              </span>
            </td>
            <td class="px-4 py-3">${loan.created_at ? new Date(loan.created_at).toLocaleDateString() : 'N/A'}</td>
            <td class="px-4 py-3">₹${(loan.remaining_balance || 0).toLocaleString()}</td>
            <td class="px-4 py-3">
              <button class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                      onclick="fetchLoanDeepDetails('${loan.id}')">
                Details
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // Populate transactions table
    const transactionsTableBody = document.getElementById('transactionsTableBody');
    if (transactions.length === 0) {
      transactionsTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No transactions found</td></tr>';
    } else {
      transactionsTableBody.innerHTML = transactions.slice(0, 10).map(transaction => {
        const typeClass = transaction.type === 'deposit' ? 'text-green-600' : 'text-red-600';
        
        return `
          <tr class="border-t">
            <td class="px-4 py-3">${transaction.date ? new Date(transaction.date).toLocaleDateString() : 'N/A'}</td>
            <td class="px-4 py-3">
              <span class="capitalize ${typeClass} font-medium">${transaction.type || 'N/A'}</span>
            </td>
            <td class="px-4 py-3">₹${(transaction.amount || 0).toLocaleString()}</td>
            <td class="px-4 py-3">₹${(transaction.balance_after || 0).toLocaleString()}</td>
            <td class="px-4 py-3">${transaction.remarks || transaction.description || 'N/A'}</td>
          </tr>
        `;
      }).join('');
    }
    
    customerSearchResults.classList.remove('hidden');
  }
  
  // Add image modal functionality - Make functions global
  window.showImageModal = function(imageSrc, imageTitle) {
    // Remove existing modal if present
    const existingModal = document.getElementById('imageModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'imageModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
      <div class="relative max-w-4xl max-h-full">
        <div class="bg-white p-4 rounded-lg">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">${imageTitle}</h3>
            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
              &times;
            </button>
          </div>
          <img src="${imageSrc}" 
               alt="${imageTitle}" 
               class="max-w-full max-h-[70vh] object-contain rounded shadow-lg" />
        </div>
      </div>
    `;
    
    // Close modal when clicking outside
    modal.onclick = function(e) {
      if (e.target === modal) {
        closeImageModal();
      }
    };
    
    document.body.appendChild(modal);
  };
  
  window.closeImageModal = function() {
    const modal = document.getElementById('imageModal');
    if (modal) {
      modal.remove();
    }
  };
  
  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeImageModal();
    }
  });
  
  // Show welcome section by default
  sections.forEach(sec => sec.classList.add('hidden'));
  document.getElementById('welcome').classList.remove('hidden');
  
  // Enhance loans table after data load by overriding displayCustomerDetails (wrap original)
  const originalDisplayCustomerDetails = displayCustomerDetails;
  window.displayCustomerDetails = function(data){
    originalDisplayCustomerDetails(data);
    const loansTableBody = document.getElementById('loansTableBody');
    loansTableBody.querySelectorAll('tr').forEach((row, idx) => {
      const loan = data.loans[idx];
      if (!loan) return;
      let cell = document.createElement('td');
      cell.className = "px-4 py-3";
      cell.innerHTML = `
        <button class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                onclick="fetchLoanDeepDetails('${loan.id}')">
          Details
        </button>
      `;
      row.appendChild(cell);
    });
  };

  // Hide details panel when Hide button is clicked
  document.getElementById('hideLoanDetailsBtn').onclick = function() {
    document.getElementById('selectedLoanDetails').classList.add('hidden');
  };

  // NEW: Fetch single loan deep details
  window.fetchLoanDeepDetails = async function(loanUuid){
    // Show loading indicator in the details panel
    const detailsPanel = document.getElementById('selectedLoanDetails');
    const detailsContent = document.getElementById('selectedLoanContent');
    detailsContent.innerHTML = `<div class="flex items-center py-8 justify-center text-blue-600">
      <svg class="animate-spin h-6 w-6 mr-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
      <span>Loading loan details...</span>
    </div>`;
    detailsPanel.classList.remove('hidden');
    try {
      const res = await fetch(`/finance/${loanUuid}`);
      const json = await res.json();
      if(json.status !== 'success'){ throw new Error('Fetch failed'); }
      renderSelectedLoan(json.loan, json.customer, json.sureties, json.records);
    } catch(e){
      console.error(e);
      detailsContent.innerHTML = `<p class="text-red-600">Failed to load loan details.</p>`;
      detailsPanel.classList.remove('hidden');
    }
  };

  function computeMetrics(loan, records){
    const principal = Number(loan.loan_amount||0);
    const rateAnnual = Number(loan.interest_rate||0);
    const term = Number(loan.loan_term_months||0);
    const r = rateAnnual ? rateAnnual/1200 : 0;
    let emi = 0;
    if (r && term){
      emi = principal * r * Math.pow(1+r, term) / (Math.pow(1+r, term)-1);
    } else if (term){
      emi = principal/term;
    }
    emi = Math.round(emi*100)/100;
    let totalRepaid = 0;
    records.forEach(rp => totalRepaid += Number(rp.repayment_amount||0));
    const outstanding = Math.max(principal - totalRepaid, 0);
    const scheduledTotal = Math.round(emi*term*100)/100;
    const scheduledInterest = Math.round((scheduledTotal - principal)*100)/100;
    return {principal, rateAnnual, term, emi, totalRepaid: Math.round(totalRepaid*100)/100, outstanding: Math.round(outstanding*100)/100, scheduledInterest, scheduledTotal};
  }

  function renderSelectedLoan(loan, customer, sureties, records){
    records = records || [];
    const metrics = computeMetrics(loan, records);

    // Format loan tenure as "X months (Y years Z months)" if > 12 months
    let tenureStr = '';
    const months = Number(loan.loan_term_months || 0);
    if (months >= 12) {
      const years = Math.floor(months / 12);
      const remMonths = months % 12;
      tenureStr = `${months} months (${years} year${years > 1 ? 's' : ''}${remMonths ? ' ' + remMonths + ' month' + (remMonths > 1 ? 's' : '') : ''})`;
    } else {
      tenureStr = `${months} month${months === 1 ? '' : 's'}`;
    }

    // Calculate months left
    let monthsLeft = '';
    if (loan.loan_term_months && metrics) {
      const elapsed = metrics.elapsed_months !== undefined ? metrics.elapsed_months : 0;
      const left = Math.max(Number(loan.loan_term_months) - Number(elapsed), 0);
      monthsLeft = `${left} month${left === 1 ? '' : 's'} left`;
    }

    const container = document.getElementById('selectedLoanContent');
    container.innerHTML = `
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="p-3 bg-blue-50 rounded"><p class="text-xs text-gray-500">Principal</p><p class="font-semibold">₹${metrics.principal.toLocaleString()}</p></div>
        <div class="p-3 bg-green-50 rounded"><p class="text-xs text-gray-500">Total Repaid</p><p class="font-semibold text-green-700">₹${metrics.totalRepaid.toLocaleString()}</p></div>
        <div class="p-3 bg-yellow-50 rounded"><p class="text-xs text-gray-500">Outstanding</p><p class="font-semibold text-yellow-700">₹${metrics.outstanding.toLocaleString()}</p></div>
        <div class="p-3 bg-purple-50 rounded"><p class="text-xs text-gray-500">Interest Rate</p><p class="font-semibold">${metrics.rateAnnual}%</p></div>
        <div class="p-3 bg-indigo-50 rounded"><p class="text-xs text-gray-500">EMI (Est.)</p><p class="font-semibold">₹${metrics.emi.toLocaleString()}</p></div>
        <div class="p-3 bg-teal-50 rounded"><p class="text-xs text-gray-500">Scheduled Interest</p><p class="font-semibold text-teal-700">₹${metrics.scheduledInterest.toLocaleString()}</p></div>
        <div class="p-3 bg-orange-50 rounded"><p class="text-xs text-gray-500">Loan Tenure</p><p class="font-semibold">${tenureStr}</p></div>
        <div class="p-3 bg-lime-50 rounded"><p class="text-xs text-gray-500">Months Left</p><p class="font-semibold">${monthsLeft}</p></div>
      </div>
      <h4 class="font-semibold mb-2">Repayment History</h4>
      ${records.length===0 ? '<p class="text-sm text-gray-500 mb-4">No repayment records.</p>' :
        `<div class="overflow-x-auto mb-4">
          <table class="min-w-full text-xs">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-2 py-2 text-left">#</th>
                <th class="px-2 py-2 text-left">Date</th>
                <th class="px-2 py-2 text-left">Amount</th>
                <th class="px-2 py-2 text-left">Outstanding After</th>
                <th class="px-2 py-2 text-left">Status</th>
              </tr>
            </thead>
            <tbody>
              ${records.map((r,i)=>`
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-2 py-1">${i+1}</td>
                  <td class="px-2 py-1">${r.repayment_date || '—'}</td>
                  <td class="px-2 py-1">₹${Number(r.repayment_amount||0).toLocaleString()}</td>
                  <td class="px-2 py-1">₹${Number(r.outstanding_balance!=null ? r.outstanding_balance : metrics.principal - metrics.totalRepaid).toLocaleString()}</td>
                  <td class="px-2 py-1">
                    <span class="px-2 py-0.5 rounded text-[10px] ${r.status==='completed'?'bg-green-100 text-green-700':r.status==='overdue'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700'}">
                      ${(r.status||'active').toUpperCase()}
                    </span>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`}
      <div class="text-xs text-gray-500">Computed values are indicative (EMI & interest schedule).</div>
    `;
    document.getElementById('selectedLoanDetails').classList.remove('hidden');
  }

  // Expenses fetcher (improved JSON handling and clearer errors)
  // Keeps data in memory (window.expensesRaw) and renders via renderExpenses()
  async function loadExpenses() {
    const loading = document.getElementById('expensesLoading');
    const err = document.getElementById('expensesError');
    const container = document.getElementById('expensesContainer');
    const tbody = document.getElementById('expensesTableBody');
    if (!loading || !err || !container || !tbody) return;

    err.classList.add('hidden');
    container.classList.add('hidden');
    tbody.innerHTML = '';
    loading.classList.remove('hidden');

    try {
      const res = await fetch('/api/check-expenses', {
        method: 'GET',
        credentials: 'include',
        headers: { 'Accept': 'application/json,text/plain,*/*' }
      });

      const text = await res.text();
      // keep full response in console for debugging
      console.debug('[loadExpenses] raw response:', { status: res.status, text });

      let parsed = null;
      try {
        parsed = JSON.parse(text);
      } catch (parseErr) {
        // Try to handle when backend returns a bare JSON array (no envelope)
        const trimmed = (text || '').trim();
        if (trimmed.startsWith('[')) {
          try {
            const arr = JSON.parse(trimmed);
            parsed = { expenses: arr };
            console.debug('[loadExpenses] interpreted raw array as expenses');
          } catch (arrErr) {
            parsed = null;
          }
        } else {
          parsed = null;
        }
      }

      // If HTTP not ok, prefer JSON message if present, else show snippet of raw text
      if (!res.ok) {
        const serverMsg = parsed && parsed.message ? parsed.message : (text ? text.substring(0, 500) : res.statusText);
        throw new Error(`HTTP ${res.status}: ${serverMsg}`);
      }

      if (!parsed) {
        // non-JSON or malformed JSON — surface a short snippet so backend can be diagnosed
        const snippet = (text || '').substring(0, 800);
        throw new Error('Invalid JSON response from server. Response snippet: ' + snippet);
      }

      // Accept both { expenses: [...] } and { data: [...] } shapes if you use PostgREST directly
      let expenses = [];
      if (Array.isArray(parsed.expenses)) {
        expenses = parsed.expenses;
      } else if (Array.isArray(parsed.data)) {
        expenses = parsed.data;
      } else if (Array.isArray(parsed)) {
        expenses = parsed; // parsed was an array
      } else {
        throw new Error('Unexpected JSON structure. Expected array in "expenses" or "data" or top-level array.');
      }

  // store raw data for client-side filtering and rendering
  window.expensesRaw = expenses;
  // populate month select with unique months
  try { populateMonthSelect(expenses); } catch(e){}
  renderExpenses(expenses);
  container.classList.remove('hidden');
    } catch (e) {
      console.error('[loadExpenses] error:', e);
      // show friendly message + short detail for debugging
      err.textContent = 'Failed to load expenses: ' + (e.message || 'Unknown error');
      err.classList.remove('hidden');
    } finally {
      loading.classList.add('hidden');
    }
  }

  // Also update the expenses table click handler to load immediately
  const expensesNavBtn = document.querySelector('.admin-nav-btn[data-target="expenses"]');
  if (expensesNavBtn) {
    expensesNavBtn.addEventListener('click', () => {
      loadExpenses().catch(console.error);
    });
  }

  // Render a set of expenses into the table (build headers from keys)
  function renderExpenses(expenses) {
    const tbody = document.getElementById('expensesTableBody');
    const thead = document.getElementById('expensesTableHead');
    if (!tbody || !thead) return;

    if (!expenses || expenses.length === 0) {
      const cols = (thead && thead.querySelectorAll('th').length) || 5;
      tbody.innerHTML = `<tr><td colspan="${cols}" class="px-4 py-6 text-center text-gray-500">No expenses found</td></tr>`;
      document.getElementById('expensesCount').textContent = '0';
      document.getElementById('expensesTotal').textContent = '0';
      return;
    }

    const first = expenses[0];
    const keys = Object.keys(first);
    thead.innerHTML = '<tr>' + keys.map(k => `<th class="px-4 py-2 text-left">${k}</th>`).join('') + '</tr>';

    tbody.innerHTML = expenses.map(exp => {
      const cells = keys.map(k => {
        const val = exp[k];
        if (typeof val === 'number') return `<td class="px-4 py-2">${formatCurrency(val)}</td>`;
        if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) return `<td class="px-4 py-2">${new Date(val).toLocaleDateString()}</td>`;
        if (val === null || val === undefined) return `<td class="px-4 py-2"></td>`;
        return `<td class="px-4 py-2">${String(val)}</td>`;
      }).join('');
      return `<tr class="border-t hover:bg-gray-50">${cells}</tr>`;
    }).join('');

    // update counters
    document.getElementById('expensesCount').textContent = String(expenses.length);
    const total = expenses.reduce((s, e) => {
      const v = Number(e.amount || e.value || 0);
      return s + (isNaN(v) ? 0 : v);
    }, 0);
    document.getElementById('expensesTotal').textContent = total.toLocaleString();
  }

  function formatCurrency(n){ return Number(n||0).toLocaleString(); }

  // Apply filters from the UI to window.expensesRaw and re-render
  function applyFilters() {
    const raw = window.expensesRaw || [];
    const q = (document.getElementById('expenseSearch')||{}).value.trim().toLowerCase();
    const from = (document.getElementById('expenseDateFrom')||{}).value;
    const to = (document.getElementById('expenseDateTo')||{}).value;
    const month = (document.getElementById('expenseMonth')||{}).value;
    const min = parseFloat((document.getElementById('amountMin')||{}).value || '');
    const max = parseFloat((document.getElementById('amountMax')||{}).value || '');

    const filtered = raw.filter(e => {
      // search by id or name
      if (q) {
        const idstr = String(e.id||e.ID||'').toLowerCase();
        const namestr = String(e.name||e.expense_name||'').toLowerCase();
        if (!idstr.includes(q) && !namestr.includes(q) && !JSON.stringify(e).toLowerCase().includes(q)) return false;
      }
      // date range
      const d = e.date || e.created_at || null;
      if (from && d && new Date(d) < new Date(from)) return false;
      if (to && d && new Date(d) > new Date(to)) return false;
      // month filter in YYYY-MM format
      if (month && d) {
        const m = d.slice(0,7);
        if (m !== month) return false;
      }
      // amount range
      const amt = Number(e.amount || e.value || 0);
      if (!isNaN(min) && min !== '' && amt < min) return false;
      if (!isNaN(max) && max !== '' && amt > max) return false;
      return true;
    });

    renderExpenses(filtered);
  }

  function populateMonthSelect(expenses){
    const sel = document.getElementById('expenseMonth');
    if (!sel) return;
    const months = new Set();
    expenses.forEach(e => {
      const d = e.date || e.created_at || null;
      if (d && typeof d === 'string' && d.length>=7) months.add(d.slice(0,7));
    });
    const arr = Array.from(months).sort((a,b)=>b.localeCompare(a));
    sel.innerHTML = '<option value="">All months</option>' + arr.map(m=>`<option value="${m}">${m}</option>`).join('');
  }

  // Wire filter buttons
  document.getElementById('applyFiltersBtn')?.addEventListener('click', applyFilters);
  document.getElementById('clearFiltersBtn')?.addEventListener('click', ()=>{
    ['expenseSearch','expenseDateFrom','expenseDateTo','amountMin','amountMax','expenseMonth'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    renderExpenses(window.expensesRaw || []);
  });
  document.getElementById('refreshExpensesBtn')?.addEventListener('click', ()=>{ loadExpenses().catch(console.error); });

  // Admin Civil Score floating button wiring (keeps parity with staff dashboard)
  try {
    const adminCivilBtn = document.getElementById('adminCivilBtn');
    const adminCivilBox = document.getElementById('adminCivilBox');
    const closeAdminCivil = document.getElementById('closeAdminCivil');
    const adminCheckCivil = document.getElementById('adminCheckCivil');
    const adminCivilInput = document.getElementById('adminCivilInput');
    const adminCivilResult = document.getElementById('adminCivilResult');

    if (adminCivilBtn && adminCivilBox) {
      if (!adminCivilBtn.dataset.wired) {
        adminCivilBtn.addEventListener('click', () => {
          adminCivilBox.classList.toggle('hidden');
          adminCivilBox.classList.toggle('show');
        });
        adminCivilBtn.dataset.wired = '1';
      }
    }
    if (closeAdminCivil && adminCivilBox && !closeAdminCivil.dataset.wired) {
      closeAdminCivil.addEventListener('click', () => {
        adminCivilBox.classList.add('hidden');
        adminCivilBox.classList.remove('show');
      });
      closeAdminCivil.dataset.wired = '1';
    }

    if (adminCheckCivil && adminCivilInput && adminCivilResult) {
      if (!adminCheckCivil.dataset.wired) {
        adminCheckCivil.addEventListener('click', async () => {
          const val = adminCivilInput.value.trim();
          adminCivilResult.textContent = '';
          if (!val) {
            adminCivilResult.textContent = "Please enter Customer ID or KGID.";
            adminCivilResult.className = "mt-3 text-center text-red-600";
            return;
          }
          adminCivilResult.textContent = "Checking...";
          adminCivilResult.className = "mt-3 text-center text-blue-700";
          try {
            const res = await fetch(`/api/check-civil-score?customer_id=${encodeURIComponent(val)}`);
            const data = await res.json();
            if (res.ok && data.status === 'success') {
              const overall = data.score || data.score === 0 ? data.score : 'Unknown';
              adminCivilResult.textContent = `Civil Score for ${val}: ${overall}`;
              adminCivilResult.className = "mt-3 text-center text-green-700 font-bold";
              if (Array.isArray(data.details) && data.details.length > 0) {
                const first = data.details[0];
                const detailsText = `${first.loan_id || ''}: ${first.score || first.message || ''}`;
                const detailsNode = document.createElement('div');
                detailsNode.className = 'text-sm mt-2 text-gray-700 admin-civil-details';
                detailsNode.textContent = detailsText;
                const existing = adminCivilResult.nextElementSibling;
                if (existing && existing.classList && existing.classList.contains('admin-civil-details')) existing.remove();
                adminCivilResult.insertAdjacentElement('afterend', detailsNode);
              }
            } else {
              adminCivilResult.textContent = data.message || 'Not found.';
              adminCivilResult.className = "mt-3 text-center text-red-600";
            }
          } catch (e) {
            adminCivilResult.textContent = "Network error.";
            adminCivilResult.className = "mt-3 text-center text-red-600";
          }
        });
        adminCheckCivil.dataset.wired = '1';
      }
    }
  } catch (e) {
    // ignore errors silently
  }
});
// Admin Queries client logic
document.addEventListener('DOMContentLoaded', () => {
  const queriesNavBtn = document.createElement('button');
  // attempt to wire if there is a nav area (non-destructive)
  try {
    const nav = document.querySelector('aside nav');
    if (nav && !nav.querySelector('[data-target="adminQueries"]')) {
      const btn = document.createElement('button');
      btn.className = 'admin-nav-btn w-full text-left px-4 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all';
      btn.setAttribute('data-target','adminQueries');
      btn.textContent = '📬 Queries';
      nav.appendChild(btn);
      btn.addEventListener('click', () => {
        // reveal queries section and load
        document.querySelectorAll('.admin-section').forEach(s=>s.classList.add('hidden'));
        document.getElementById('adminQueries').classList.remove('hidden');
        loadAdminQueries();
      });
    }
  } catch(e){/* ignore */}

  async function loadAdminQueries(){
    const tbody = document.getElementById('adminQueriesTbody');
    const msg = document.getElementById('adminQueriesMsg');
    if (!tbody) return;
    msg.textContent = '';
    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center">Loading...</td></tr>';
    try {
      const res = await fetch('/api/queries');
      const payload = await res.json().catch(()=>null);
      if (!res.ok || !payload || payload.status !== 'success') {
        const err = payload && payload.message ? payload.message : 'Failed to load queries';
        msg.textContent = err;
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center text-red-600">'+err+'</td></tr>';
        return;
      }
      renderAdminQueries(payload.data || []);
    } catch (err) {
      msg.textContent = 'Network error';
      tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center text-red-600">Network error</td></tr>';
    }
  }

  function renderAdminQueries(list){
    const tbody = document.getElementById('adminQueriesTbody');
    if (!tbody) return;
    if (!Array.isArray(list) || list.length === 0){
      tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">No queries found</td></tr>';
      return;
    }
    tbody.innerHTML = list.map((q, idx) => {
      return `
        <tr class="border-t hover:bg-gray-50">
          <td class="px-4 py-3">${idx+1}</td>
          <td class="px-4 py-3">${escapeHtml(q.name||'')}</td>
          <td class="px-4 py-3">${escapeHtml(q.email||'')}<br>${escapeHtml(q.phone||'')}</td>
          <td class="px-4 py-3">${escapeHtml(q.customer_id || q.kgid || '')}</td>
          <td class="px-4 py-3">${escapeHtml(q.description||'')}</td>
          <td class="px-4 py-3">${escapeHtml(q.status||'new')}</td>
          <td class="px-4 py-3">
            ${q.status === 'solved' ? '<span class="text-sm text-green-700">Solved</span>' : `<button class="mark-solved-btn px-3 py-1 text-xs bg-green-600 text-white rounded" data-id="${q.id}">Mark Solved</button>`}
          </td>
        </tr>
      `;
    }).join('');

    // attach handlers
    document.querySelectorAll('.mark-solved-btn').forEach(btn => {
      if (btn.dataset.wired) return;
      btn.dataset.wired = '1';
      btn.addEventListener('click', async () => {
        const qid = btn.dataset.id;
        btn.disabled = true;
        try {
          const res = await fetch(`/api/queries/${qid}/mark-solved`, { method: 'POST' });
          const data = await res.json().catch(()=>null);
          if (res.ok && data && data.status === 'success') {
            btn.parentElement.innerHTML = '<span class="text-sm text-green-700">Solved</span>';
          } else {
            btn.disabled = false;
            alert((data && data.message) || 'Failed to mark solved');
          }
        } catch (e) {
          btn.disabled = false;
          alert('Network error');
        }
      });
    });
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

  // Auto-load Queries when nav clicked (if nav button exists)
  const adminQueriesNav = document.querySelector('.admin-nav-btn[data-target="adminQueries"]');
  if (adminQueriesNav) {
    adminQueriesNav.addEventListener('click', () => loadAdminQueries());
  }
});
</script>
{% endblock %}